{% extends "base.html" %}
{% load static tailwind_tags %}

{% block title %}搜索 - {{ block.super }}{% endblock %}

{% block content %}
<div class="min-h-[70vh] flex flex-col items-center justify-center relative overflow-hidden">
    <!-- Background Decoration -->
    <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-primary/10 rounded-full blur-3xl -z-10 animate-pulse"></div>
    <div class="absolute bottom-1/4 right-1/4 w-80 h-80 bg-secondary/10 rounded-full blur-3xl -z-10 animate-pulse delay-700"></div>

    <div class="w-full max-w-2xl px-4 z-10" x-data="searchComponent()">
        <h1 class="text-4xl md:text-5xl font-bold text-center mb-12 text-primary animate-fade-in-up">
            探索 {{ config.SITE_NAME|default:"Rosetta" }}
        </h1>
        
        <p class="text-center text-base-content/60 mb-8 animate-fade-in-up delay-100">
            搜索文章、标签、分类或用户...
        </p>

        <!-- Search Input Container -->
        <div class="relative w-full group animate-fade-in-up delay-200" @click.away="showSuggestions = false">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none transition-colors group-focus-within:text-primary">
                <span class="material-symbols-outlined text-2xl">search</span>
            </div>
            
            <input 
                type="text" 
                x-model="query"
                @input.debounce.300ms="fetchSuggestions"
                @focus="showSuggestions = true"
                @keydown.enter="search"
                class="input input-lg w-full pl-12 pr-4 rounded-2xl shadow-lg border-2 border-base-200 focus:border-primary focus:outline-none transition-all duration-300 bg-base-100/80 backdrop-blur-md"
                placeholder="输入关键词..."
                autofocus
            >
            
            <div class="absolute inset-y-0 right-0 pr-4 flex items-center">
                <span x-show="loading" class="loading loading-spinner loading-sm text-primary"></span>
            </div>

            <!-- Suggestions Dropdown -->
            <div 
                x-show="showSuggestions && suggestions.length > 0"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 translate-y-2"
                x-transition:enter-end="opacity-100 translate-y-0"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100 translate-y-0"
                x-transition:leave-end="opacity-0 translate-y-2"
                class="absolute w-full mt-2 bg-base-100 rounded-xl shadow-xl border border-base-200 overflow-hidden z-50"
                style="display: none;"
            >
                <ul class="py-2">
                    <template x-for="(item, index) in suggestions" :key="index">
                        <li>
                            <a :href="item.url" class="flex items-center justify-between px-4 py-3 hover:bg-base-200 transition-colors group">
                                <div class="flex items-center gap-3">
                                    <span class="material-symbols-outlined text-base-content/50 group-hover:text-primary transition-colors" x-text="getIcon(item.type)"></span>
                                    <span x-html="highlightMatch(item.text)"></span>
                                </div>
                                <span class="badge badge-sm badge-ghost" x-text="item.type"></span>
                            </a>
                        </li>
                    </template>
                </ul>
            </div>
        </div>

        <!-- Popular Tags -->
        <div class="mt-12 text-center animate-fade-in-up delay-300">
            <p class="text-sm font-medium text-base-content/50 mb-4">热门标签</p>
            <div class="flex flex-wrap justify-center gap-2">
                {% for tag in sidebar_tags|slice:":8" %}
                <a href="{% url 'search' %}?q={{ tag.name }}&type=tag" class="btn btn-sm btn-outline rounded-full hover:btn-primary transition-all duration-300 transform hover:scale-105">
                    # {{ tag.name }}
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
function searchComponent() {
    return {
        query: '',
        suggestions: [],
        showSuggestions: false,
        loading: false,

        fetchSuggestions() {
            if (this.query.length < 1) {
                this.suggestions = [];
                return;
            }
            
            this.loading = true;
            fetch(`{% url 'search' %}?type=suggest&q=${encodeURIComponent(this.query)}`)
                .then(response => response.json())
                .then(data => {
                    this.suggestions = data.results;
                    this.loading = false;
                    this.showSuggestions = true;
                })
                .catch(() => {
                    this.loading = false;
                });
        },

        search() {
            if (this.query.trim()) {
                window.location.href = `{% url 'search' %}?q=${encodeURIComponent(this.query)}`;
            }
        },

        getIcon(type) {
            const icons = {
                '文章': 'article',
                '标签': 'tag',
                '分类': 'category',
                '用户': 'person'
            };
            return icons[type] || 'search';
        },

        highlightMatch(text) {
            if (!this.query) return text;
            const regex = new RegExp(`(${this.query})`, 'gi');
            return text.replace(regex, '<span class="text-primary font-bold">$1</span>');
        }
    }
}
</script>

<style>
    .animate-fade-in-up {
        animation: fadeInUp 0.8s ease-out forwards;
        opacity: 0;
        transform: translateY(20px);
    }
    
    .delay-100 { animation-delay: 0.1s; }
    .delay-200 { animation-delay: 0.2s; }
    .delay-300 { animation-delay: 0.3s; }
    .delay-700 { animation-delay: 0.7s; }

    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}
