{% extends 'base.html' %}
{% load static capture_tags %}

{% block content %}
<div class="min-h-[80vh] px-4 py-16 md:py-24 bg-base-100 relative overflow-hidden"
     x-data="{ 
         viewMode: localStorage.getItem('blogViewMode') || 'grid',
         toggleView(mode) {
             this.viewMode = mode;
             localStorage.setItem('blogViewMode', mode);
         }
     }">
    
    <!-- Background Decoration -->
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none select-none">
        <div class="absolute top-[-10%] left-[-5%] w-96 h-96 bg-primary/5 rounded-full blur-3xl opacity-50"></div>
        <div class="absolute bottom-[-10%] right-[-5%] w-96 h-96 bg-secondary/5 rounded-full blur-3xl opacity-50"></div>
    </div>

    <div class="max-w-7xl mx-auto relative z-10">

        <div class="flex flex-col md:flex-row justify-between items-end mb-16 gap-6">
            <div class="space-y-4">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-base-200/50 border border-base-content/5 text-xs font-medium text-base-content/60 backdrop-blur-sm">
                    <span class="w-2 h-2 rounded-full bg-primary animate-pulse"></span>
                    <span>知识库</span>
                </div>
                
                <h1 class="text-4xl md:text-5xl font-bold font-heading tracking-tight">
                    全部文章
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary">.</span>
                </h1>
                
                <p class="text-lg text-base-content/60 max-w-xl">
                    共收录 <span class="font-bold text-base-content">{{ paginator.count|default:posts.count }}</span> 篇文章
                </p>
            </div>
            
            <div class="hidden md:flex items-center gap-1 p-1 bg-base-200/50 rounded-xl backdrop-blur-sm border border-base-content/5">
                <button class="btn btn-sm btn-ghost btn-square rounded-lg transition-all duration-300" 
                        :class="viewMode === 'grid' ? 'bg-base-100 shadow-sm text-primary scale-100' : 'opacity-60 hover:opacity-100 scale-90 hover:scale-100'" 
                        @click="toggleView('grid')"
                        title="网格视图">
                    <span class="material-symbols-outlined text-lg">grid_view</span>
                </button>
                <button class="btn btn-sm btn-ghost btn-square rounded-lg transition-all duration-300" 
                        :class="viewMode === 'list' ? 'bg-base-100 shadow-sm text-primary scale-100' : 'opacity-60 hover:opacity-100 scale-90 hover:scale-100'" 
                        @click="toggleView('list')"
                        title="列表视图">
                    <span class="material-symbols-outlined text-lg">view_list</span>
                </button>
            </div>
        </div>

        <!-- Post Grid -->
        <div class="grid gap-6 transition-all duration-500 ease-in-out" 
             :class="viewMode === 'grid' ? 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3' : 'grid-cols-1'">
            {% for post in posts %}
            
            {% captureas card_content %}
            <div class="group h-full bg-base-100 rounded-3xl overflow-hidden transition-all duration-300 border border-base-content/5 hover:border-primary/20 hover:shadow-2xl hover:shadow-primary/5 hover:-translate-y-1"
                 :class="viewMode === 'list' ? 'flex flex-col sm:flex-row' : 'flex flex-col'">
                <!-- Image Wrapper -->
                <div class="relative overflow-hidden transition-all duration-300"
                     :class="viewMode === 'grid' ? 'aspect-[16/10] w-full' : 'aspect-[16/10] w-full sm:aspect-auto sm:w-1/3 sm:min-h-[14rem] sm:self-stretch'">
                    {% if post.cover_image %}
                    <img src="{{ post.cover_image.url }}" 
                         alt="{{ post.title }}" 
                         class="object-cover w-full h-full transform transition-transform duration-700 group-hover:scale-105"
                         {% if forloop.counter > 6 %}loading="lazy"{% else %}loading="eager"{% endif %} />
                    <div class="absolute inset-0 transition-all duration-300 group-hover:bg-black/10 group-hover:backdrop-blur-[2px]"></div>
                    {% else %}
                    <figure class="pattern-placeholder w-full h-full transform transition-all duration-700 group-hover:scale-105 group-hover:brightness-110"
                            data-seed="{{ post.title }}"
                            x-init="initGeoPattern($el, '{{ post.title|escapejs }}')"
                            x-effect="initGeoPattern($el, '{{ post.title|escapejs }}')">
                        <div class="absolute inset-0 flex items-center justify-center p-6 bg-black/10 backdrop-blur-[0px] group-hover:backdrop-blur-[2px] transition-all duration-500">
                            <span class="text-white font-bold text-xl leading-tight text-center drop-shadow-md line-clamp-2 opacity-90 group-hover:opacity-100">
                                {{ post.title }}
                            </span>
                        </div>
                    </figure>
                    {% endif %}
                    
                    <!-- Overlay Gradient -->
                    <div class="absolute inset-0 bg-gradient-to-t from-base-100 via-transparent to-transparent opacity-60"></div>
                    
                    <!-- Category Badge -->
                    {% if post.category %}
                    <a href="{% url 'post_by_category' post.category.slug %}" 
                       class="absolute top-4 left-4 z-20 badge border-none bg-base-100/90 backdrop-blur-md text-base-content shadow-sm hover:bg-primary hover:text-white transition-colors duration-300 gap-1 pl-1.5 pr-3 h-7">
                        {% if post.category.icon %}
                        <span class="material-symbols-outlined text-[14px]">{{ post.category.icon }}</span>
                        {% endif %}
                        {{ post.category.name }}
                    </a>
                    {% endif %}

                    <!-- Pin Badge -->
                    {% if post.is_pinned %}
                    <div class="absolute top-4 right-4 z-20 badge badge-accent shadow-lg gap-1 border-none text-white">
                        <span class="material-symbols-outlined text-[14px] -rotate-45">push_pin</span>
                        置顶
                    </div>
                    {% endif %}
                </div>
                
                <div class="card-body p-6 flex-1 relative">
                    <!-- Title -->
                    <h2 class="card-title text-xl font-bold font-heading leading-tight mb-3 group-hover:text-primary transition-colors duration-300">
                        <a href="{% url 'post_detail' post.slug %}" class="line-clamp-2 before:absolute before:inset-0 z-10">
                            {{ post.title }}
                        </a>
                    </h2>
                    
                    <!-- Excerpt -->
                    <p class="text-base-content/60 text-sm line-clamp-2 mb-6 leading-relaxed">
                        {{ post.content|striptags|truncatechars:100 }}
                    </p>
                    
                    <!-- Meta Footer -->
                    <div class="mt-auto flex items-center justify-between pt-4 border-t border-base-content/5 text-xs font-medium text-base-content/50 relative z-20">
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-1.5" title="发布时间">
                                <span class="material-symbols-outlined text-[16px]">calendar_today</span>
                                <span>{{ post.created_at|date:"Y-m-d" }}</span>
                            </div>
                            <div class="flex items-center gap-1.5" title="阅读量">
                                <span class="material-symbols-outlined text-[16px]">visibility</span>
                                <span>{{ post.views }}</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-2 pl-4 border-l border-base-content/10" title="作者">
                            <div class="avatar">
                                <div class="w-6 h-6 rounded-full ring-1 ring-base-content/10">
                                    <img src="{{ post.author.get_avatar_url }}" alt="{{ post.author.username }}" class="rounded-full object-cover" loading="lazy" />
                                </div>
                            </div>
                            <span>{{ post.author.nickname|default:post.author.username }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endcaptureas %}
            
            <div class="h-full">
                {{ card_content }}
            </div>
            
            {% empty %}
            <div class="col-span-full py-32 text-center">
                <div class="inline-flex flex-col items-center justify-center p-8 rounded-[2rem] bg-base-200/30 border border-dashed border-base-content/10 max-w-md mx-auto">
                    <div class="w-20 h-20 bg-base-100 rounded-2xl flex items-center justify-center mb-6 shadow-sm rotate-3">
                        <span class="material-symbols-outlined text-4xl text-base-content/20">article</span>
                    </div>
                    <h3 class="text-xl font-bold text-base-content/80 mb-2">暂无文章</h3>
                    <p class="text-base-content/50">这里还是一片荒原，等待知识的种子发芽。</p>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if is_paginated %}
        <div class="flex justify-center mt-16">
            <div class="join shadow-sm border border-base-content/5 bg-base-100 rounded-xl p-1">
                {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}" class="join-item btn btn-sm btn-ghost hover:bg-base-200">
                    <span class="material-symbols-outlined text-lg">chevron_left</span>
                    上一页
                </a>
                {% else %}
                <button class="join-item btn btn-sm btn-ghost btn-disabled opacity-30">
                    <span class="material-symbols-outlined text-lg">chevron_left</span>
                    上一页
                </button>
                {% endif %}
                
                <button class="join-item btn btn-sm btn-ghost no-animation font-mono font-normal cursor-default">
                    {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                </button>
                
                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}" class="join-item btn btn-sm btn-ghost hover:bg-base-200">
                    下一页
                    <span class="material-symbols-outlined text-lg">chevron_right</span>
                </a>
                {% else %}
                <button class="join-item btn btn-sm btn-ghost btn-disabled opacity-30">
                    下一页
                    <span class="material-symbols-outlined text-lg">chevron_right</span>
                </button>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}
