{% extends 'base.html' %}
{% load markdown_extras capture_tags static %}

{% block extra_css %}
<!-- 代码高亮样式 (Code Highlighting Styles) -->
<link href="{% static 'theme/css/pygments/' %}{{ config.CODE_HIGHLIGHT_STYLE|default:'default' }}.css" rel="stylesheet">
<!-- KaTeX 数学公式样式 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<style>
    /* 优化代码块样式 (Enhance Code Block Styles) */
    .codehilite {
        margin-bottom: 1.5rem;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.875rem; /* text-sm */
        line-height: 1.5;
    }
    
    /* DaisyUI Mockup Code 适配 */
    .mockup-code {
        min-width: 0; /* 允许在移动端收缩 */
        border-radius: 0.75rem; /* 保持一致的圆角 */
        background-color: #282a36 !important; /* 通用深色背景 */
        color: #f8f8f2 !important; /* 浅色文字 */
    }

    /* 强制重置 pre 的背景和 padding，防止与 Pygments/DaisyUI 冲突 */
    .codehilite pre {
        margin: 0;
        padding: 1.25rem;
        padding-top: 0 !important; /* 避免与 mockup-code 头部 padding 叠加 */
        background: transparent !important;
        color: inherit !important; /* 继承 mockup-code 的浅色文字 */
    }
    
    /* 修复 Shell/Bash 命令提示符对比度 */
    .codehilite .gp { /* Generic.Prompt */
        color: #ff79c6 !important; /* 亮粉色提示符 */
        font-weight: bold;
    }
    
    /* 修复普通文本和未高亮代码的颜色 */
    .codehilite .n, .codehilite .p, .codehilite .w {
        color: inherit; /* 让普通文本继承浅色 */
    }
    
    /* 深色模式适配 (Dark Mode Adaptation) */
    [data-theme='dark'] .codehilite {
        border-color: rgba(255, 255, 255, 0.1);
    }

    /* Mermaid 图表居中 */
    .mermaid {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
        background: transparent !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
        <!-- 主要内容区域 (Main Content) -->
        <article class="lg:col-span-8 prose prose-lg prose-slate max-w-none">
            <!-- 文章头部 (Article Header) -->
            <header class="not-prose mb-12 text-center">
                {% if post.category %}
                <!-- 分类标签 (Category Tag) -->
                <a href="{% url 'post_by_category' post.category.slug %}" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-primary/10 text-primary hover:bg-primary/20 transition-colors mb-6 no-underline">
                    {{ post.category.name }}
                </a>
                {% endif %}
                
                <!-- 文章标题 (Article Title) -->
                <h1 class="text-4xl md:text-5xl font-bold font-heading mb-6 leading-tight text-base-content">{{ post.title }}</h1>
                
                <!-- 文章元数据 (Article Metadata: Author, Date, Views) -->
                <div class="flex flex-wrap items-center justify-center gap-6 text-sm text-base-content/60">
                    <div class="flex items-center gap-2">
                        <div class="avatar">
                            <div class="w-8 h-8 rounded-full ring-2 ring-primary/20">
                                <img src="{{ post.author.get_avatar_url }}" alt="{{ post.author.username }}" class="rounded-full object-cover" />
                            </div>
                        </div>
                        <span class="font-medium text-base-content">{{ post.author.nickname|default:post.author.username }}</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="material-symbols-outlined text-[18px]">calendar_today</span>
                        <time>{{ post.published_at|default:post.created_at|date:"Y年m月d日" }}</time>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="material-symbols-outlined text-[18px]">schedule</span>
                        <span>{{ post.reading_time }} 分钟阅读</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="material-symbols-outlined text-[18px]">visibility</span>
                        <span>{{ post.views }} 阅读</span>
                    </div>
                    
                    {% if user.is_staff or user == post.author %}
                    <!-- 编辑按钮 (Edit Button - Only for Staff/Author) -->
                    <a href="{% url 'administration:post_edit' post.pk %}" class="flex items-center gap-1 text-primary hover:text-primary-focus transition-colors">
                        <span class="material-symbols-outlined text-[18px]">edit</span>
                        编辑
                    </a>
                    {% endif %}
                </div>
            </header>

            <!-- 封面图 (Cover Image) -->
            {% if post.cover_image %}
            <div class="not-prose mb-12 relative group cursor-zoom-in rounded-3xl overflow-hidden shadow-2xl shadow-primary/5" onclick="lightbox.showModal()">
                <img src="{{ post.cover_image.url }}" alt="{{ post.title }}" class="w-full h-auto object-cover max-h-[600px] transition-transform duration-700 group-hover:scale-105" />
                <div class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            </div>
            
            <!-- 灯箱模态框 (Lightbox Modal) -->
            <dialog id="lightbox" class="modal bg-black/90 backdrop-blur-md p-0">
                <div class="modal-box max-w-screen-2xl max-h-screen bg-transparent shadow-none p-4 relative flex items-center justify-center h-full w-full">
                    <form method="dialog">
                        <button class="btn btn-circle btn-ghost btn-lg absolute right-8 top-8 text-white z-50 hover:bg-white/10">
                            <span class="material-symbols-outlined text-3xl">close</span>
                        </button>
                    </form>
                    <img src="{{ post.cover_image.url }}" alt="{{ post.title }}" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl" />
                </div>
                <form method="dialog" class="modal-backdrop">
                    <button>close</button>
                </form>
            </dialog>
            {% endif %}
            
            <!-- 正文内容 (Content Body) -->
            <div class="bg-base-100 p-8 md:p-12 rounded-3xl shadow-sm border border-base-content/5 relative group/article overflow-hidden">
                {% include 'components/inspira/border_beam.html' with duration='12' rx='24px' %}
                <div id="post-content" class="min-h-[200px]"></div>
                {{ post.content|json_script:"post-content-data" }}
            </div>
            
            <!-- 标签与分享 (Tags & Share) -->
            <div class="not-prose mt-12 flex flex-col md:flex-row justify-between items-center gap-6 border-t border-base-content/10 pt-8">
                <div class="flex flex-wrap gap-2">
                    {% for tag in post.tags.all %}
                    <a href="{% url 'post_by_tag' tag.slug %}" class="badge badge-lg badge-outline gap-1 hover:bg-primary hover:text-white hover:border-primary transition-all pl-1.5">
                        <span class="material-symbols-outlined text-[14px]">tag</span>
                        {{ tag.name }}
                    </a>
                    {% endfor %}
                </div>

                <div class="flex items-center gap-3">
                    <span class="font-bold text-sm uppercase tracking-wider opacity-50">分享</span>
                    <div class="join">
                        <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}&text={{ post.title }}" target="_blank" class="btn btn-sm btn-circle btn-ghost hover:bg-black/10 hover:text-black" title="分享到 X">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                        </a>
                        <button class="btn btn-sm btn-circle btn-ghost hover:bg-primary/10 hover:text-primary" @click="$dispatch('show-toast', { message: '链接已复制！', type: 'success' }); navigator.clipboard.writeText(window.location.href)" title="复制链接">
                            <span class="material-symbols-outlined text-[20px]">content_copy</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 相关文章推荐 (Related Posts) -->
            {% if related_posts %}
            <div class="not-prose mt-16 border-t border-base-content/10 pt-12">
                <h3 class="text-2xl font-bold font-heading mb-8">相关阅读</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {% for related_post in related_posts %}
                    <a href="{{ related_post.get_absolute_url }}" class="group block h-full">
                        <div class="bg-base-100 rounded-xl overflow-hidden border border-base-content/5 shadow-sm hover:shadow-md transition-all h-full flex flex-col">
                            {% if related_post.cover_image %}
                            <div class="aspect-video overflow-hidden">
                                <img src="{{ related_post.cover_image.url }}" alt="{{ related_post.title }}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" />
                            </div>
                            {% else %}
                            <figure class="aspect-video relative overflow-hidden group-hover:brightness-110 transition-all duration-300 ease-in-out flex items-center justify-center text-center pattern-placeholder"
                                    data-seed="{{ related_post.title }}"
                                    x-init="initGeoPattern($el, '{{ related_post.title }}')">
                                <div class="flex items-center justify-center p-4 absolute inset-0">
                                    <div class="text-white font-bold text-lg leading-tight opacity-90 drop-shadow-md z-10 break-words w-full">{{ related_post.title }}</div>
                                </div>
                            </figure>
                            {% endif %}
                            <div class="p-4 flex flex-col flex-grow">
                                <h4 class="font-bold text-lg mb-2 line-clamp-2 group-hover:text-primary transition-colors">{{ related_post.title }}</h4>
                                <div class="mt-auto flex items-center justify-between text-xs text-base-content/60">
                                    <time>{{ related_post.published_at|default:related_post.created_at|date:"Y-m-d" }}</time>
                                    <span>{{ related_post.reading_time|default:"1" }} 分钟阅读</span>
                                </div>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- 文章导航 (Post Navigation) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-16 mb-8 not-prose">
                {% if previous_post %}
                <a href="{% url 'post_detail' previous_post.slug %}" class="group flex items-center gap-4 p-4 rounded-xl border border-base-content/10 hover:border-primary hover:bg-primary/5 transition-all duration-300">
                    <span class="material-symbols-outlined text-3xl text-base-content/30 group-hover:text-primary transition-colors">arrow_back</span>
                    <div class="overflow-hidden">
                        <div class="text-xs text-base-content/60 mb-1 group-hover:text-primary transition-colors">上一篇</div>
                        <div class="font-bold truncate group-hover:text-primary transition-colors">{{ previous_post.title }}</div>
                    </div>
                </a>
                {% else %}
                <div></div>
                {% endif %}

                {% if next_post %}
                <a href="{% url 'post_detail' next_post.slug %}" class="group flex items-center justify-end gap-4 p-4 rounded-xl border border-base-content/10 hover:border-primary hover:bg-primary/5 transition-all duration-300 text-right">
                    <div class="overflow-hidden">
                        <div class="text-xs text-base-content/60 mb-1 group-hover:text-primary transition-colors">下一篇</div>
                        <div class="font-bold truncate group-hover:text-primary transition-colors">{{ next_post.title }}</div>
                    </div>
                    <span class="material-symbols-outlined text-3xl text-base-content/30 group-hover:text-primary transition-colors">arrow_forward</span>
                </a>
                {% endif %}
            </div>

            <!-- 评论区 (Comments Section) -->
            <div class="not-prose mt-16" id="comments">
                <div class="flex items-center gap-4 mb-8">
                    <h3 class="text-2xl font-bold font-heading">评论</h3>
                    <div class="badge badge-neutral">{{ comments.count }}</div>
                </div>
                
                {% if config.ENABLE_COMMENTS %}
                <!-- 评论表单 (Comment Form) -->
                <div class="bg-base-100 p-6 md:p-8 rounded-2xl border border-base-content/10 shadow-sm mb-12" id="comment-form">
                    <h3 class="font-bold text-lg mb-4">发表你的观点</h3>
                    {% if user.is_authenticated %}
                    <form method="post" class="space-y-4">
                        {% csrf_token %}
                        <input type="hidden" name="parent_id" id="parent_id">
                        
                        <!-- 回复指示器 (Reply Indicator) -->
                        <div id="reply-indicator" class="hidden animate-in fade-in slide-in-from-top-2 duration-300 mb-4">
                            <div class="flex justify-between items-center w-full bg-base-200/50 backdrop-blur-sm border-l-4 border-primary rounded-r-lg p-3 shadow-sm">
                                <span class="text-sm flex items-center gap-2">
                                    <span class="w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                                        <span class="material-symbols-outlined text-[16px]">reply</span>
                                    </span>
                                    <span>
                                        正在回复 <span class="font-bold text-primary" id="reply-to-user"></span>
                                    </span>
                                </span>
                                <button type="button" class="btn btn-ghost btn-sm btn-circle hover:bg-base-300" onclick="cancelReply()" title="取消回复">
                                    <span class="material-symbols-outlined text-[18px]">close</span>
                                </button>
                            </div>
                        </div>

                        <div class="relative">
                            {{ comment_form.content }}
                        </div>
                        <div class="flex justify-end">
                            {% captureas btn_content %}发布评论{% endcaptureas %}
                            {% include 'components/inspira/rainbow_button.html' with slot_content=btn_content type='submit' extra_classes='px-8 h-10 min-h-0' %}
                        </div>
                    </form>
                    {% else %}
                    <div class="alert bg-base-200 border-none rounded-xl flex items-center gap-4">
                        <span class="material-symbols-outlined text-3xl text-primary">account_circle</span>
                        <div>
                            <h3 class="font-bold">需要登录</h3>
                            <div class="text-sm opacity-70">请 <a href="{% url 'users:login' %}?next={{ request.path }}" class="link link-primary font-bold">登录</a> 或 <a href="{% url 'users:register' %}" class="link link-primary">注册</a> 后参与讨论。</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="alert bg-base-200 border-none rounded-xl flex items-center gap-4 mb-12">
                    <span class="material-symbols-outlined text-3xl opacity-50">comments_disabled</span>
                    <div>
                        <h3 class="font-bold">评论已关闭</h3>
                        <div class="text-sm opacity-70">管理员已暂时关闭评论功能。</div>
                    </div>
                </div>
                {% endif %}

                <!-- 评论列表 (Comment List) -->
                <div class="space-y-6">
                    {% for comment in comments %}
                    <div class="group/comment relative" id="comment-{{ comment.id }}">
                        <div class="flex gap-4">
                            <!-- 头像列 (Avatar Column) -->
                            <div class="flex flex-col items-center shrink-0">
                                <div class="avatar">
                                    <div class="w-10 h-10 rounded-full ring-2 ring-base-100 shadow-sm">
                                        <a href="{% url 'users:user_public_profile' comment.user.username %}" title="查看 {{ comment.user.nickname|default:comment.user.username }} 的主页">
                                            <img src="{{ comment.user.get_avatar_url }}" alt="{{ comment.user.username }}" class="rounded-full object-cover" loading="lazy" />
                                        </a>
                                    </div>
                                </div>
                                <!-- 楼层连线 (Thread Line) -->
                                {% if comment.active_replies %}
                                <div class="w-0.5 h-full bg-base-content/5 my-2 rounded-full group-hover/comment:bg-primary/20 transition-colors"></div>
                                {% endif %}
                            </div>

                            <!-- 内容列 (Content Column) -->
                            <div class="flex-1 pb-2">
                                <div class="bg-base-100 rounded-2xl p-0">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="flex items-center gap-2 flex-wrap">
                                            <a href="{% url 'users:user_public_profile' comment.user.username %}" class="font-bold text-sm link link-hover hover:text-primary transition-colors">
                                                {{ comment.user.nickname|default:comment.user.username }}
                                            </a>
                                            {% if comment.user.is_staff %}
                                            <span class="badge badge-warning badge-xs gap-0.5 px-1.5 h-5 font-medium border-none text-warning-content/80">
                                                <span class="material-symbols-outlined text-[10px]">verified</span>
                                                管理员
                                            </span>
                                            {% endif %}
                                            <span class="text-xs text-base-content/40">• {{ comment.created_at|timesince }}前</span>
                                        </div>
                                        
                                        <div class="flex gap-1 opacity-0 group-hover/comment:opacity-100 transition-opacity">
                                            {% if user.is_authenticated %}
                                            <button onclick="replyTo('{{ comment.id }}', '{{ comment.user.nickname|default:comment.user.username }}')" class="btn btn-ghost btn-xs gap-1 h-7 min-h-0 px-2 font-normal text-base-content/60 hover:text-primary hover:bg-primary/10">
                                                <span class="material-symbols-outlined text-[14px]">reply</span>
                                                回复
                                            </button>
                                            {% endif %}
                                            {% if user.is_authenticated and user == comment.user or user.is_staff %}
                                            <button type="button" 
                                                    onclick="confirmAction('{% url 'delete_comment' comment.id %}', '确定要删除这条评论及其所有回复吗？', '删除评论')"
                                                    class="btn btn-ghost btn-xs text-error/70 hover:text-error hover:bg-error/10 gap-1 h-7 min-h-0 px-2 font-normal">
                                                <span class="material-symbols-outlined text-[14px]">delete</span>
                                                删除
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="prose prose-sm max-w-none text-base-content/80 prose-p:my-1 prose-a:text-primary">
                                        {{ comment.content|linebreaks }}
                                    </div>
                                </div>
                                
                                <!-- 回复列表 (Replies) -->
                                {% if comment.active_replies %}
                                <div class="mt-4 space-y-5">
                                    {% for reply in comment.active_replies %}
                                    <div class="flex gap-4 relative group/reply" id="comment-{{ reply.id }}">
                                        <!-- 弯曲连接线 (Curved Connector) -->
                                        <div class="absolute -left-[27px] top-0 w-5 h-5 border-l-2 border-b-2 border-base-content/5 rounded-bl-2xl group-hover/comment:border-primary/20 transition-colors"></div>
                                        
                                        <div class="avatar shrink-0">
                                            <div class="w-8 h-8 rounded-full ring-2 ring-base-100 shadow-sm">
                                                <a href="{% url 'users:user_public_profile' reply.user.username %}">
                                                    <img src="{{ reply.user.get_avatar_url }}" alt="{{ reply.user.username }}" class="rounded-full object-cover" loading="lazy" />
                                                </a>
                                            </div>
                                        </div>
                                        <div class="flex-1">
                                            <div class="flex justify-between items-start mb-1">
                                                <div class="flex items-center gap-2 flex-wrap">
                                                    <a href="{% url 'users:user_public_profile' reply.user.username %}" class="font-bold text-xs link link-hover hover:text-primary transition-colors">
                                                        {{ reply.user.nickname|default:reply.user.username }}
                                                    </a>
                                                    {% if reply.parent and reply.parent.user %}
                                                    <span class="text-xs text-base-content/40 flex items-center gap-1">
                                                        <span class="material-symbols-outlined text-[10px]">reply</span>
                                                        回复 @{{ reply.parent.user.nickname|default:reply.parent.user.username }}
                                                    </span>
                                                    {% endif %}
                                                    {% if reply.user.is_staff %}
                                                    <span class="badge badge-warning badge-xs gap-0.5 px-1.5 h-5 font-medium border-none text-warning-content/80">
                                                        <span class="material-symbols-outlined text-[10px]">verified</span>
                                                        管理员
                                                    </span>
                                                    {% endif %}
                                                    <span class="text-xs text-base-content/40">• {{ reply.created_at|timesince }}前</span>
                                                </div>
                                                <div class="flex gap-1 opacity-0 group-hover/reply:opacity-100 transition-opacity">
                                                    {% if user.is_authenticated and user == reply.user or user.is_staff %}
                                                    <button type="button" 
                                                            onclick="confirmAction('{% url 'delete_comment' reply.id %}', '确定要删除这条回复吗？', '删除回复')"
                                                            class="btn btn-ghost btn-xs text-error/70 hover:text-error hover:bg-error/10 h-6 min-h-0 px-1">
                                                        <span class="material-symbols-outlined text-[14px]">delete</span>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="prose prose-xs max-w-none text-base-content/80 prose-p:my-1">
                                                {{ reply.content|linebreaks }}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-16 bg-base-100 rounded-3xl border border-dashed border-base-content/20">
                        <div class="w-16 h-16 bg-base-200 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="material-symbols-outlined text-3xl opacity-50">chat_bubble_outline</span>
                        </div>
                        <h3 class="font-bold text-lg">暂无评论</h3>
                        <p class="text-base-content/60 mt-1">你的观点很有价值，快来抢沙发吧！</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </article>

        <!-- 侧边栏 / 目录 (Sidebar / TOC) -->
        <aside class="hidden lg:block lg:col-span-4 relative">
            <div class="sticky top-24 space-y-8">
                <!-- 目录卡片 (TOC Card) -->
                {% captureas toc_content %}
                <div class="p-6">
                    <h3 class="card-title text-sm uppercase tracking-wider opacity-50 mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">format_list_bulleted</span>
                        目录
                    </h3>
                    <nav id="toc" class="space-y-1 text-sm max-h-[60vh] overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-base-content/10 scrollbar-track-transparent">
                        <!-- TOC generated by JS -->
                    </nav>
                </div>
                {% endcaptureas %}
                <div class="bg-base-100 shadow-sm border border-base-content/5 overflow-hidden rounded-2xl">
                    {{ toc_content }}
                </div>

                <!-- 作者卡片 (Author Card) -->
                {% captureas author_content %}
                <div class="p-6 text-center">
                    <div class="avatar mx-auto mb-4">
                        <div class="w-20 h-20 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                            <img src="{{ post.author.get_avatar_url }}" alt="{{ post.author.username }}" />
                        </div>
                    </div>
                    <h3 class="font-bold text-lg">{{ post.author.nickname|default:post.author.username }}</h3>
                    <p class="text-sm text-base-content/60 mt-1">
                        {{ post.author.bio|default:"这个作者很懒，什么都没写~" }}
                    </p>
                    <div class="mt-6 flex justify-center gap-4">
                        <div class="text-center">
                            <div class="font-bold text-lg">{{ post.author.posts.count }}</div>
                            <div class="text-xs opacity-60">文章</div>
                        </div>
                        <div class="w-px bg-base-content/10"></div>
                        <div class="text-center">
                            <div class="font-bold text-lg">{{ post.author.total_views }}</div>
                            <div class="text-xs opacity-60">阅读</div>
                        </div>
                    </div>
                    <a href="{% url 'users:user_public_profile' post.author.username %}" class="btn btn-outline btn-primary btn-sm rounded-full mt-6 w-full">
                        访问主页
                    </a>
                </div>
                {% endcaptureas %}
                <div class="bg-base-100 shadow-sm border border-base-content/5 rounded-2xl">
                    {{ author_content }}
                </div>
            </div>
        </aside>
    </div>
</div>

<script src="{% static 'js/viewer.js' %}"></script>
<script>
    /**
     * 回复评论 (Reply to a comment)
     * @param {string} commentId - 目标评论ID
     * @param {string} username - 目标用户昵称
     */
    function replyTo(commentId, username) {
        document.getElementById('parent_id').value = commentId;
        document.getElementById('reply-to-user').textContent = username;
        document.getElementById('reply-indicator').classList.remove('hidden');
        document.getElementById('comment-form').scrollIntoView({behavior: 'smooth'});
        document.querySelector('textarea[name="content"]').focus();
    }

    /**
     * 取消回复 (Cancel reply)
     */
    function cancelReply() {
        document.getElementById('parent_id').value = '';
        document.getElementById('reply-indicator').classList.add('hidden');
    }

    document.addEventListener('DOMContentLoaded', () => {
        // --- 初始化 ByteMD Viewer (Init ByteMD Viewer) ---
        const contentData = document.getElementById('post-content-data');
        if (contentData) {
            try {
                const content = JSON.parse(contentData.textContent);
                if (window.initByteMDViewer) {
                    window.initByteMDViewer('post-content', content);
                } else {
                    console.error('ByteMD Viewer script not loaded.');
                }
            } catch (e) {
                console.error('Failed to parse post content:', e);
            }
        }

        // --- 自动生成目录 (Auto-generate TOC) ---
        // 使用 setTimeout 确保 Viewer 渲染完成后再生成目录
        setTimeout(() => {
            const article = document.querySelector('article');
            const headings = article.querySelectorAll('h2, h3');
            const toc = document.getElementById('toc');
            
            if (headings.length === 0) {
                // 如果没有标题，隐藏目录卡片
                if(toc) toc.closest('.card').style.display = 'none';
            } else {
                headings.forEach((heading, index) => {
                    const id = `heading-${index}`;
                    heading.id = id;
                    heading.classList.add('scroll-mt-24'); // 添加滚动偏移 (Add scroll margin)
                    
                    const link = document.createElement('a');
                    link.href = `#${id}`;
                    link.textContent = heading.textContent;
                    link.className = 'block py-1.5 pl-3 border-l-2 border-base-content/10 hover:border-primary hover:text-primary transition-all duration-200 text-base-content/60 text-xs truncate';
                    if (heading.tagName === 'H3') link.classList.add('ml-4');
                    
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        document.getElementById(id).scrollIntoView({behavior: 'smooth'});
                    });
                    
                    toc.appendChild(link);
                });
                
                // --- 滚动监听 (ScrollSpy) ---
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const id = entry.target.id;
                            document.querySelectorAll('#toc a').forEach(link => {
                                link.classList.remove('border-primary', 'text-primary', 'font-medium', 'bg-primary/5');
                                link.classList.add('border-base-content/10', 'text-base-content/60');
                                
                                if (link.getAttribute('href') === `#${id}`) {
                                    link.classList.remove('border-base-content/10', 'text-base-content/60');
                                    link.classList.add('border-primary', 'text-primary', 'font-medium', 'bg-primary/5');
                                }
                            });
                        }
                    });
                }, { rootMargin: '-100px 0px -66%' });
                
                headings.forEach(heading => observer.observe(heading));
            }
        }, 100); // 100ms 延迟，确保 Viewer 渲染完成
    });
</script>

<!-- Mermaid 图表渲染 -->
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    
    async function initMermaid() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const theme = 'base';
        const styles = getComputedStyle(document.documentElement);
        const getVar = (name, fallback) => {
            const value = styles.getPropertyValue(name).trim();
            return value || fallback;
        };
        const baseTextColor = getVar('--bc', isDark ? '#e5e7eb' : '#1f2937');
        const baseBackground = getVar('--b1', isDark ? '#0b1220' : '#ffffff');
        const surfaceBackground = getVar('--b2', isDark ? '#111827' : '#f8fafc');
        const borderColor = getVar('--b3', isDark ? '#1f2937' : '#e2e8f0');
        const themeVariables = {
            background: baseBackground,
            mainBkg: surfaceBackground,
            primaryColor: getVar('--p', '#3b82f6'),
            primaryTextColor: baseTextColor,
            primaryBorderColor: borderColor,
            secondaryColor: getVar('--s', '#60a5fa'),
            secondaryTextColor: baseTextColor,
            secondaryBorderColor: borderColor,
            tertiaryColor: getVar('--a', '#f59e0b'),
            tertiaryTextColor: baseTextColor,
            tertiaryBorderColor: borderColor,
            lineColor: baseTextColor,
            textColor: baseTextColor,
            labelTextColor: baseTextColor,
            nodeTextColor: baseTextColor,
            noteBkgColor: surfaceBackground,
            noteTextColor: baseTextColor,
            edgeLabelBackground: surfaceBackground,
            titleColor: baseTextColor,
            actorTextColor: baseTextColor,
            taskTextColor: baseTextColor,
            taskTextOutsideColor: baseTextColor,
            clusterBkg: surfaceBackground,
            clusterBorder: borderColor,
        };
        mermaid.initialize({
            startOnLoad: false,
            theme: theme,
            securityLevel: 'loose',
            fontFamily: 'inherit',
            themeVariables: themeVariables,
        });

        // 查找所有 mermaid 代码块
        // Python-Markdown 可能生成:
        // 1. <code class="language-mermaid">...</code>
        // 2. <div class="codehilite"><pre>... (if pygments fails)</pre></div>
        // 我们主要关注 class="language-mermaid"
        const mermaidCodes = document.querySelectorAll('code.language-mermaid');
        
        for (const code of mermaidCodes) {
            // 获取纯文本内容 (去除 Pygments 可能添加的 span)
            const graphDefinition = code.textContent;
            
            // 创建新的 div 容器
            const div = document.createElement('div');
            div.classList.add('mermaid');
            div.textContent = graphDefinition;
            div.dataset.source = graphDefinition;
            
            // 替换整个 pre 标签 (或者 codehilite 容器)
            const pre = code.parentElement; // <pre>
            if (pre.tagName === 'PRE') {
                // 检查是否有 .codehilite 父容器 (由 markdown_extras.py 生成)
                // .mockup-code .codehilite -> pre -> code
                // 或者 .codehilite -> pre -> code
                let targetToReplace = pre;
                const parent = pre.parentElement;
                if (parent && (parent.classList.contains('codehilite') || parent.classList.contains('mockup-code'))) {
                    targetToReplace = parent;
                }
                
                targetToReplace.replaceWith(div);
            } else {
                code.replaceWith(div);
            }
        }
        
        const mermaidNodes = document.querySelectorAll('.mermaid');
        mermaidNodes.forEach((node) => {
            if (node.dataset.source) {
                node.textContent = node.dataset.source;
            }
            node.removeAttribute('data-processed');
        });

        // 运行 Mermaid
        await mermaid.run({
            nodes: mermaidNodes
        });
    }
    
    // 确保 DOM 加载完成后执行
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMermaid);
    } else {
        initMermaid();
    }
    
    // 监听主题切换事件
    let themeUpdateTimer;
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.attributeName === 'data-theme') {
                if (themeUpdateTimer) clearTimeout(themeUpdateTimer);
                themeUpdateTimer = setTimeout(() => {
                    initMermaid();
                }, 50);
            }
        });
    });
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
</script>
{% endblock %}
