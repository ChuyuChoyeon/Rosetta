{% extends 'base.html' %}
{% load i18n %}
{% block content %}
    <div class="container mx-auto px-4 py-12 max-w-7xl">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <h1 class="text-3xl font-bold">{% blocktrans %}"{{ query }}" 的搜索结果{% endblocktrans %}</h1>
            <!-- Search Filters and Bar -->
            <div class="flex flex-col md:flex-row items-center gap-4 w-full md:w-auto">
                <div role="tablist" class="tabs tabs-boxed">
                    <a href="?q={{ query }}"
                       class="tab {% if not search_type or search_type == 'all' %}tab-active{% endif %}">{% trans "全部" %}</a>
                    <a href="?q={{ query }}&type=post"
                       class="tab {% if search_type == 'post' %}tab-active{% endif %}">{% trans "文章" %}</a>
                    <a href="?q={{ query }}&type=user"
                       class="tab {% if search_type == 'user' %}tab-active{% endif %}">{% trans "用户" %}</a>
                    <a href="?q={{ query }}&type=tag"
                       class="tab {% if search_type == 'tag' %}tab-active{% endif %}">{% trans "标签" %}</a>
                    <a href="?q={{ query }}&type=category"
                       class="tab {% if search_type == 'category' %}tab-active{% endif %}">{% trans "分类" %}</a>
                    <a href="?q={{ query }}&type=poll"
                       class="tab {% if search_type == 'poll' %}tab-active{% endif %}">{% trans "投票" %}</a>
                </div>
                <form action="{% url 'search' %}"
                      method="get"
                      class="join w-full md:w-auto">
                    <input type="hidden" name="type" value="{{ search_type }}">
                    <input type="text"
                           name="q"
                           value="{{ query }}"
                           class="input input-bordered join-item w-full md:w-64"
                           placeholder="{% trans '搜索...' %}"
                           required>
                    <button type="submit" class="btn btn-primary join-item">
                        <span class="material-symbols-outlined">search</span>
                    </button>
                </form>
            </div>
        </div>
        {% if results %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                {% for result in results %}
                    {% with item=result.object|default:result %}
                        <!-- User Card -->
                        {% if item.username %}
                            <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300 hover:-translate-y-1">
                                <div class="card-body items-center text-center">
                                    <div class="avatar mb-4">
                                        <div class="w-24 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                                            <img src="{{ item.get_avatar_url }}" alt="{{ item.username }}" />
                                        </div>
                                    </div>
                                    <h2 class="card-title">{{ item.nickname|default:item.username }}</h2>
                                    <p class="text-sm text-base-content/60">@{{ item.username }}</p>
                                    <div class="card-actions mt-4">
                                        <a href="{% url 'users:user_public_profile' item.username %}"
                                           class="btn btn-primary btn-sm">{% trans "查看主页" %}</a>
                                    </div>
                                </div>
                            </div>
                            <!-- Poll Card -->
                        {% elif item.choices %}
                            <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300 hover:-translate-y-1 border border-base-content/5">
                                <div class="card-body">
                                    <div class="flex items-start justify-between">
                                        <div>
                                            <h2 class="card-title text-lg">
                                                <a href="{% url 'voting:detail' item.pk %}"
                                                   class="hover:text-primary transition-colors">{{ item.title }}</a>
                                            </h2>
                                            <p class="text-sm text-base-content/60 mt-2 line-clamp-2">{{ item.description }}</p>
                                        </div>
                                        <div class="badge badge-primary badge-outline">{% trans "投票" %}</div>
                                    </div>
                                    <div class="card-actions justify-between items-center mt-6">
                                        <span class="text-xs text-base-content/50">{% blocktrans with count=item.total_votes %}{{ count }} 人参与{% endblocktrans %}</span>
                                        <a href="{% url 'voting:detail' item.pk %}"
                                           class="btn btn-primary btn-sm">{% trans "参与投票" %}</a>
                                    </div>
                                </div>
                            </div>
                            <!-- Tag/Category Card -->
                        {% elif item.name %}
                            <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300 hover:-translate-y-1 border border-base-content/5">
                                <div class="card-body items-center text-center">
                                    <div class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mb-2 text-primary">
                                        <span class="material-symbols-outlined text-3xl">
                                            {% if item.parent %}
                                                folder
                                            {% else %}
                                                label
                                            {% endif %}
                                        </span>
                                    </div>
                                    <h2 class="card-title">{{ item.name }}</h2>
                                    {% trans "暂无描述" as default_desc %}
                                    <p class="text-sm text-base-content/60">{{ item.description|default:default_desc }}</p>
                                    <div class="card-actions mt-4">
                                        <a href="{% if item.parent %}{% url 'post_by_category' item.slug %}{% else %}{% url 'post_by_tag' item.slug %}{% endif %}"
                                           class="btn btn-ghost btn-sm">{% trans "查看文章" %}</a>
                                    </div>
                                </div>
                            </div>
                            <!-- Post Card (Default Fallback for items with title) -->
                        {% elif item.title %}
                            <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300 hover:-translate-y-1">
                                {% if item.cover_image %}
                                    <figure class="h-48 overflow-hidden">
                                        <img src="{{ item.cover_thumbnail.url }}"
                                             alt="{{ item.title }}"
                                             class="object-cover w-full h-full" />
                                    </figure>
                                {% else %}
                                    <figure class="h-48 bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-primary-content">
                                        <span class="text-4xl font-bold">{{ item.title|slice:":1" }}</span>
                                    </figure>
                                {% endif %}
                                <div class="card-body">
                                    <h2 class="card-title text-lg font-bold">
                                        <a href="{% url 'post_detail' item.slug %}"
                                           class="hover:text-primary transition-colors">
                                            {{ result.title|default:item.title }}
                                        </a>
                                    </h2>
                                    <p class="text-sm text-base-content/80 line-clamp-3">{{ result.description|default:item.excerpt }}</p>
                                    <div class="card-actions justify-end mt-4">
                                        {% for tag in item.tags.all|slice:":3" %}<div class="badge badge-outline text-xs">{{ tag.name }}</div>{% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endwith %}
                {% endfor %}
            </div>
        {% else %}
            <div class="flex flex-col items-center justify-center py-20 text-center">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="h-24 w-24 text-base-content/20 mb-4"
                     fill="none"
                     viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <h3 class="text-2xl font-bold text-base-content/50">{% trans "没有找到相关结果" %}</h3>
                <p class="text-base-content/40 mt-2">{% trans "请尝试其他关键词或切换搜索类型。" %}</p>
            </div>
        {% endif %}
    </div>
{% endblock %}
