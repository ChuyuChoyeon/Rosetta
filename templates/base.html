{% load static tailwind_tags meta %}
<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <title>{% block title %}{{ config.SITE_NAME.value|default:"Rosetta Blog" }}{% endblock %}</title>
    <link rel="shortcut icon" href="{{ config.SITE_FAVICON|default:'/static/core/img/favicon.ico' }}">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="{% url 'post_feed' %}">
    
    <!-- Google 字体：Poppins & Open Sans (本地化) -->
    <link href="{% static 'theme/css/fonts.css' %}" rel="stylesheet">
    
    <!-- Meta 标签 -->
    {% include 'meta/meta.html' %}
    
    {% if config.SITE_KEYWORDS %}
    <meta name="keywords" content="{{ config.SITE_KEYWORDS }}">
    {% endif %}
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <!-- Material Symbols 图标字体 -->
    <style>
        @font-face {
            font-family: 'Material Symbols Outlined';
            font-style: normal;
            font-weight: 100 700;
            font-display: swap; /* Performance optimization */
            src: url("{% static 'theme/fonts/MaterialSymbolsOutlined.woff2' %}") format('woff2');
        }
        .material-symbols-outlined {
            font-family: 'Material Symbols Outlined';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }
    </style>
    
    {% tailwind_css %}
    <link href="{% static 'theme/css/cropper.min.css' %}" rel="stylesheet">

    {% block extra_css %}{% endblock %}

    {% if config.EXTRA_HEAD_CODE %}
    {{ config.EXTRA_HEAD_CODE|safe }}
    {% endif %}

    <!-- NProgress 加载进度条 (必须在 Tailwind 之后以获取变量) -->
    <script src="{% static 'theme/js/nprogress.js' %}"></script>
    <link rel="stylesheet" href="{% static 'theme/css/nprogress.css' %}" />
    
    <script>
        // --- NProgress 进度条配置 ---
        // 初始化进度条参数
        NProgress.configure({ 
            showSpinner: false, // 不显示加载转圈
            minimum: 0.2,       // 最小百分比
            easing: 'ease',     // 动画曲线
            speed: 500          // 动画速度 (ms)
        });
        
        // --- 全局页面加载状态管理 ---
        // PageLoader 对象用于统一管理页面加载状态
        const PageLoader = {
            start: function() {
                NProgress.start();
                document.body.classList.add('loading-state'); // 添加 loading 类，可用于 CSS 样式控制
            },
            done: function() {
                NProgress.done();
                document.body.classList.remove('loading-state');
            }
        };

        // --- HTMX 事件绑定 ---
        // 绑定 HTMX 请求生命周期，实现无刷新加载时的进度条显示
        document.addEventListener("htmx:beforeRequest", () => PageLoader.start());
        document.addEventListener("htmx:afterRequest", () => PageLoader.done());
        document.addEventListener("htmx:historyRestore", () => PageLoader.done());
        
        // --- 常规页面加载绑定 ---
        // 处理普通链接跳转和页面刷新
        window.addEventListener('beforeunload', () => PageLoader.start());
        document.addEventListener('DOMContentLoaded', () => PageLoader.done());
        
        // --- 浏览器后退/前进缓存 (bfcache) 处理 ---
        // 当页面从缓存中恢复时，确保加载状态被重置
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                PageLoader.done();
            }
        });
    </script>
    <script src="{% static 'theme/js/htmx.min.js' %}"></script>
    <script defer src="{% static 'theme/js/alpine.min.js' %}"></script>
    <script src="{% static 'theme/js/cropper.min.js' %}"></script>
    <script src="{% static 'theme/js/geopattern.min.js' %}"></script>
    <script src="{% static 'theme/js/theme.js' %}"></script>
    <script src="{% static 'theme/js/ui.js' %}"></script>

    <script>
        // --- 全局配置 ---
        {% if user.is_authenticated %}
        window.USER_PREFERENCE_URL = "{% url 'users:update_theme' %}";
        {% endif %}

        // --- 主题初始化 (Theme Initialization) ---
        // 立即执行以防止 FOUC (Flash of Unstyled Content, 无样式内容闪烁)
        (function() {
            try {
                // 1. 获取本地存储的主题或系统偏好
                var localTheme = localStorage.getItem('theme');
                var theme = localTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                
                // 2. 服务端用户偏好覆盖 (如果用户已登录)
                {% if user.is_authenticated and user.preference.theme and user.preference.theme != 'auto' %}
                    theme = "{{ user.preference.theme }}";
                    localStorage.setItem('theme', theme);
                {% endif %}

                // 3. 应用主题
                // 如果 ThemeManager 已加载 (theme.js)，则使用它
                if (window.ThemeManager) {
                    // false = 不要立即同步回后端 (避免冗余请求，因为我们刚从后端获取)
                    window.ThemeManager.applyTheme(theme, false);
                } else {
                    // 降级处理：直接设置 HTML 属性
                    document.documentElement.setAttribute('data-theme', theme);
                    // 为某些主题添加 dark 类 (Tailwind dark mode 支持)
                    if (['dark'].includes(theme)) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                }
            } catch (e) {
                console.error('Theme initialization error:', e);
            }
        })();
    </script>
    
    <style>
        body { font-family: system-ui, -apple-system, "Segoe UI", "Microsoft YaHei", "PingFang SC", "Hiragino Sans GB", "Noto Sans SC", Arial, sans-serif; }
        
        /* Smooth Scrolling */
        html { scroll-behavior: smooth; }

        /* Reading Progress Bar */
        .progress-container {
            position: fixed;
            top: 0;
            z-index: 100;
            width: 100%;
            height: 4px;
            background: transparent;
        }
        
        .progress-bar {
            height: 4px;
            background: oklch(var(--p));
            width: 0%;
            transition: width 0.1s ease;
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        html[data-theme='dark'] .glass-panel {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col font-sans text-base-content selection:bg-primary selection:text-primary-content scrollbar-thin scrollbar-thumb-base-300 scrollbar-track-base-100 {% if debug %}debug-screens{% endif %}" x-data="{ showScrollTop: false }" @scroll.window="showScrollTop = (window.pageYOffset > 300)">

    <!-- Inspira UI: 神经元背景动画 -->
    {% include 'components/inspira/neural_background.html' %}

    <!-- 阅读进度条 -->
    <div class="progress-container">
        <div class="progress-bar" id="readingProgress"></div>
    </div>

    <!-- 内容包裹层 -->
    <div id="main-wrapper" class="flex flex-col min-h-screen">
        {% include 'partials/navbar.html' %}

        <main class="flex-grow container mx-auto px-4 py-8">
            <!-- Toast 通知 -->
            {% include 'components/toast.html' %}
            
            {% block content %}{% endblock %}
        </main>
        
        <!-- 全局确认弹窗 -->
        {% include 'components/confirm_modal.html' %}

        {% include 'partials/footer.html' %}
    </div>

    <!-- 回到顶部按钮 -->
    <button 
        x-show="showScrollTop" 
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-10"
        x-transition:enter-end="opacity-100 translate-y-0"
        x-transition:leave="transition ease-in duration-300"
        x-transition:leave-start="opacity-100 translate-y-0"
        x-transition:leave-end="opacity-0 translate-y-10"
        @click="window.scrollTo({top: 0, behavior: 'smooth'})"
        class="fixed bottom-8 right-8 btn btn-circle btn-primary shadow-xl z-40 glass-panel border-none text-primary-content hover:scale-110 transition-transform duration-200"
        aria-label="Scroll to top"
    >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
        </svg>
    </button>

    <script>
        // --- 阅读进度条逻辑 (Reading Progress Bar) ---
        // 监听滚动事件，动态计算并更新顶部进度条宽度
        window.onscroll = function() {
            let winScroll = document.body.scrollTop || document.documentElement.scrollTop;
            let height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            let scrolled = (winScroll / height) * 100;
            document.getElementById("readingProgress").style.width = scrolled + "%";
        };
    </script>
</body>
</html>
