{% load static tailwind_tags meta %}
<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <title>{% block title %}{{ config.SITE_NAME|default:"Rosetta Blog" }}{% endblock %}</title>
    <link rel="shortcut icon" href="{{ config.SITE_FAVICON|default:'/static/core/img/favicon.ico' }}">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="{% url 'post_feed' %}">
    
    <!-- Google 字体：Poppins & Open Sans (本地化) -->
    <link href="{% static 'theme/css/fonts.css' %}" rel="stylesheet">
    
    <!-- Meta 标签 -->
    {% include 'meta/meta.html' %}
    
    {% if config.SITE_KEYWORDS %}
    <meta name="keywords" content="{{ config.SITE_KEYWORDS }}">
    {% endif %}
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <!-- Material Symbols 图标字体 -->
    <style>
        @font-face {
            font-family: 'Material Symbols Outlined';
            font-style: normal;
            font-weight: 100 700;
            font-display: block; 
            src: url("{% static 'theme/fonts/MaterialSymbolsOutlined.woff2' %}") format('woff2');
        }
        .material-symbols-outlined {
            font-family: 'Material Symbols Outlined';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }
    </style>
    
    {% tailwind_css %}
    <link href="{% static 'theme/css/cropper.min.css' %}" rel="stylesheet">

    {% block extra_css %}{% endblock %}
    {% block extra_head %}{% endblock %}

    {% if config.EXTRA_HEAD_CODE %}
    {{ config.EXTRA_HEAD_CODE|safe }}
    {% endif %}

    <!-- NProgress 加载进度条 (必须在 Tailwind 之后以获取变量) -->
    <script src="{% static 'theme/js/nprogress.js' %}"></script>
    <link rel="stylesheet" href="{% static 'theme/css/nprogress.css' %}" />
    
    <script src="{% static 'js/page-loader.js' %}"></script>
    <script src="{% static 'theme/js/htmx.min.js' %}"></script>
    <script defer src="{% static 'theme/js/alpine.min.js' %}"></script>
    <script src="{% static 'theme/js/cropper.min.js' %}"></script>
    <script src="{% static 'theme/js/geopattern.min.js' %}"></script>
    <script src="{% static 'theme/js/theme.js' %}"></script>
    <script src="{% static 'theme/js/ui.js' %}"></script>
    <script src="{% static 'js/ui-helpers.js' %}"></script>

    <script>
        // --- 全局配置 ---
        {% if user.is_authenticated %}
        window.USER_PREFERENCE_URL = "{% url 'users:update_theme' %}";
        {% endif %}
    </script>
    
    {% include 'partials/theme_init.html' %}
    
    <style>
        body { font-family: system-ui, -apple-system, "Segoe UI", "Microsoft YaHei", "PingFang SC", "Hiragino Sans GB", "Noto Sans SC", Arial, sans-serif; }
        
        /* Smooth Scrolling */
        html { scroll-behavior: smooth; }

        /* Reading Progress Bar */
        .progress-container {
            position: fixed;
            top: 0;
            z-index: 100;
            width: 100%;
            height: 4px;
            background: transparent;
        }
        
        .progress-bar {
            height: 4px;
            background: oklch(var(--p));
            width: 0%;
            transition: width 0.1s ease;
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        html[data-theme='dark'] .glass-panel {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col font-sans text-base-content selection:bg-primary selection:text-primary-content scrollbar-thin scrollbar-thumb-base-300 scrollbar-track-base-100 {% if debug %}debug-screens{% endif %}" 
      x-data="{ showScrollTop: false }" 
      @scroll.window="showScrollTop = (window.pageYOffset > 300)"
      hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>

    <!-- Inspira UI: 神经元背景动画 -->
    {% include 'components/inspira/neural_background.html' %}

    <!-- 阅读进度条 -->
    <div class="progress-container">
        <div class="progress-bar" id="readingProgress"></div>
    </div>

    <!-- 内容包裹层 -->
    <div id="main-wrapper" class="flex flex-col min-h-screen">
        {% include 'partials/navbar.html' %}

        <main class="flex-grow container mx-auto px-4 py-8">
            <!-- Toast 通知 -->
            {% include 'components/toast.html' %}
            
            {% block content %}{% endblock %}
        </main>
        
        <!-- 全局确认弹窗 -->
    {% include 'components/confirm_modal.html' %}
    
    <!-- 文章详情页骨架屏 (Article Skeleton) -->
    {% include 'components/skeletons/article_skeleton.html' %}

    {% include 'partials/footer.html' %}
    </div>

    <!-- 回到顶部按钮 -->
    <button 
        x-show="showScrollTop" 
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-10"
        x-transition:enter-end="opacity-100 translate-y-0"
        x-transition:leave="transition ease-in duration-300"
        x-transition:leave-start="opacity-100 translate-y-0"
        x-transition:leave-end="opacity-0 translate-y-10"
        @click="window.scrollTo({top: 0, behavior: 'smooth'})"
        class="fixed bottom-8 right-8 btn btn-circle btn-primary shadow-xl z-40 glass-panel border-none text-primary-content hover:scale-110 transition-transform duration-200"
        aria-label="Scroll to top"
    >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
        </svg>
    </button>

    <script>
        // --- 阅读进度条逻辑 (Reading Progress Bar) ---
        // 监听滚动事件，动态计算并更新顶部进度条宽度
        window.onscroll = function() {
            let winScroll = document.body.scrollTop || document.documentElement.scrollTop;
            let height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            let scrolled = (winScroll / height) * 100;
            document.getElementById("readingProgress").style.width = scrolled + "%";
        };
    </script>

    {% if config.EXTRA_FOOTER_CODE %}
    {{ config.EXTRA_FOOTER_CODE|safe }}
    {% endif %}
</body>
</html>
