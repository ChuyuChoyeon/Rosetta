{% load static tailwind_tags meta i18n %}
<!--
    全站基础模板 (Base Template)
    
    这是所有页面的父模板，定义了 HTML 骨架、全局样式、脚本以及公共组件（导航栏、页脚、Toast等）。
    
    可覆盖的 Block (Blocks available for override):
    - title: 页面标题
    - extra_css: 页面特定的 CSS 样式
    - extra_head: 插入到 <head> 尾部的其他内容
    - content: 页面主体内容
-->
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
    <title>{% block title %}{{ meta.title|default:config.SITE_NAME }}{% endblock %}{{ config.SITE_TITLE_SUFFIX }}</title>
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'theme/img/favicon.ico' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'theme/img/favicon.ico' %}">
    <link rel="shortcut icon" href="{% static 'theme/img/favicon.ico' %}">
    <link rel="alternate" type="application/rss+xml" title="{% trans 'RSS Feed' %}" href="{% url 'post_feed' %}">
    
    <!-- Google 字体：Poppins & Open Sans (本地化托管) -->
    <link href="{% static 'theme/css/fonts.css' %}" rel="stylesheet">
    
    <!-- Meta 标签 (SEO 与社交分享) -->
    {% include 'meta/meta.html' %}
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <!-- Material Symbols 图标字体配置 -->
    <style>
        @font-face {
            font-family: 'Material Symbols Outlined';
            font-style: normal;
            font-weight: 100 700;
            font-display: block; 
            src: url("{% static 'theme/fonts/MaterialSymbolsOutlined.woff2' %}") format('woff2');
        }
        .material-symbols-outlined {
            font-family: 'Material Symbols Outlined';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }
    </style>
    
    <!-- 引入 Tailwind CSS (由 django-tailwind 编译) -->
    {% tailwind_css %}
    
    <!-- 第三方库样式 -->
    <link href="{% static 'theme/css/style.css' %}" rel="stylesheet">

    <!-- 预留给子模板的样式块 -->
    {% block extra_css %}{% endblock %}
    <!-- Cropper.js -->
    <script src="{% static 'js/image-cropper.js' %}"></script>
    
    {% block extra_head %}{% endblock %}
</head>
    <!-- 注入后台配置的自定义 Head 代码 (如统计脚本) -->
    {% if config.EXTRA_HEAD_CODE %}
    {{ config.EXTRA_HEAD_CODE|safe }}
    {% endif %}

    <!-- NProgress 加载进度条 (必须在 Tailwind 之后以获取 CSS 变量) -->
    <script src="{% static 'theme/js/nprogress.js' %}"></script>
    <link rel="stylesheet" href="{% static 'theme/css/nprogress.css' %}" />
    
    <!-- 全局脚本库 -->
    <script src="{% static 'js/page-loader.js' %}"></script>
    <script src="{% static 'theme/js/htmx.min.js' %}"></script> <!-- HTMX 用于局部刷新 -->
    <script defer src="{% static 'theme/js/alpine.min.js' %}"></script> <!-- Alpine.js 用于轻量级交互 -->
    <script src="{% static 'theme/js/geopattern.min.js' %}"></script>
    <script src="{% static 'theme/js/theme.js' %}"></script>
    <script src="{% static 'theme/js/ui.js' %}"></script>
    <script src="{% static 'js/ui-helpers.js' %}"></script>
    <script src="{% static 'js/htmx-init.js' %}"></script>

    <script>
        // --- 全局配置 ---
        // 如果用户已登录，设置主题更新 URL，供 theme.js 调用
        {% if user.is_authenticated %}
        window.USER_PREFERENCE_URL = "{% url 'users:update_theme' %}";
        {% endif %}
    </script>
    
    <!-- 主题初始化 (防闪烁) -->
    {% include 'partials/theme_init.html' %}
    
    <style>
        /* 平滑滚动 */
        html { scroll-behavior: smooth; }

        /* 自定义滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: oklch(var(--bc) / 0.2);
            border-radius: 9999px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: oklch(var(--bc) / 0.4);
        }
        
        /* 文本选中颜色 */
        ::selection {
            background-color: oklch(var(--p) / 0.3);
            color: inherit;
        }

        /* 顶部阅读进度条容器 */
        .progress-container {
            position: fixed;
            top: 0;
            z-index: 100;
            width: 100%;
            height: 4px;
            background: transparent;
        }
        
        /* 进度条本体 */
        .progress-bar {
            height: 4px;
            background: oklch(var(--p));
            width: 0%;
            transition: width 0.1s ease;
        }

        /* 玻璃拟态 (Glassmorphism) 工具类 */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        /* 暗色模式下的玻璃拟态 */
        html[data-theme='dark'] .glass-panel {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<!-- 
    Body 标签说明:
    1. x-data: Alpine.js 状态，用于控制“回到顶部”按钮的显示
    2. @scroll.window: 监听滚动事件
    3. hx-headers: 为所有 HTMX 请求注入 CSRF Token
-->
<body class="min-h-screen flex flex-col font-sans text-base-content selection:bg-primary selection:text-primary-content scrollbar-thin scrollbar-thumb-base-300 scrollbar-track-base-100 {% if debug %}debug-screens{% endif %}" 
      x-data="{ showScrollTop: false }" 
      @scroll.window="showScrollTop = (window.pageYOffset > 300)"
      hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>

    <!-- Inspira UI: 神经元背景动画特效 -->
    {% include 'components/inspira/neural_background.html' %}

    <!-- 顶部阅读进度条 -->
    <div class="progress-container">
        <div class="progress-bar" id="readingProgress"></div>
    </div>

    <!-- 主内容包裹层 (Sticky Footer 布局) -->
    <div id="main-wrapper" class="flex flex-col min-h-screen">
        <!-- 顶部导航栏 -->
        {% include 'partials/navbar.html' %}

        <main class="flex-grow container mx-auto px-4 py-8">
            <!-- Toast 全局通知容器 -->
            {% include 'components/toast.html' %}
            
            <!-- 页面具体内容块 -->
            {% block content %}{% endblock %}
        </main>
        
        <!-- 全局确认弹窗 (用于删除操作等) -->
    {% include 'components/confirm_modal.html' %}
    
    <!-- 文章详情页骨架屏 (加载占位) -->
    {% include 'components/skeletons/article_skeleton.html' %}

    <!-- 页脚 -->
    {% include 'partials/footer.html' %}
    </div>

    <!-- 回到顶部按钮 (Floating Action Button) -->
    <button 
        x-show="showScrollTop" 
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-10"
        x-transition:enter-end="opacity-100 translate-y-0"
        x-transition:leave="transition ease-in duration-300"
        x-transition:leave-start="opacity-100 translate-y-0"
        x-transition:leave-end="opacity-0 translate-y-10"
        @click="window.scrollTo({top: 0, behavior: 'smooth'})"
        class="fixed bottom-8 right-8 btn btn-circle btn-primary shadow-xl z-40 glass-panel border-none text-primary-content hover:scale-110 transition-transform duration-200"
        aria-label="Scroll to top"
    >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
        </svg>
    </button>

    <script>
        // --- 阅读进度条逻辑 (Reading Progress Bar) ---
        // 监听滚动事件，动态计算并更新顶部进度条宽度
        // 显示用户当前阅读位置在整个页面中的百分比
        window.onscroll = function() {
            let winScroll = document.body.scrollTop || document.documentElement.scrollTop;
            let height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            let scrolled = (winScroll / height) * 100;
            document.getElementById("readingProgress").style.width = scrolled + "%";
        };
    </script>

    <!-- 注入后台配置的自定义 Footer 代码 (如客服脚本) -->
    {% if config.EXTRA_FOOTER_CODE %}
    {{ config.EXTRA_FOOTER_CODE|safe }}
    {% endif %}
</body>
</html>
