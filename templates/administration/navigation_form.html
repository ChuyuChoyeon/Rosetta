{% extends "administration/base.html" %}
{% load capture_tags i18n %}
{% load widget_tweaks %}

{% block title %}
{% trans "ç¼–è¾‘å¯¼èˆª" as default_title %}
{{ title|default:default_title }}{{ config.SITE_ADMIN_SUFFIX|default:" - Rosetta Dashboard" }}
{% endblock %}

{% block extra_js %}
    <script>
        (function() {
            function initForm() {
                const form = document.querySelector('form');
                if (form && !form.dataset.syncInitialized) {
                    form.dataset.syncInitialized = 'true';

                    // Helper to sync multiple language fields to a base field
                    function setupSync(baseId, fieldName) {
                        const languages = ['zh_hans', 'en', 'ja', 'zh_hant'];
                        const baseInput = document.getElementById(baseId);
                        if (!baseInput) return;

                        languages.forEach(lang => {
                            const inputId = `id_${fieldName}_${lang}`;
                            const input = document.getElementById(inputId);
                            if (input) {
                                // Sync on input
                                input.addEventListener('input', function() {
                                    if (this.value) {
                                        baseInput.value = this.value;
                                    } else {
                                        let foundValue = '';
                                        for (const otherLang of languages) {
                                            const otherInput = document.getElementById(`id_${fieldName}_${otherLang}`);
                                            if (otherInput && otherInput.value) {
                                                foundValue = otherInput.value;
                                                break;
                                            }
                                        }
                                        baseInput.value = foundValue;
                                    }
                                });
                                
                                // Initial sync
                                if (input.value && !baseInput.value) {
                                    baseInput.value = input.value;
                                }
                            }
                        });
                    }

                    setupSync('id_title', 'title');

                    form.addEventListener('submit', function(e) {
                        // Ensure base field has value
                        const baseInput = document.getElementById('id_title');
                        if (baseInput && !baseInput.value) {
                            const languages = ['zh_hans', 'en', 'ja', 'zh_hant'];
                            for (const lang of languages) {
                                const input = document.getElementById(`id_title_${lang}`);
                                if (input && input.value) {
                                    baseInput.value = input.value;
                                    break;
                                }
                            }
                        }
                    });
                }
            }

            // Initialize on page load
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initForm);
            } else {
                initForm();
            }

            // Initialize after HTMX swap (for SPA-like navigation)
            document.addEventListener('htmx:afterSwap', initForm);
        })();
    </script>
{% endblock %}

{% block content %}
<!-- Header -->
{% captureas header_actions %}
{% endcaptureas %}

{% trans "ç¼–è¾‘å¯¼èˆª" as default_title %}
{% include "administration/components/header.html" with title=title|default:default_title icon="menu_open" breadcrumbs=breadcrumbs actions=header_actions %}

<form method="post" enctype="multipart/form-data" class="grid grid-cols-1 lg:grid-cols-3 gap-6" novalidate>
    {% csrf_token %}
    
    <!-- Left Column: Main Content -->
    <div class="lg:col-span-2 space-y-6">
        {% captureas main_content %}
                {% if form.errors %}
                <div role="alert" class="alert border border-error/20 bg-error/5 text-error mb-4 shadow-sm">
                    <div class="flex items-start gap-4">
                        <span class="material-symbols-outlined pt-1">error</span>
                        <div class="w-full">
                            <span class="font-bold block mb-1">{% trans "è¡¨å•é”™è¯¯" %}</span>
                            <ul class="list-disc list-inside text-sm opacity-90">
                                {% for field in form %}
                                    {% for error in field.errors %}
                                        <li>{{ field.label }}: {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Multi-language Tabs -->
                <div x-data="translationForm" class="bg-base-100 border border-base-300 rounded-box overflow-hidden">
                    <!-- Tab Header -->
                    <div class="flex flex-wrap items-center justify-between gap-2 border-b border-base-200 bg-base-50/50 px-4 pt-2">
                        <div role="tablist" class="tabs tabs-bordered -mb-[1px]">
                            <a role="tab" class="tab h-10 px-4 transition-all duration-200"
                               :class="activeTab === 'zh-hans' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                               @click="activeTab = 'zh-hans'">
                                <span class="mr-2 text-lg">ğŸ‡¨ğŸ‡³</span>
                                {% trans "ä¸­æ–‡" %}
                            </a>
                            <a role="tab" class="tab h-10 px-4 transition-all duration-200"
                               :class="activeTab === 'en' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                               @click="activeTab = 'en'">
                                <span class="mr-2 text-lg">ğŸ‡ºğŸ‡¸</span>
                                English
                            </a>
                            <a role="tab" class="tab h-10 px-4 transition-all duration-200"
                               :class="activeTab === 'ja' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                               @click="activeTab = 'ja'">
                                <span class="mr-2 text-lg">ğŸ‡¯ğŸ‡µ</span>
                                æ—¥æœ¬èª
                            </a>
                            <a role="tab" class="tab h-10 px-4 transition-all duration-200"
                               :class="activeTab === 'zh-hant' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                               @click="activeTab = 'zh-hant'">
                                <span class="mr-2 text-lg">ğŸ‡­ğŸ‡°</span>
                                ç¹é«”ä¸­æ–‡
                            </a>
                        </div>

                        <!-- One-click Translate Button -->
                        <div class="mb-1">
                            <button type="button" 
                                    class="btn btn-sm btn-ghost gap-1.5 text-primary hover:bg-primary/10 transition-colors"
                                    @click="translate('id_title_zh_hans', {
                                        'en': 'id_title_en',
                                        'ja': 'id_title_ja',
                                        'zh-hant': 'id_title_zh_hant'
                                    })"
                                    :class="{'loading': isLoading}"
                                    title="{% trans 'è‡ªåŠ¨ç¿»è¯‘åˆ°å…¶ä»–è¯­è¨€' %}">
                                <span class="material-symbols-outlined text-[18px]" x-show="!isLoading">translate</span>
                                <span class="hidden sm:inline font-medium">{% trans "ä¸€é”®ç¿»è¯‘" %}</span>
                            </button>
                        </div>
                    </div>

                    <!-- Tab Content -->
                    <div class="p-6">
                        <!-- Zh-Hans Tab -->
                        <div x-show="activeTab === 'zh-hans'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-1" x-transition:enter-end="opacity-100 translate-y-0">
                            <div class="form-control w-full">
                                <label class="label">
                                    <span class="label-text font-bold text-base">{% trans "å¯¼èˆªæ ‡é¢˜ (ä¸­æ–‡)" %} <span class="text-error">*</span></span>
                                </label>
                                {% trans "è¾“å…¥å¯¼èˆªæ˜¾ç¤ºåç§° (ä¸­æ–‡)" as ph_zh %}
                                {% render_field form.title_zh_hans class="input input-bordered w-full focus:input-primary transition-all" placeholder=ph_zh %}
                                {% if form.title_zh_hans.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.title_zh_hans.errors.0 }}</span>
                                </label>
                                {% endif %}
                            </div>
                        </div>

                        <!-- English Tab -->
                        <div x-show="activeTab === 'en'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-1" x-transition:enter-end="opacity-100 translate-y-0" style="display: none;">
                            <div class="form-control w-full">
                                <label class="label">
                                    <span class="label-text font-bold text-base">{% trans "Navigation Title (English)" %}</span>
                                </label>
                                {% trans "Enter navigation title (English)" as ph_en %}
                                {% render_field form.title_en class="input input-bordered w-full focus:input-primary transition-all" placeholder=ph_en %}
                                {% if form.title_en.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.title_en.errors.0 }}</span>
                                </label>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Japanese Tab -->
                        <div x-show="activeTab === 'ja'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-1" x-transition:enter-end="opacity-100 translate-y-0" style="display: none;">
                            <div class="form-control w-full">
                                <label class="label">
                                    <span class="label-text font-bold text-base">{% trans "ã‚¿ã‚¤ãƒˆãƒ« (Japanese)" %}</span>
                                </label>
                                {% trans "ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ› (Japanese)" as ph_ja %}
                                {% render_field form.title_ja class="input input-bordered w-full focus:input-primary transition-all" placeholder=ph_ja %}
                            </div>
                        </div>

                        <!-- Zh-Hant Tab -->
                        <div x-show="activeTab === 'zh-hant'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-1" x-transition:enter-end="opacity-100 translate-y-0" style="display: none;">
                            <div class="form-control w-full">
                                <label class="label">
                                    <span class="label-text font-bold text-base">{% trans "æ¨™é¡Œ (Traditional Chinese)" %}</span>
                                </label>
                                {% trans "è¼¸å…¥æ¨™é¡Œ (ç¹é«”ä¸­æ–‡)" as ph_zh_hant %}
                                {% render_field form.title_zh_hant class="input input-bordered w-full focus:input-primary transition-all" placeholder=ph_zh_hant %}
                            </div>
                        </div>
                        <!-- Hidden inputs for content and base fields -->
                        <div class="hidden">
                            {{ form.title }} <!-- Base title -->
                        </div>
                    </div>
                </div>

                <!-- URL Field -->
                <div class="form-control w-full mt-4">
                    <label class="label">
                        <span class="label-text font-bold text-base">{% trans "é“¾æ¥åœ°å€ (URL)" %} <span class="text-error">*</span></span>
                    </label>
                    {% trans "è¾“å…¥é“¾æ¥åœ°å€ (å¦‚ /about/ æˆ– https://...)" as ph_url %}
                    {% render_field form.url class="input input-bordered w-full focus:input-primary transition-all font-mono" placeholder=ph_url %}
                    {% if form.url.errors %}
                    <label class="label">
                        <span class="label-text-alt text-error">{{ form.url.errors.0 }}</span>
                    </label>
                    {% endif %}
                </div>
        {% endcaptureas %}
        {% trans "åŸºæœ¬ä¿¡æ¯" as basic_info_title %}
        {% include "administration/components/form_card.html" with title=basic_info_title icon="menu_open" content=main_content %}
        
        <!-- Location & Order -->
        {% captureas config_content %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Location Field -->
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text font-medium">{% trans "æ˜¾ç¤ºä½ç½®" %}</span>
                        </label>
                        {% render_field form.location class="select select-bordered w-full focus:select-primary transition-all" %}
                        {% if form.location.errors %}
                        <label class="label">
                            <span class="label-text-alt text-error">{{ form.location.errors.0 }}</span>
                        </label>
                        {% endif %}
                    </div>

                    <!-- Order Field -->
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text font-medium">{% trans "æ’åºæƒé‡" %}</span>
                        </label>
                        {% render_field form.order class="input input-bordered w-full focus:input-primary transition-all" type="number" %}
                        <label class="label">
                            <span class="label-text-alt text-base-content/60">{% trans "æ•°å­—è¶Šå°è¶Šé å‰ (é»˜è®¤ 0)" %}</span>
                        </label>
                    </div>
                </div>
        {% endcaptureas %}
        {% trans "é…ç½®é€‰é¡¹" as config_title %}
        {% include "administration/components/form_card.html" with title=config_title icon="tune" content=config_content %}
    </div>

    <!-- Right Column: Sidebar -->
    <div class="lg:col-span-1 space-y-6">
        <!-- Publish Box -->
        {% captureas publish_content %}
                <div class="flex flex-col gap-3">
                    <button type="submit" class="btn btn-primary w-full gap-2 shadow-lg shadow-primary/20">
                        <span class="material-symbols-outlined">save</span>
                        {% trans "ä¿å­˜æ›´æ”¹" %}
                    </button>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button type="submit" name="_addanother" class="btn btn-sm btn-ghost border-base-300">{% trans "ä¿å­˜å¹¶æ–°å¢" %}</button>
                        <button type="submit" name="_continue" class="btn btn-sm btn-ghost border-base-300">{% trans "ä¿å­˜å¹¶ç»§ç»­" %}</button>
                    </div>

                    {% if object %}
                    <div class="divider my-1"></div>
                    <div class="flex justify-between items-center">
                        <a href="javascript:history.back()" class="btn btn-sm btn-ghost text-base-content/60">{% trans "å–æ¶ˆ" %}</a>
                        <button type="button" onclick="confirmDelete('{% url 'administration:navigation_delete' object.pk %}', '{% blocktrans with title=object.title|escapejs %}ç¡®å®šè¦åˆ é™¤å¯¼èˆªã€Š{{ title }}ã€‹å—ï¼Ÿ{% endblocktrans %}')" class="btn btn-sm btn-ghost text-error hover:bg-error/10">
                            {% trans "åˆ é™¤å¯¼èˆª" %}
                        </button>
                    </div>
                    {% else %}
                    <div class="divider my-1"></div>
                    <a href="javascript:history.back()" class="btn btn-sm btn-ghost text-base-content/60 w-full">{% trans "å–æ¶ˆ" %}</a>
                    {% endif %}
                </div>
        {% endcaptureas %}
        {% trans "å‘å¸ƒ" as pub_title %}
        {% include "administration/components/form_card.html" with title=pub_title icon="publish" content=publish_content %}

        <!-- Status Box -->
        {% captureas status_content %}
                <div class="form-control">
                    <label class="label cursor-pointer justify-between">
                        <span class="label-text font-medium">{% trans "å¯ç”¨æ˜¾ç¤º" %}</span>
                        {% render_field form.is_active class="toggle toggle-success" %}
                    </label>
                </div>

                <div class="divider my-2"></div>

                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text font-medium">{% trans "æ–°çª—å£æ‰“å¼€" %}</span>
                    </label>
                    <label class="label cursor-pointer justify-between">
                        <span class="label-text">{% trans "Open in new tab" %}</span>
                        {% render_field form.target_blank class="toggle toggle-primary" %}
                    </label>
                </div>
        {% endcaptureas %}
        {% trans "çŠ¶æ€è®¾ç½®" as status_title %}
        {% include "administration/components/form_card.html" with title=status_title icon="toggle_on" content=status_content %}
    </div>
</form>
{% endblock %}
