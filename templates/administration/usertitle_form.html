{% extends "administration/base.html" %}
{% load capture_tags widget_tweaks i18n %}
{% block title %}
    {% trans " - Rosetta Dashboard" as admin_suffix_default %}
    {% if form.instance.pk %}
        {% trans "ç¼–è¾‘ç§°å·" %}: {{ form.instance.name }}
    {% else %}
        {% trans "æ–°å»ºç§°å·" %}
    {% endif %}
    {{ config.SITE_ADMIN_SUFFIX|default:admin_suffix_default }}
{% endblock %}
{% block content %}
    <!-- Header -->
    {% captureas header_actions %}
{% endcaptureas %}
{% trans "ç¼–è¾‘ç§°å·" as default_title %}
{% include "administration/components/header.html" with title=title|default:default_title icon="badge" breadcrumbs=breadcrumbs actions=header_actions %}
<form method="post"
      class="grid grid-cols-1 lg:grid-cols-3 gap-6"
      novalidate
      x-data="{ ...translationForm(), name: '{{ form.name_zh_hans.value|default:form.name.value|default:''|escapejs }}', color: '{{ form.color.value|default:'#3B82F6' }}', iconCode: `{{ form.icon.value|default:''|escapejs }}`, description: '{{ form.description_zh_hans.value|default:form.description.value|default:''|escapejs }}', presets: [ { name: '{% trans "è®¤è¯ (Verified)" %}', code: '<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'currentColor\'><path fill-rule=\'evenodd\' d=\'M8.603 3.799A4.49 4.49 0 0112 2.25c1.357 0 2.573.6 3.397 1.549a4.49 4.49 0 013.498 1.307 4.491 4.491 0 011.307 3.497A4.49 4.49 0 0121.75 12a4.49 4.49 0 01-1.549 3.397 4.491 4.491 0 01-1.307 3.497 4.491 4.491 0 01-3.497 1.307A4.49 4.49 0 0112 21.75a4.49 4.49 0 01-3.397-1.549 4.49 4.49 0 01-3.498-1.306 4.491 4.491 0 01-1.307-3.498A4.49 4.49 0 012.25 12c0-1.357.6-2.573 1.549-3.397a4.49 4.49 0 011.307-3.497 4.491 4.491 0 013.497-1.307zm7.007 6.387a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z\' clip-rule=\'evenodd\' /></svg>' }, { name: '{% trans "æ˜Ÿæ˜Ÿ (Star)" %}', code: '<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'currentColor\'><path fill-rule=\'evenodd\' d=\'M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z\' clip-rule=\'evenodd\' /></svg>' }, { name: '{% trans "é—ªç”µ (Bolt)" %}', code: '<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'currentColor\'><path fill-rule=\'evenodd\' d=\'M14.615 1.595a.75.75 0 01.359.852L12.982 9.75h7.268a.75.75 0 01.548 1.262l-10.5 11.25a.75.75 0 01-1.272-.71l1.992-7.302H3.75a.75.75 0 01-.548-1.262l10.5-11.25a.75.75 0 01.913-.143z\' clip-rule=\'evenodd\' /></svg>' }, { name: '{% trans "å¿ƒå½¢ (Heart)" %}', code: '<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'currentColor\'><path d=\'M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z\' /></svg>' }, { name: '{% trans "ç›¾ç‰Œ (Shield)" %}', code: '<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'currentColor\'><path fill-rule=\'evenodd\' d=\'M12.516 2.17a.75.75 0 00-1.032 0 11.209 11.209 0 01-7.877 3.08.75.75 0 00-.722.515A12.74 12.74 0 002.25 9.75c0 5.942 4.064 10.933 9.563 12.348a.749.749 0 00.374 0c5.499-1.415 9.563-6.406 9.563-12.348 0-1.39-.223-2.73-.635-3.985a.75.75 0 00-.722-.516l-.143.001c-2.996 0-5.717-1.17-7.734-3.08zm3.094 8.016a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 11.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z\' clip-rule=\'evenodd\' /></svg>' }, { name: '{% trans "å¥–ç«  (Medal)" %}', code: '<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'currentColor\'><path fill-rule=\'evenodd\' d=\'M5.166 2.621v.858c-1.035.148-2.059.33-3.071.543a.75.75 0 00-.584.859 6.753 6.753 0 006.138 5.6 6.73 6.73 0 002.743 1.346A6.707 6.707 0 019.279 15H8.54c-1.036 0-1.875.84-1.875 1.875V19.5h-.75a2.25 2.25 0 00-2.25 2.25c0 .414.336.75.75.75h15a.75.75 0 00.75-.75 2.25 2.25 0 00-2.25-2.25h-.75v-2.625c0-1.036-.84-1.875-1.875-1.875h-.739a6.706 6.706 0 01-1.112-3.173 6.73 6.73 0 002.743-1.347 6.753 6.753 0 006.139-5.6.75.75 0 00-.585-.858 47.077 47.077 0 00-3.07-.543V2.62a.75.75 0 00-.658-.744 49.22 49.22 0 00-6.093-.377c-2.063 0-4.096.128-6.093.377a.75.75 0 00-.657.744zm0 2.629c0 1.196.312 2.32.857 3.294A5.266 5.266 0 013.16 5.337a45.6 45.6 0 012.006-.348zm7.92 7.289a5.207 5.207 0 01-2.086 0 5.207 5.207 0 01-2.086 0A6.72 6.72 0 017.382 11h9.236a6.72 6.72 0 01-1.532 1.54zM18.84 5.25a5.266 5.266 0 01.857-3.293c.685.11 1.353.226 2.006.348-.636 1.09-1.63 1.954-2.863 2.495zM12 16.5a.75.75 0 01.75.75v5.25H11.25v-5.25a.75.75 0 01.75-.75z\' clip-rule=\'evenodd\' /></svg>' }, { name: '{% trans "ç«ç„° (Fire)" %}', code: '<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'currentColor\'><path fill-rule=\'evenodd\' d=\'M12.963 2.286a.75.75 0 00-1.071-.136 9.742 9.742 0 00-3.539 6.177 7.547 7.547 0 01-1.705-1.715.75.75 0 00-1.152-.082A9 9 0 1015.68 4.534a7.46 7.46 0 01-2.717-2.248zM15.75 14.25a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z\' clip-rule=\'evenodd\' /></svg>' }, { name: '{% trans "é­”æ³• (Magic)" %}', code: '<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'currentColor\'><path fill-rule=\'evenodd\' d=\'M9 4.5a.75.75 0 01.721.544l.813 2.846a3.75 3.75 0 002.576 2.576l2.846.813a.75.75 0 010 1.442l-2.846.813a3.75 3.75 0 00-2.576 2.576l-.813 2.846a.75.75 0 01-1.442 0l-.813-2.846a3.75 3.75 0 00-2.576-2.576l-2.846-.813a.75.75 0 010-1.442l2.846-.813A3.75 3.75 0 007.466 7.89l.813-2.846A.75.75 0 019 4.5zM18 1.5a.75.75 0 01.728.568l.258 1.036c.236.94.97 1.674 1.91 1.91l1.036.258a.75.75 0 010 1.456l-1.036.258c-.94.236-1.674.97-1.91 1.91l-.258 1.036a.75.75 0 01-1.456 0l-.258-1.036a2.625 2.625 0 00-1.91-1.91l-1.036-.258a.75.75 0 010-1.456l1.036-.258a2.625 2.625 0 001.91-1.91l.258-1.036A.75.75 0 0118 1.5zM16.5 15a.75.75 0 01.712.513l.394 1.183c.15.447.5.799.948.948l1.183.395a.75.75 0 010 1.422l-1.183.395c-.447.15-.799.5-.948.948l-.395 1.183a.75.75 0 01-1.422 0l-.395-1.183a1.5 1.5 0 00-.948-.948l-1.183-.395a.75.75 0 010-1.422l1.183-.395c.447-.15.799-.5.948-.948l.395-1.183A.75.75 0 0116.5 15z\' clip-rule=\'evenodd\' /></svg>' }, { name: '{% trans "ç”¨æˆ· (User)" %}', code: '<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'currentColor\'><path fill-rule=\'evenodd\' d=\'M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.437.695A18.683 18.683 0 0112 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 01-.437-.695z\' clip-rule=\'evenodd\' /></svg>' }, { name: '{% trans "ä»£ç  (Code)" %}', code: '<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'currentColor\'><path fill-rule=\'evenodd\' d=\'M14.447 3.026a.75.75 0 01.527.921l-4.5 16.5a.75.75 0 01-1.448-.394l4.5-16.5a.75.75 0 01.921-.527zM16.72 6.22a.75.75 0 011.06 0l5.25 5.25a.75.75 0 010 1.06l-5.25 5.25a.75.75 0 11-1.06-1.06L21.44 12l-4.72-4.72a.75.75 0 010-1.06zm-9.44 0a.75.75 0 010 1.06L2.56 12l4.72 4.72a.75.75 0 11-1.06 1.06L.97 12.53a.75.75 0 010-1.06l5.25-5.25a.75.75 0 011.06 0z\' clip-rule=\'evenodd\' /></svg>' }, { name: '{% trans "å­¦è€… (Scholar)" %}', code: '<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'currentColor\'><path d=\'M11.7 2.805a.75.75 0 01.6 0A60.65 60.65 0 0122.83 8.72a.75.75 0 01-.231 1.337 49.949 49.949 0 00-9.902 3.912l-.003.002-.34.18a.75.75 0 01-.707 0A50.009 50.009 0 001.402 10.06a.75.75 0 01-.231-1.337A60.653 60.653 0 0111.7 2.805z\' /><path d=\'M13.06 15.473a48.45 48.45 0 017.666-3.282c.134 1.414.22 2.843.255 4.285a.75.75 0 01-.46.71 47.878 47.878 0 00-5.8 2.812.75.75 0 01-.87 0 47.878 47.878 0 00-5.8-2.812.75.75 0 01-.46-.71c.035-1.442.121-2.87.255-4.286A48.4 48.4 0 0113.06 15.473zM4.75 11c0 2.158.385 4.235 1.102 6.148a.75.75 0 01-1.402.52A14.902 14.902 0 013.25 11a.75.75 0 011.5 0z\' /></svg>' }, { name: '{% trans "æƒ³æ³• (Idea)" %}', code: '<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'currentColor\'><path d=\'M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 .75.75 0 001.5 0 6 6 0 10-12 0 .75.75 0 001.5 0zM5.85 3.5a.75.75 0 01.53 1.28l-1.5 1.5a.75.75 0 11-1.06-1.06l1.5-1.5a.75.75 0 011.28-.22zm11.25.75a.75.75 0 011.06 0l1.5 1.5a.75.75 0 11-1.06 1.06l-1.5-1.5a.75.75 0 010-1.06zM15 12a3 3 0 11-6 0 3 3 0 016 0zM9.75 19.5a.75.75 0 01.75.75v.75a.75.75 0 00.75.75h1.5a.75.75 0 00.75-.75v-.75a.75.75 0 011.5 0v.75A2.25 2.25 0 0112.75 24h-1.5A2.25 2.25 0 019 21.75v-.75a.75.75 0 01.75-.75z\' /></svg>' }, ] }">
    {% csrf_token %}
    <!-- Left Column: Form -->
    <div class="lg:col-span-2 space-y-6">
        {% captureas main_content %}
        {% if form.non_field_errors %}
            <div class="alert alert-error mb-4">
                <span class="material-symbols-outlined">error</span>
                <div>
                    {% for error in form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
                </div>
            </div>
        {% endif %}
        <!-- Multi-language Tabs -->
        <div class="bg-base-100 border border-base-300 rounded-box overflow-hidden mb-6">
            <!-- Tab Header -->
            <div class="flex flex-wrap items-center justify-between gap-2 border-b border-base-200 bg-base-50/50 px-4 pt-2">
                <div role="tablist" class="tabs tabs-bordered -mb-[1px]">
                    <a role="tab"
                       class="tab h-10 px-4 transition-all duration-200"
                       :class="activeTab === 'zh-hans' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                       @click="activeTab = 'zh-hans'">
                        <span class="mr-2 text-lg">ğŸ‡¨ğŸ‡³</span>
                        {% trans "ä¸­æ–‡" %}
                    </a>
                    <a role="tab"
                       class="tab h-10 px-4 transition-all duration-200"
                       :class="activeTab === 'en' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                       @click="activeTab = 'en'">
                        <span class="mr-2 text-lg">ğŸ‡ºğŸ‡¸</span>
                        {% trans "English" %}
                    </a>
                    <a role="tab"
                       class="tab h-10 px-4 transition-all duration-200"
                       :class="activeTab === 'ja' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                       @click="activeTab = 'ja'">
                        <span class="mr-2 text-lg">ğŸ‡¯ğŸ‡µ</span>
                        {% trans "æ—¥æœ¬èª" %}
                    </a>
                    <a role="tab"
                       class="tab h-10 px-4 transition-all duration-200"
                       :class="activeTab === 'zh-hant' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                       @click="activeTab = 'zh-hant'">
                        <span class="mr-2 text-lg">ğŸ‡­ğŸ‡°</span>
                        {% trans "ç¹é«”ä¸­æ–‡" %}
                    </a>
                </div>
                <!-- One-click Translate Button -->
                <div class="mb-1">
                    <button type="button"
                            class="btn btn-sm btn-ghost gap-1.5 text-primary hover:bg-primary/10 transition-colors"
                            @click="translate('id_name_zh_hans', { 'en': 'id_name_en', 'ja': 'id_name_ja', 'zh-hant': 'id_name_zh_hant' }); translate('id_description_zh_hans', { 'en': 'id_description_en', 'ja': 'id_description_ja', 'zh-hant': 'id_description_zh_hant' })"
                            :class="{'loading': isLoading}"
                            title="{% trans 'è‡ªåŠ¨ç¿»è¯‘åˆ°å…¶ä»–è¯­è¨€' %}">
                        <span class="material-symbols-outlined text-[18px]" x-show="!isLoading">translate</span>
                        <span class="hidden sm:inline font-medium">{% trans "ä¸€é”®ç¿»è¯‘" %}</span>
                    </button>
                </div>
            </div>
            <!-- Tab Content -->
            <div class="p-6">
                <!-- Zh-Hans Tab -->
                <div x-show="activeTab === 'zh-hans'">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text font-medium">{% trans "ç§°å·åç§° (ä¸­æ–‡)" %}</span>
                        </label>
                        {% trans "ä¾‹å¦‚ï¼šVIP" as ph_name %}
                        {% render_field form.name_zh_hans class="input input-bordered w-full" x-model="name" placeholder=ph_name %}
                        {% if form.name_zh_hans.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.name_zh_hans.errors.0 }}</span>
                            </label>
                        {% endif %}
                    </div>
                    <div class="form-control w-full mt-4">
                        <label class="label">
                            <span class="label-text font-medium">{% trans "ç§°å·è¯´æ˜ (ä¸­æ–‡)" %}</span>
                        </label>
                        {% trans "ç®€çŸ­æè¿°è¯¥ç§°å·çš„è·å–æ¡ä»¶æˆ–å«ä¹‰" as ph_desc %}
                        {% render_field form.description_zh_hans class="input input-bordered w-full" x-model="description" placeholder=ph_desc %}
                        {% if form.description_zh_hans.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.description_zh_hans.errors.0 }}</span>
                            </label>
                        {% endif %}
                    </div>
                </div>
                <!-- English Tab -->
                <div x-show="activeTab === 'en'" style="display: none;">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text font-medium">{% trans "Name (English)" %}</span>
                        </label>
                        {% render_field form.name_en class="input input-bordered w-full" %}
                    </div>
                    <div class="form-control w-full mt-4">
                        <label class="label">
                            <span class="label-text font-medium">{% trans "Description (English)" %}</span>
                        </label>
                        {% render_field form.description_en class="input input-bordered w-full" %}
                    </div>
                </div>
                <!-- Japanese Tab -->
                <div x-show="activeTab === 'ja'" style="display: none;">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text font-medium">{% trans "åç§° ({% trans "æ—¥æœ¬èª" %})" %}</span>
                        </label>
                        {% render_field form.name_ja class="input input-bordered w-full" %}
                    </div>
                    <div class="form-control w-full mt-4">
                        <label class="label">
                            <span class="label-text font-medium">{% trans "èª¬æ˜ ({% trans "æ—¥æœ¬èª" %})" %}</span>
                        </label>
                        {% render_field form.description_ja class="input input-bordered w-full" %}
                    </div>
                </div>
                <!-- Zh-Hant Tab -->
                <div x-show="activeTab === 'zh-hant'" style="display: none;">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text font-medium">{% trans "åç¨± ({% trans "ç¹é«”ä¸­æ–‡" %})" %}</span>
                        </label>
                        {% render_field form.name_zh_hant class="input input-bordered w-full" %}
                    </div>
                    <div class="form-control w-full mt-4">
                        <label class="label">
                            <span class="label-text font-medium">{% trans "èªªæ˜ ({% trans "ç¹é«”ä¸­æ–‡" %})" %}</span>
                        </label>
                        {% render_field form.description_zh_hant class="input input-bordered w-full" %}
                    </div>
                </div>
            </div>
        </div>
        <!-- Hidden base fields if needed, or rely on modeltranslation behavior -->
        <div class="hidden">
            {{ form.name }}
            {{ form.description }}
        </div>
        <!-- Color -->
        <div class="form-control w-full">
            <label class="label">
                <span class="label-text font-medium">{% trans "é¢œè‰²é£æ ¼" %}</span>
            </label>
            {% include 'components/color_picker.html' with value=form.color.value name=form.color.name %}
            <label class="label">
                <span class="label-text-alt text-base-content/60">{% trans "é€‰æ‹©ä¸€ä¸ªé†’ç›®çš„é¢œè‰²æ¥åŒºåˆ†ä¸åŒç±»å‹çš„ç§°å·" %}</span>
            </label>
            {% if form.color.errors %}
                <label class="label">
                    <span class="label-text-alt text-error">{{ form.color.errors.0 }}</span>
                </label>
            {% endif %}
        </div>
    {% endcaptureas %}
    {% trans "åŸºæœ¬ä¿¡æ¯" as basic_info_title %}
    {% include "administration/components/form_card.html" with title=basic_info_title icon="badge" content=main_content %}
    <!-- Icon Settings -->
    {% captureas icon_content %}
    <!-- Icon Presets -->
    <div class="form-control w-full mb-4">
        <label class="label">
            <span class="label-text font-medium">{% trans "é¢„è®¾å›¾æ ‡" %}</span>
        </label>
        <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-2">
            <template x-for="preset in presets" :key="preset.name">
                <button type="button"
                        @click="iconCode = preset.code"
                        class="btn btn-square btn-outline btn-sm h-10 w-10 p-2 hover:btn-primary transition-all"
                        :class="{'btn-primary': iconCode === preset.code}"
                        :title="preset.name">
                    <span class="w-full h-full flex items-center justify-center [&>svg]:w-full [&>svg]:h-full"
                          x-html="preset.code"></span>
                </button>
            </template>
        </div>
    </div>
    <!-- Custom Icon Code -->
    <div class="form-control w-full">
        <label class="label">
            <span class="label-text font-medium">{% trans "è‡ªå®šä¹‰ SVG ä»£ç " %}</span>
            <span class="label-text-alt text-base-content/50">{% trans "æ¨èå°ºå¯¸ 24x24" %}</span>
        </label>
        {% render_field form.icon class="textarea textarea-bordered font-mono text-xs h-32" x-model="iconCode" placeholder="<svg ...>" %}
        {% if form.icon.errors %}
            <label class="label">
                <span class="label-text-alt text-error">{{ form.icon.errors.0 }}</span>
            </label>
        {% endif %}
    </div>
{% endcaptureas %}
{% trans "å›¾æ ‡è®¾ç½®" as icon_title %}
{% include "administration/components/form_card.html" with title=icon_title icon="extension" content=icon_content %}
</div>
<!-- Right Column: Sidebar -->
<div class="lg:col-span-1 space-y-6">
    <!-- Publish Box -->
    {% captureas publish_content %}
    <div class="flex flex-col gap-3">
        <button type="submit"
                class="btn btn-primary w-full gap-2 shadow-lg shadow-primary/20">
            <span class="material-symbols-outlined">save</span>
            {% trans "ä¿å­˜æ›´æ”¹" %}
        </button>
        <a href="{% url 'administration:usertitle_list' %}"
           class="btn btn-ghost w-full">{% trans "å–æ¶ˆ" %}</a>
    </div>
    <div class="divider my-4">{% trans "é¢„è§ˆ" %}</div>
    <div class="flex flex-col items-center gap-4 p-4 bg-base-200/50 rounded-lg border border-base-content/5">
        <div class="text-xs font-mono opacity-50 mb-1">{% trans "Badge Preview" %}</div>
        <!-- Updated Preview Logic for Hex Colors -->
        <span class="badge badge-lg gap-2 shadow-sm"
              :class="color.startsWith('#') ? 'badge-outline' : 'badge-' + color"
              :style="color.startsWith('#') ? 'background-color: ' + color + '; color: white; border-color: ' + color : ''">
            <template x-if="iconCode">
                <span class="w-4 h-4 flex items-center justify-center [&>svg]:w-full [&>svg]:h-full"
                      x-html="iconCode"></span>
            </template>
            <span x-text="name || '{% trans "ç§°å·åç§°" %}'"></span>
        </span>
        <div class="text-xs text-center mt-2 opacity-60"
             x-text="description || '{% trans "æš‚æ— æè¿°" %}'"></div>
    </div>
{% endcaptureas %}
{% trans "æ“ä½œ" as op_title %}
{% include "administration/components/form_card.html" with title=op_title icon="settings" content=publish_content %}
</div>
</form>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        const languages = ['zh_hans', 'en', 'ja', 'zh_hant'];

        // Helper to sync multiple language fields to a base field
        function setupSync(baseId, fieldName) {
            const baseInput = document.getElementById(baseId);
            if (!baseInput) return;

            languages.forEach(lang => {
                const inputId = `id_${fieldName}_${lang}`;
                const input = document.getElementById(inputId);
                if (input) {
                    // Sync on input
                    input.addEventListener('input', function() {
                        if (this.value) {
                            baseInput.value = this.value;
                        } else {
                            let foundValue = '';
                            for (const otherLang of languages) {
                                const otherInput = document.getElementById(`id_${fieldName}_${otherLang}`);
                                if (otherInput && otherInput.value) {
                                    foundValue = otherInput.value;
                                    break;
                                }
                            }
                            baseInput.value = foundValue;
                        }
                    });
                    
                    // Initial sync
                    if (input.value && !baseInput.value) {
                        baseInput.value = input.value;
                    }
                }
            });
        }

        setupSync('id_name', 'name');
        setupSync('id_description', 'description');

        form.addEventListener('submit', function(e) {
            // Final check for base fields
            function ensureValue(baseId, fieldName) {
                const baseInput = document.getElementById(baseId);
                if (baseInput && !baseInput.value) {
                    for (const lang of languages) {
                        const input = document.getElementById(`id_${fieldName}_${lang}`);
                        if (input && input.value) {
                            baseInput.value = input.value;
                            break;
                        }
                    }
                }
            }
            ensureValue('id_name', 'name');
            ensureValue('id_description', 'description');
        });
    });
</script>
{% endblock %}
{% block extra_js %}
    <script>
document.addEventListener('alpine:init', () => {
    Alpine.data('translationForm', () => ({
        loadingCount: 0,
        get isLoading() { return this.loadingCount > 0; },
        activeTab: 'zh-hans',
        
        async translate(sourceId, mapping) {
            // mapping: { 'en': 'target_id_en', 'ja': 'target_id_ja', 'zh-hant': 'target_id_zh_hant' }
            const sourceEl = document.getElementById(sourceId);
            if (!sourceEl || !sourceEl.value.trim()) {
                if (sourceId.includes('title') && (!sourceEl || !sourceEl.value.trim())) {
                     if (window.showToast) window.showToast('{% trans "è¯·å…ˆè¾“å…¥ä¸­æ–‡å†…å®¹" %}', 'warning');
                }
                return;
            }
            
            this.loadingCount++;
            const text = sourceEl.value;
            const targetLangs = Object.keys(mapping);
            
            try {
                // Get CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                const response = await fetch('/api/translate/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        text: text,
                        target_langs: targetLangs
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.translations) {
                    let successCount = 0;
                    Object.entries(data.translations).forEach(([lang, translatedText]) => {
                        const targetId = mapping[lang];
                        const targetEl = document.getElementById(targetId);
                        if (targetEl) {
                            // Only update if empty or if user wants to overwrite (current logic: overwrite)
                            targetEl.value = translatedText;
                            targetEl.dispatchEvent(new Event('input'));
                            targetEl.dispatchEvent(new Event('change'));
                            successCount++;
                        }
                    });
                    
                    if (window.showToast && successCount > 0) window.showToast(`{% trans "æˆåŠŸç¿»è¯‘" %} ${successCount} {% trans "ä¸ªè¯­è¨€å­—æ®µ" %}`, 'success');
                } else if (data.error) {
                    console.error('Translation error:', data.error);
                    if (window.showToast) window.showToast('{% trans "ç¿»è¯‘å¤±è´¥" %}: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Network error:', error);
                if (window.showToast) window.showToast('{% trans "ç½‘ç»œé”™è¯¯" %}: ' + error.message, 'error');
            } finally {
                this.loadingCount--;
            }
        }
    }));
});
    </script>
{% endblock %}
