{% extends "administration/base.html" %}
{% load capture_tags static widget_tweaks i18n %}

{% block title %}
{% trans "ç¼–è¾‘é¡µé¢" as default_title %}
{{ title|default:default_title }}{{ config.SITE_ADMIN_SUFFIX|default:" - Rosetta Dashboard" }}
{% endblock %}

{% block extra_head %}
<!-- ByteMD æ ·å¼ç”± js/editor.js åŠ¨æ€æ³¨å…¥å’Œç®¡ç† -->
{% endblock %}

{% block content %}
<!-- Header -->
{% captureas header_actions %}
{% endcaptureas %}

{% trans "ç¼–è¾‘é¡µé¢" as default_title %}
{% include "administration/components/header.html" with title=title|default:default_title icon="edit_note" breadcrumbs=breadcrumbs actions=header_actions %}

<form method="post" enctype="multipart/form-data" class="w-full" novalidate>
    {% csrf_token %}
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 items-start">
        <!-- Main Content (Left Column - 75%) -->
        <div class="lg:col-span-3 space-y-6">
            {% captureas main_form_content %}
            <div x-data="translationForm">
            <!-- Multi-language Tabs -->
            <div class="bg-base-100 border border-base-300 rounded-box overflow-hidden">
                <!-- Tab Header -->
                <div class="flex flex-wrap items-center justify-between gap-2 border-b border-base-200 bg-base-50/50 px-4 pt-2">
                    <div role="tablist" class="tabs tabs-bordered -mb-[1px]">
                        <a role="tab" class="tab h-10 px-4 transition-all duration-200"
                           :class="activeTab === 'zh-hans' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                           @click="activeTab = 'zh-hans'">
                            <span class="mr-2 text-lg">ğŸ‡¨ğŸ‡³</span>
                            {% trans "ä¸­æ–‡" %}
                        </a>
                        <a role="tab" class="tab h-10 px-4 transition-all duration-200"
                           :class="activeTab === 'en' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                           @click="activeTab = 'en'">
                            <span class="mr-2 text-lg">ğŸ‡ºğŸ‡¸</span>
                            English
                        </a>
                        <a role="tab" class="tab h-10 px-4 transition-all duration-200"
                           :class="activeTab === 'ja' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                           @click="activeTab = 'ja'">
                            <span class="mr-2 text-lg">ğŸ‡¯ğŸ‡µ</span>
                            æ—¥æœ¬èª
                        </a>
                        <a role="tab" class="tab h-10 px-4 transition-all duration-200"
                           :class="activeTab === 'zh-hant' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                           @click="activeTab = 'zh-hant'">
                            <span class="mr-2 text-lg">ğŸ‡­ğŸ‡°</span>
                            ç¹é«”ä¸­æ–‡
                        </a>
                    </div>

                    <!-- One-click Translate Button -->
                    <div class="mb-1">
                        <button type="button" 
                                class="btn btn-sm btn-ghost gap-1.5 text-primary hover:bg-primary/10 transition-colors"
                                @click="translate('id_title_zh_hans', {
                                    'en': 'id_title_en',
                                    'ja': 'id_title_ja',
                                    'zh-hant': 'id_title_zh_hant'
                                })"
                                :class="{'loading': isLoading}"
                                title="{% trans 'è‡ªåŠ¨ç¿»è¯‘åˆ°å…¶ä»–è¯­è¨€' %}">
                            <span class="material-symbols-outlined text-[18px]" x-show="!isLoading">translate</span>
                            <span class="hidden sm:inline font-medium">{% trans "ä¸€é”®ç¿»è¯‘" %}</span>
                        </button>
                    </div>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                    <!-- Zh-Hans Tab -->
                    <div x-show="activeTab === 'zh-hans'">
                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text font-bold text-lg">{% trans "é¡µé¢æ ‡é¢˜ (ä¸­æ–‡)" %}</span>
                            </label>
                            {% trans "è¾“å…¥é¡µé¢æ ‡é¢˜ (ä¸­æ–‡)" as ph_title_zh %}
                            {% render_field form.title_zh_hans class="input input-bordered w-full focus:input-primary transition-all text-lg font-bold" placeholder=ph_title_zh %}
                            {% if form.title_zh_hans.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.title_zh_hans.errors.0 }}</span>
                            </label>
                            {% endif %}
                        </div>
                    </div>

                    <!-- English Tab -->
                    <div x-show="activeTab === 'en'" style="display: none;">
                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text font-bold text-lg">{% trans "Page Title (English)" %}</span>
                            </label>
                            {% trans "Enter page title (English)" as ph_title_en %}
                            {% render_field form.title_en class="input input-bordered w-full focus:input-primary transition-all text-lg font-bold" placeholder=ph_title_en %}
                        </div>
                    </div>

                    <!-- Japanese Tab -->
                    <div x-show="activeTab === 'ja'" style="display: none;">
                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text font-bold text-lg">{% trans "ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ« (Japanese)" %}</span>
                            </label>
                            {% trans "ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ› (Japanese)" as ph_title_ja %}
                            {% render_field form.title_ja class="input input-bordered w-full focus:input-primary transition-all text-lg font-bold" placeholder=ph_title_ja %}
                        </div>
                    </div>

                    <!-- Zh-Hant Tab -->
                    <div x-show="activeTab === 'zh-hant'" style="display: none;">
                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text font-bold text-lg">{% trans "é é¢æ¨™é¡Œ (Traditional Chinese)" %}</span>
                            </label>
                            {% trans "è¼¸å…¥é é¢æ¨™é¡Œ (ç¹é«”ä¸­æ–‡)" as ph_title_zh_hant %}
                            {% render_field form.title_zh_hant class="input input-bordered w-full focus:input-primary transition-all text-lg font-bold" placeholder=ph_title_zh_hant %}
                        </div>
                    </div>
                </div>
            </div>
                
            <div class="form-control w-full mt-4"
                 x-init="$watch('activeTab', (value, oldValue) => {
                     // Save old content
                     if (window.bytemdEditor && oldValue) {
                         const oldInput = document.getElementById('id_content_' + oldValue.replace('-', '_'));
                         if (oldInput) {
                             oldInput.value = window.bytemdEditor.getValue();
                         }
                     }
                     // Load new content
                     if (window.bytemdEditor && value) {
                         const newInputId = 'id_content_' + value.replace('-', '_');
                         const newInput = document.getElementById(newInputId);
                         if (newInput) {
                             window.bytemdEditor.setValue(newInput.value);
                             // Update the target input for real-time syncing
                             if (window.bytemdEditor.setTargetInput) {
                                 window.bytemdEditor.setTargetInput(newInputId);
                             }
                         }
                     }
                 })">
                <label class="label flex justify-between items-center">
                    <span class="label-text font-bold">
                        <span x-text="{'zh-hans': '{% trans "å†…å®¹ (ä¸­æ–‡)" %}', 'en': '{% trans "Content (English)" %}', 'ja': '{% trans "å†…å®¹ (Japanese)" %}', 'zh-hant': '{% trans "å…§å®¹ (Traditional Chinese)" %}'}[activeTab]"></span>
                    </span>
                </label>
                
                <div id="editor" class="bg-base-100 border border-base-200 rounded-lg overflow-hidden min-h-[500px]"></div>

                <div class="hidden">
                    {{ form.title }} <!-- Base title -->
                    {{ form.content }}
                    {{ form.content_zh_hans }}
                    {{ form.content_en }}
                    {{ form.content_ja }}
                    {{ form.content_zh_hant }}
                </div>

                {% if form.content.errors %}
                <label class="label">
                    <span class="label-text-alt text-error">{{ form.content.errors.0 }}</span>
                </label>
                {% endif %}
            </div>
            </div>
            {% endcaptureas %}
            {% include "administration/components/form_card.html" with content=main_form_content %}
        </div>

        <!-- Sidebar (Right Column - 25%) -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Publish Box -->
            {% captureas publish_content %}
                <div class="flex flex-col gap-3">
                    <button type="submit" class="btn btn-primary w-full gap-2 shadow-lg shadow-primary/20">
                        <span class="material-symbols-outlined">save</span>
                        {% trans "ä¿å­˜é¡µé¢" %}
                    </button>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button type="submit" name="_addanother" class="btn btn-sm btn-ghost border-base-300">{% trans "ä¿å­˜å¹¶æ–°å¢" %}</button>
                        <button type="submit" name="_continue" class="btn btn-sm btn-ghost border-base-300">{% trans "ä¿å­˜å¹¶ç»§ç»­" %}</button>
                    </div>

                    {% if object %}
                    <div class="divider my-1"></div>
                    <div class="flex justify-between items-center">
                        <a href="javascript:history.back()" class="btn btn-sm btn-ghost text-base-content/60">{% trans "å–æ¶ˆ" %}</a>
                        <button type="button" onclick="confirmDelete('{% url 'administration:page_delete' object.pk %}', '{% blocktrans with title=object.title|escapejs %}ç¡®å®šè¦åˆ é™¤é¡µé¢ã€Š{{ title }}ã€‹å—ï¼Ÿ{% endblocktrans %}')" class="btn btn-sm btn-ghost text-error hover:bg-error/10">
                            {% trans "åˆ é™¤é¡µé¢" %}
                        </button>
                    </div>
                    {% else %}
                    <div class="divider my-1"></div>
                    <a href="javascript:history.back()" class="btn btn-sm btn-ghost text-base-content/60 w-full">{% trans "å–æ¶ˆ" %}</a>
                    {% endif %}
                </div>
            {% endcaptureas %}
            {% trans "å‘å¸ƒ" as pub_title %}
            {% include "administration/components/form_card.html" with title=pub_title icon="publish" content=publish_content %}

            <!-- Meta Box -->
            {% captureas meta_content %}
                <!-- Slug Field -->
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text font-medium">{% trans "åˆ«å (Slug)" %}</span>
                    </label>
                    {% trans "è¾“å…¥URLåˆ«å" as ph_slug %}
                    {% render_field form.slug class="input input-bordered w-full focus:input-primary transition-all font-mono text-sm" placeholder=ph_slug %}
                    {% if form.slug.errors %}
                    <label class="label">
                        <span class="label-text-alt text-error">{{ form.slug.errors.0 }}</span>
                    </label>
                    {% endif %}
                </div>

                <!-- Status Field -->
                <div class="form-control w-full mt-2">
                    <label class="label">
                        <span class="label-text font-medium">{% trans "çŠ¶æ€" %}</span>
                    </label>
                    {% render_field form.status class="select select-bordered w-full focus:select-primary transition-all" %}
                    {% if form.status.errors %}
                    <label class="label">
                        <span class="label-text-alt text-error">{{ form.status.errors.0 }}</span>
                    </label>
                    {% endif %}
                </div>
            {% endcaptureas %}
            {% trans "é¡µé¢å±æ€§" as meta_title %}
            {% include "administration/components/form_card.html" with title=meta_title icon="settings" content=meta_content %}
            
            {% if object %}
                {% captureas info_content %}
                    <div class="text-xs space-y-2 opacity-70">
                        <div class="flex justify-between">
                            <span>{% trans "åˆ›å»ºäº:" %}</span>
                            <span class="font-mono">{{ object.created_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>{% trans "æ›´æ–°äº:" %}</span>
                            <span class="font-mono">{{ object.updated_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        <div class="pt-2 text-center">
                            <a href="/{{ object.slug }}/" target="_blank" class="link link-primary no-underline hover:underline flex items-center justify-center gap-1">
                                <span class="material-symbols-outlined text-xs">open_in_new</span>
                                {% trans "æŸ¥çœ‹é¡µé¢" %}
                            </a>
                        </div>
                    </div>
                {% endcaptureas %}
                {% trans "ä¿¡æ¯" as info_title %}
                {% include "administration/components/form_card.html" with title=info_title icon="info" content=info_content %}
            {% endif %}
        </div>
    </div>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        const languages = ['zh_hans', 'en', 'ja', 'zh_hant'];

        // Helper to sync multiple language fields to a base field
        function setupSync(baseId, fieldName) {
            const baseInput = document.getElementById(baseId);
            if (!baseInput) return;

            languages.forEach(lang => {
                const inputId = `id_${fieldName}_${lang}`;
                const input = document.getElementById(inputId);
                if (input) {
                    // Sync on input
                    input.addEventListener('input', function() {
                        if (this.value) {
                            baseInput.value = this.value;
                        } else {
                            let foundValue = '';
                            for (const otherLang of languages) {
                                const otherInput = document.getElementById(`id_${fieldName}_${otherLang}`);
                                if (otherInput && otherInput.value) {
                                    foundValue = otherInput.value;
                                    break;
                                }
                            }
                            baseInput.value = foundValue;
                        }
                    });
                    
                    // Initial sync
                    if (input.value && !baseInput.value) {
                        baseInput.value = input.value;
                    }
                }
            });
        }

        setupSync('id_title', 'title');

        form.addEventListener('submit', function(e) {
            // Handle Editor Content
            if (window.bytemdEditor) {
                const value = window.bytemdEditor.getValue();
                // Get the currently active tab's language code from Alpine data
                const alpineEl = document.querySelector('[x-data="translationForm"]');
                if (alpineEl && alpineEl._x_dataStack) {
                    const activeTab = alpineEl._x_dataStack[0].activeTab;
                    
                    // Construct the input ID based on the active tab
                    const inputId = 'id_content_' + activeTab.replace('-', '_');
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.value = value;
                    }
                }
            }

            // Final check for base fields (Title and Content)
            function ensureValue(baseId, fieldName) {
                const baseInput = document.getElementById(baseId);
                if (baseInput && !baseInput.value) {
                    for (const lang of languages) {
                        const input = document.getElementById(`id_${fieldName}_${lang}`);
                        if (input && input.value) {
                            baseInput.value = input.value;
                            break;
                        }
                    }
                }
            }
            ensureValue('id_title', 'title');
            ensureValue('id_content', 'content');
        });
    });
</script>
{% endblock %}
