{% extends "administration/base.html" %}
{% load capture_tags widget_tweaks i18n %}
{% block title %}
    {% trans " - Rosetta Dashboard" as admin_suffix_default %}{{ title }}{{ config.SITE_ADMIN_SUFFIX|default:admin_suffix_default }}
{% endblock %}
{% block modal %}{% endblock %}
{% block extra_js %}
    <script>
        (function() {
            function initForm() {
                const form = document.querySelector('form');
                if (form && !form.dataset.syncInitialized) {
                    form.dataset.syncInitialized = 'true';

                    // Helper to sync multiple language fields to a base field
                    function setupSync(baseId, fieldName) {
                        const languages = ['zh_hans', 'en', 'ja', 'zh_hant'];
                        const baseInput = document.getElementById(baseId);
                        if (!baseInput) return;

                        languages.forEach(lang => {
                            const inputId = `id_${fieldName}_${lang}`;
                            const input = document.getElementById(inputId);
                            if (input) {
                                // Sync on input
                                input.addEventListener('input', function() {
                                    if (this.value) {
                                        // If user types something, sync it immediately
                                        baseInput.value = this.value;
                                    } else {
                                        // If user clears the input, try to find another language value
                                        // to ensure base field is not empty
                                        let foundValue = '';
                                        // Try other languages
                                        for (const otherLang of languages) {
                                            const otherInput = document.getElementById(`id_${fieldName}_${otherLang}`);
                                            if (otherInput && otherInput.value) {
                                                foundValue = otherInput.value;
                                                break;
                                            }
                                        }
                                        baseInput.value = foundValue;
                                    }
                                });
                                
                                // Initial sync: if base is empty, try to find a value
                                if (input.value && !baseInput.value) {
                                    baseInput.value = input.value;
                                }
                            }
                        });
                    }

                    setupSync('id_name', 'name');
                    setupSync('id_description', 'description');

                    form.addEventListener('submit', function(e) {
                        // Final check: ensure base fields have *some* value if possible
                        function ensureValue(baseId, fieldName) {
                            const baseInput = document.getElementById(baseId);
                            // If base input is empty, try to fill it from any available translation
                            // Priority: Current Active Tab -> zh-hans -> en -> others
                            if (baseInput && !baseInput.value) {
                                // Try to find the active tab first (if using Alpine)
                                const alpineData = document.querySelector('[x-data="translationForm"]');
                                if (alpineData && alpineData._x_dataStack) {
                                    const activeTab = alpineData._x_dataStack[0].activeTab; // e.g. 'en'
                                    const activeInput = document.getElementById(`id_${fieldName}_${activeTab}`);
                                    if (activeInput && activeInput.value) {
                                        baseInput.value = activeInput.value;
                                        return;
                                    }
                                }

                                // Fallback to any non-empty field
                                const languages = ['zh_hans', 'en', 'ja', 'zh_hant'];
                                for (const lang of languages) {
                                    const input = document.getElementById(`id_${fieldName}_${lang}`);
                                    if (input && input.value) {
                                        baseInput.value = input.value;
                                        break;
                                    }
                                }
                            }
                        }
                        ensureValue('id_name', 'name');
                        ensureValue('id_description', 'description');
                    });
                }
            }

            // Initialize on page load
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initForm);
            } else {
                initForm();
            }

            // Initialize after HTMX swap (for SPA-like navigation)
            document.addEventListener('htmx:afterSwap', initForm);
        })();
    </script>
{% endblock %}
{% block content %}
    <!-- Header -->
    {% captureas header_actions %}
{% endcaptureas %}
{% trans "ç¼–è¾‘åˆ†ç±»" as default_title %}
{% include "administration/components/header.html" with title=title|default:default_title icon="category" breadcrumbs=breadcrumbs actions=header_actions %}
<form method="post"
      enctype="multipart/form-data"
      class="grid grid-cols-1 lg:grid-cols-3 gap-6"
      novalidate>
    {% csrf_token %}
    <!-- Left Column: Main Content -->
    <div class="lg:col-span-2 space-y-6">
        {% captureas main_content %}
        {% if form.errors %}
            <div role="alert"
                 class="alert border border-error/20 bg-error/5 text-error mb-4 shadow-sm">
                <div class="flex items-start gap-4">
                    <span class="material-symbols-outlined pt-1">error</span>
                    <div class="w-full">
                        <span class="font-bold block mb-1">{% trans "è¡¨å•é”™è¯¯" %}</span>
                        <ul class="list-disc list-inside text-sm opacity-90">
                            {% for field in form %}
                                {% for error in field.errors %}<li>{{ field.label }}: {{ error }}</li>{% endfor %}
                            {% endfor %}
                            {% for error in form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        {% endif %}
        <!-- Multi-language Tabs -->
        <div x-data="translationForm"
             class="bg-base-100 border border-base-300 rounded-box overflow-hidden">
            <!-- Tab Header -->
            <div class="flex flex-wrap items-end justify-between gap-2 border-b border-base-200 bg-base-50/50 px-4 pt-2">
                <div role="tablist" class="tabs tabs-bordered -mb-[1px]">
                    <a role="tab"
                       class="tab h-10 px-4 transition-all duration-200"
                       :class="activeTab === 'zh-hans' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                       @click="activeTab = 'zh-hans'">
                        <span class="mr-2 text-lg">ğŸ‡¨ğŸ‡³</span>
                        {% trans "ä¸­æ–‡" %}
                    </a>
                    <a role="tab"
                       class="tab h-10 px-4 transition-all duration-200"
                       :class="activeTab === 'en' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                       @click="activeTab = 'en'">
                        <span class="mr-2 text-lg">ğŸ‡ºğŸ‡¸</span>
                        {% trans "English" %}
                    </a>
                    <a role="tab"
                       class="tab h-10 px-4 transition-all duration-200"
                       :class="activeTab === 'ja' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                       @click="activeTab = 'ja'">
                        <span class="mr-2 text-lg">ğŸ‡¯ğŸ‡µ</span>
                        {% trans "æ—¥æœ¬èª" %}
                    </a>
                    <a role="tab"
                       class="tab h-10 px-4 transition-all duration-200"
                       :class="activeTab === 'zh-hant' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                       @click="activeTab = 'zh-hant'">
                        <span class="mr-2 text-lg">ğŸ‡­ğŸ‡°</span>
                        {% trans "ç¹é«”ä¸­æ–‡" %}
                    </a>
                </div>
                <!-- One-click Translate Button -->
                <div class="mb-1">
                    <button type="button"
                            class="btn btn-sm btn-ghost gap-1.5 text-primary hover:bg-primary/10 transition-colors"
                            @click="translate('id_name_zh_hans', { 'en': 'id_name_en', 'ja': 'id_name_ja', 'zh-hant': 'id_name_zh_hant' }); translate('id_description_zh_hans', { 'en': 'id_description_en', 'ja': 'id_description_ja', 'zh-hant': 'id_description_zh_hant' })"
                            :class="{'loading': isLoading}"
                            title="{% trans 'è‡ªåŠ¨ç¿»è¯‘åˆ°å…¶ä»–è¯­è¨€' %}">
                        <span class="material-symbols-outlined text-[18px]" x-show="!isLoading">translate</span>
                        <span class="hidden sm:inline font-medium">{% trans "ä¸€é”®ç¿»è¯‘" %}</span>
                    </button>
                </div>
            </div>
            <!-- Tab Content -->
            <div class="p-6">
                <!-- Zh-Hans Tab -->
                <div x-show="activeTab === 'zh-hans'">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text font-bold text-base">{% trans "åç§° (ä¸­æ–‡)" %} <span class="text-error">*</span></span>
                        </label>
                        {% trans " (ä¸­æ–‡)" as suffix_zh %}
                        {% render_field form.name_zh_hans class="input input-bordered w-full focus:input-primary transition-all" placeholder=form.name_zh_hans.label|add:suffix_zh %}
                        {% if form.name_zh_hans.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.name_zh_hans.errors.0 }}</span>
                            </label>
                        {% endif %}
                    </div>
                    <div class="form-control w-full mt-4">
                        <label class="label">
                            <span class="label-text font-bold text-base">{% trans "æè¿° (ä¸­æ–‡)" %}</span>
                        </label>
                        {% trans " (ä¸­æ–‡)..." as suffix_desc_zh %}
                        {% render_field form.description_zh_hans class="textarea textarea-bordered h-32 focus:textarea-primary transition-all" placeholder=form.description_zh_hans.label|add:suffix_desc_zh %}
                        {% if form.description_zh_hans.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.description_zh_hans.errors.0 }}</span>
                            </label>
                        {% endif %}
                    </div>
                </div>
                <!-- English Tab -->
                <div x-show="activeTab === 'en'" style="display: none;">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text font-bold text-base">{% trans "Name (English)" %}</span>
                        </label>
                        {% trans " (English)" as suffix_en %}
                        {% render_field form.name_en class="input input-bordered w-full focus:input-primary transition-all" placeholder=form.name_en.label|add:suffix_en %}
                        {% if form.name_en.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.name_en.errors.0 }}</span>
                            </label>
                        {% endif %}
                        <label class="label">
                            <span class="label-text-alt text-base-content/60">{% trans "è¿™å°†æ˜¯å®ƒåœ¨ç«™ç‚¹ä¸Šæ˜¾ç¤ºçš„åå­—ã€‚" %}</span>
                        </label>
                    </div>
                    <div class="form-control w-full mt-4">
                        <label class="label">
                            <span class="label-text font-bold text-base">{% trans "Description (English)" %}</span>
                        </label>
                        {% trans " (English)..." as suffix_desc_en %}
                        {% render_field form.description_en class="textarea textarea-bordered h-32 focus:textarea-primary transition-all" placeholder=form.description_en.label|add:suffix_desc_en %}
                        {% if form.description_en.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.description_en.errors.0 }}</span>
                            </label>
                        {% endif %}
                    </div>
                </div>
                <!-- Japanese Tab -->
                <div x-show="activeTab === 'ja'" style="display: none;">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text font-bold text-base">{% trans "åå‰ (Japanese)" %}</span>
                        </label>
                        {% trans " (Japanese)" as suffix_ja %}
                        {% render_field form.name_ja class="input input-bordered w-full focus:input-primary transition-all" placeholder=form.name_ja.label|add:suffix_ja %}
                        {% if form.name_ja.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.name_ja.errors.0 }}</span>
                            </label>
                        {% endif %}
                    </div>
                    <div class="form-control w-full mt-4">
                        <label class="label">
                            <span class="label-text font-bold text-base">{% trans "èª¬æ˜ (Japanese)" %}</span>
                        </label>
                        {% trans " (Japanese)..." as suffix_desc_ja %}
                        {% render_field form.description_ja class="textarea textarea-bordered h-32 focus:textarea-primary transition-all" placeholder=form.description_ja.label|add:suffix_desc_ja %}
                        {% if form.description_ja.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.description_ja.errors.0 }}</span>
                            </label>
                        {% endif %}
                    </div>
                </div>
                <!-- Zh-Hant Tab -->
                <div x-show="activeTab === 'zh-hant'" style="display: none;">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text font-bold text-base">{% trans "åç¨± (Traditional Chinese)" %}</span>
                        </label>
                        {% trans " (Traditional Chinese)" as suffix_tc %}
                        {% render_field form.name_zh_hant class="input input-bordered w-full focus:input-primary transition-all" placeholder=form.name_zh_hant.label|add:suffix_tc %}
                        {% if form.name_zh_hant.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.name_zh_hant.errors.0 }}</span>
                            </label>
                        {% endif %}
                    </div>
                    <div class="form-control w-full mt-4">
                        <label class="label">
                            <span class="label-text font-bold text-base">{% trans "æè¿° (Traditional Chinese)" %}</span>
                        </label>
                        {% trans " (Traditional Chinese)..." as suffix_desc_tc %}
                        {% render_field form.description_zh_hant class="textarea textarea-bordered h-32 focus:textarea-primary transition-all" placeholder=form.description_zh_hant.label|add:suffix_desc_tc %}
                        {% if form.description_zh_hant.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.description_zh_hant.errors.0 }}</span>
                            </label>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <!-- Slug Field -->
        <div class="form-control w-full">
            <label class="label">
                <span class="label-text font-bold text-base">{% trans "åˆ«å (Slug)" %}</span>
            </label>
            {% render_field form.slug class="input input-bordered w-full focus:input-primary transition-all font-mono" placeholder=form.slug.label %}
            {% if form.slug.errors %}
                <label class="label">
                    <span class="label-text-alt text-error">{{ form.slug.errors.0 }}</span>
                </label>
            {% endif %}
            <label class="label">
                <span class="label-text-alt text-base-content/60">{% trans "â€œåˆ«åâ€æ˜¯åœ¨URLä¸­ä½¿ç”¨çš„åˆ«ç§°ï¼Œé€šå¸¸ä½¿ç”¨å°å†™ï¼Œåªèƒ½åŒ…å«å­—æ¯ï¼Œæ•°å­—å’Œè¿å­—ç¬¦ï¼ˆ-ï¼‰ã€‚" %}</span>
            </label>
            <!-- Hidden inputs for content and base fields -->
            <div class="hidden">
                {{ form.name }} <!-- Base name -->
                {{ form.description }} <!-- Base description -->
            </div>
        </div>
    {% endcaptureas %}
    {% trans "åŸºæœ¬ä¿¡æ¯" as t_title %}
    {% include "administration/components/form_card.html" with title=t_title icon="edit_note" content=main_content %}
    {% captureas appearance_content %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6"
         x-data="{ icon: '{{ form.icon.value|default_if_none:""|escapejs }}' }">
        <!-- Icon Field -->
        <div class="form-control w-full">
            <label class="label">
                <span class="label-text font-bold text-base">{% trans "å›¾æ ‡" %}</span>
            </label>
            <div class="join w-full">
                <div class="join-item flex items-center justify-center bg-base-200 border border-base-300 w-12 px-2">
                    <span class="material-symbols-outlined text-2xl" x-text="icon || 'help'"></span>
                </div>
                {% render_field form.icon class="input input-bordered join-item flex-1 font-mono focus:input-primary transition-all" placeholder="folder" x-model="icon" %}
                <button type="button"
                        class="btn btn-neutral join-item"
                        onclick="document.getElementById('icon_picker_modal').showModal()">
                    <span class="material-symbols-outlined">grid_view</span>
                    {% trans "é€‰æ‹©" %}
                </button>
            </div>
            {% if form.icon.errors %}
                <label class="label">
                    <span class="label-text-alt text-error">{{ form.icon.errors.0 }}</span>
                </label>
            {% endif %}
        </div>
    </div>
{% endcaptureas %}
{% trans "å¤–è§‚è®¾ç½®" as t_title %}
{% include "administration/components/form_card.html" with title=t_title icon="palette" content=appearance_content %}
</div>
<!-- Right Column: Sidebar -->
<div class="lg:col-span-1 space-y-6">
    <!-- Publish Box -->
    {% captureas publish_content %}
    <div class="flex flex-col gap-3">
        <button type="submit"
                class="btn btn-primary w-full gap-2 shadow-lg shadow-primary/20">
            <span class="material-symbols-outlined">save</span>
            {% trans "ä¿å­˜æ›´æ”¹" %}
        </button>
        <div class="grid grid-cols-2 gap-2">
            <button type="submit"
                    name="_addanother"
                    class="btn btn-sm btn-ghost border-base-300">{% trans "ä¿å­˜å¹¶æ–°å¢" %}</button>
            <button type="submit"
                    name="_continue"
                    class="btn btn-sm btn-ghost border-base-300">{% trans "ä¿å­˜å¹¶ç»§ç»­" %}</button>
        </div>
        {% if object %}
            <div class="divider my-1"></div>
            <div class="flex justify-between items-center">
                <a href="javascript:history.back()"
                   class="btn btn-sm btn-ghost text-base-content/60">{% trans "å–æ¶ˆ" %}</a>
                <button type="button"
                        onclick="confirmDelete('{% url 'administration:category_delete' object.pk %}', '{% trans "ç¡®å®šè¦åˆ é™¤åˆ†ç±»" %}ã€Š{{ object.name|escapejs }}ã€‹{% trans "å—ï¼Ÿ" %}')"
                        class="btn btn-sm btn-ghost text-error hover:bg-error/10">{% trans "åˆ é™¤åˆ†ç±»" %}</button>
            </div>
        {% else %}
            <div class="divider my-1"></div>
            <a href="javascript:history.back()"
               class="btn btn-sm btn-ghost text-base-content/60 w-full">{% trans "å–æ¶ˆ" %}</a>
        {% endif %}
    </div>
{% endcaptureas %}
{% trans "å‘å¸ƒ" as t_title %}
{% include "administration/components/form_card.html" with title=t_title icon="publish" content=publish_content %}
<!-- Cover Image -->
{% captureas cover_content %}
<div class="form-control w-full" x-data="imageCropper({ previewUrl: '
    {% if object.cover_image %}{{ object.cover_image.url|escapejs }}{% endif %}
    ', aspectRatio: 1200/300 })">
    <div class="flex flex-col gap-4">
        <!-- Preview area -->
        <div class="relative w-full aspect-video bg-base-200 rounded-lg overflow-hidden flex items-center justify-center border-2 border-dashed border-base-300 group hover:border-primary transition-colors cursor-pointer"
             @click="document.getElementById('{{ form.cover_image.id_for_label }}').click()">
            <img :src="previewUrl"
                 class="w-full h-full object-cover"
                 x-show="previewUrl">
            <div class="flex flex-col items-center text-base-content/40 group-hover:text-primary transition-colors"
                 x-show="!previewUrl">
                <span class="material-symbols-outlined text-4xl">image</span>
                <span class="text-sm mt-1">{% trans "ç‚¹å‡»ä¸Šä¼ å°é¢" %}</span>
                <span class="text-xs opacity-60 mt-0.5">{% trans "æ¨è 1200x300 (4:1)" %}</span>
            </div>
            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center text-white"
                 x-show="previewUrl">
                <span class="material-symbols-outlined">edit</span>
            </div>
        </div>
        <div class="hidden">
            <input type="file"
                   name="{{ form.cover_image.name }}"
                   id="{{ form.cover_image.id_for_label }}"
                   accept="image/*"
                   @change="handleFile">
        </div>
        <!-- Color Field (Moved here) -->
        <div class="form-control w-full">
            <label class="label">
                <span class="label-text font-bold text-base">{% trans "é¢œè‰²æ ‡è¯†" %}</span>
            </label>
            {% include 'components/color_picker.html' with value=form.color.value name=form.color.name %}
            {% if form.color.errors %}
                <label class="label">
                    <span class="label-text-alt text-error">{{ form.color.errors.0 }}</span>
                </label>
            {% endif %}
        </div>
    </div>
</div>
{% endcaptureas %}
{% trans "å°é¢å›¾ä¸é¢œè‰²" as t_title %}
{% include "administration/components/form_card.html" with title=t_title icon="image" content=cover_content %}
</div>
</form>
{% endblock %}
