{% extends "administration/base.html" %}
{% load capture_tags widget_tweaks %}

{% block title %}{{ title }}{{ config.SITE_ADMIN_SUFFIX|default:" - Rosetta Dashboard" }}{% endblock %}

{% block content %}
<!-- Header -->
{% captureas header_actions %}
{% endcaptureas %}

{% include "administration/components/header.html" with title=title|default:"编辑投票" icon="poll" breadcrumbs=breadcrumbs actions=header_actions %}

<form method="post" class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
    {% csrf_token %}
    
    <!-- Left Column: Main Content -->
    <div class="lg:col-span-2 space-y-6">
        {% captureas main_content %}
            <div class="flex flex-col gap-5">
                {% if form.non_field_errors %}
                <div class="alert alert-error mb-2 shadow-sm rounded-xl">
                    <span class="material-symbols-outlined">error</span>
                    <div class="flex flex-col">
                        <span class="font-bold">表单错误</span>
                        {% for error in form.non_field_errors %}
                        <span class="text-sm">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Title Field -->
                <div class="form-control w-full group">
                    <label class="label px-0">
                        <span class="label-text font-bold text-base group-focus-within:text-primary transition-colors">
                            标题 <span class="text-error">*</span>
                        </span>
                    </label>
                    {% render_field form.title class="input input-bordered input-lg w-full focus:input-primary transition-all font-medium" placeholder="输入投票标题" %}
                    {% if form.title.errors %}
                    <label class="label px-0">
                        <span class="label-text-alt text-error flex items-center gap-1">
                            <span class="material-symbols-outlined text-xs">error</span>
                            {{ form.title.errors.0 }}
                        </span>
                    </label>
                    {% endif %}
                </div>

                <!-- Description Field -->
                <div class="form-control w-full group">
                    <label class="label px-0">
                        <span class="label-text font-bold text-base group-focus-within:text-primary transition-colors">描述</span>
                    </label>
                    {% render_field form.description class="textarea textarea-bordered h-32 w-full focus:textarea-primary transition-all text-base leading-relaxed" placeholder="输入投票描述，详细说明投票目的..." %}
                    {% if form.description.errors %}
                    <label class="label px-0">
                        <span class="label-text-alt text-error">{{ form.description.errors.0 }}</span>
                    </label>
                    {% endif %}
                </div>

                <!-- Related Post Field -->
                <div class="form-control w-full">
                    <label class="label px-0">
                        <span class="label-text font-bold text-base">关联文章</span>
                    </label>
                    {% render_field form.related_post class="select select-bordered w-full focus:select-primary transition-all" %}
                    {% if form.related_post.errors %}
                    <label class="label px-0">
                        <span class="label-text-alt text-error">{{ form.related_post.errors.0 }}</span>
                    </label>
                    {% endif %}
                    <label class="label px-0">
                        <span class="label-text-alt text-base-content/60 flex items-center gap-1">
                            <span class="material-symbols-outlined text-xs">link</span>
                            可选：将投票关联到特定文章，投票将显示在该文章页面。
                        </span>
                    </label>
                </div>
            </div>
        {% endcaptureas %}
        {% include "administration/components/form_card.html" with title="基本信息" icon="edit_note" content=main_content %}

        <!-- Choices Formset -->
        {% captureas choices_content %}
            {{ choice_formset.management_form }}
            {% if choice_formset.non_form_errors %}
            <div class="alert alert-error mb-4 rounded-xl">
                {{ choice_formset.non_form_errors }}
            </div>
            {% endif %}

            <div class="overflow-x-auto rounded-xl border border-base-content/5 bg-base-100/50">
                <table class="table table-zebra w-full">
                    <thead class="bg-base-200/50 text-base-content/70">
                        <tr>
                            <th class="w-12 text-center font-mono text-xs">#</th>
                            <th>选项内容</th>
                            <th class="w-32 text-center">当前票数</th>
                            <th class="w-20 text-center">删除</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for choice_form in choice_formset %}
                        <tr class="hover group">
                            <td class="text-center font-mono text-xs opacity-50">
                                {{ forloop.counter }}
                                {% for hidden in choice_form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                            </td>
                            <td>
                                {% render_field choice_form.text class="input input-bordered input-sm w-full focus:input-primary transition-all" placeholder="输入选项内容..." %}
                                {% if choice_form.text.errors %}
                                <div class="text-error text-xs mt-1 flex items-center gap-1">
                                    <span class="material-symbols-outlined text-[10px]">error</span>
                                    {{ choice_form.text.errors.0 }}
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                {% render_field choice_form.votes_count class="input input-bordered input-sm w-full text-center font-mono" %}
                            </td>
                            <td class="text-center">
                                {% if choice_form.instance.pk %}
                                    <div class="tooltip tooltip-left" data-tip="删除此选项">
                                        <input type="checkbox" name="{{ choice_form.prefix }}-DELETE" id="id_{{ choice_form.prefix }}-DELETE" class="checkbox checkbox-error checkbox-sm hidden peer">
                                        <label for="id_{{ choice_form.prefix }}-DELETE" class="btn btn-ghost btn-square btn-sm text-base-content/40 hover:text-error hover:bg-error/10 transition-colors peer-checked:btn-error peer-checked:text-white">
                                            <span class="material-symbols-outlined text-lg">delete</span>
                                        </label>
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="flex items-center justify-between mt-3 px-1">
                <div class="flex items-center gap-2 text-xs text-base-content/60">
                    <span class="material-symbols-outlined text-sm text-info">info</span>
                    <span>保存时将自动应用更改。</span>
                </div>
                <button type="button" id="add-choice" class="btn btn-sm btn-ghost gap-2 text-primary hover:bg-primary/10">
                    <span class="material-symbols-outlined text-sm">add</span>
                    添加选项
                </button>
            </div>
        {% endcaptureas %}
        {% include "administration/components/form_card.html" with title="投票选项" icon="list" content=choices_content %}
    </div>

    <!-- Right Column: Settings -->
    <div class="lg:col-span-1 space-y-6 lg:sticky lg:top-24">
        <!-- Publish Box -->
        {% captureas publish_content %}
            <div class="flex flex-col gap-3">
                <button type="submit" class="btn btn-primary w-full gap-2 shadow-lg shadow-primary/20 hover:shadow-primary/40 hover:-translate-y-0.5 transition-all duration-300">
                    <span class="material-symbols-outlined">save</span>
                    保存更改
                </button>
                
                <div class="grid grid-cols-2 gap-2">
                    <button type="submit" name="_addanother" class="btn btn-sm btn-ghost border-base-300 hover:bg-base-200 hover:border-base-content/20 transition-all">
                        <span class="material-symbols-outlined text-xs">add_circle</span>
                        保存并新增
                    </button>
                    <button type="submit" name="_continue" class="btn btn-sm btn-ghost border-base-300 hover:bg-base-200 hover:border-base-content/20 transition-all">
                        <span class="material-symbols-outlined text-xs">edit</span>
                        保存并继续
                    </button>
                </div>

                {% if object %}
                <div class="divider my-1"></div>
                <div class="flex justify-between items-center">
                    <a href="javascript:history.back()" class="btn btn-sm btn-ghost text-base-content/60 hover:text-base-content">
                        取消
                    </a>
                    <button type="button" onclick="confirmDelete('{% url 'administration:poll_delete' object.pk %}', '确定要删除投票《{{ object.title|escapejs }}》吗？')" class="btn btn-sm btn-ghost text-error hover:bg-error/10 hover:text-error-focus transition-colors">
                        <span class="material-symbols-outlined text-sm">delete</span>
                        删除投票
                    </button>
                </div>
                {% else %}
                <div class="divider my-1"></div>
                <a href="javascript:history.back()" class="btn btn-sm btn-ghost text-base-content/60 w-full hover:bg-base-200">
                    取消
                </a>
                {% endif %}
            </div>
        {% endcaptureas %}
        {% include "administration/components/form_card.html" with title="发布" icon="publish" content=publish_content %}

        <!-- Settings Box -->
        {% captureas settings_content %}
            <div class="flex flex-col gap-4">
                <div class="form-control bg-base-100 rounded-lg border border-base-content/5 p-3 hover:border-primary/20 transition-colors">
                    <label class="label cursor-pointer p-0">
                        <div class="flex flex-col gap-0.5">
                            <span class="label-text font-bold flex items-center gap-2">
                                <span class="material-symbols-outlined text-success">check_circle</span>
                                启用投票
                            </span>
                            <span class="text-xs text-base-content/50">在前台显示此投票</span>
                        </div>
                        {% render_field form.is_active class="toggle toggle-success toggle-sm" %}
                    </label>
                </div>
                
                <div class="form-control bg-base-100 rounded-lg border border-base-content/5 p-3 hover:border-primary/20 transition-colors">
                    <label class="label cursor-pointer p-0">
                        <div class="flex flex-col gap-0.5">
                            <span class="label-text font-bold flex items-center gap-2">
                                <span class="material-symbols-outlined text-info">check_box</span>
                                允许复选
                            </span>
                            <span class="text-xs text-base-content/50">允许用户选择多个选项</span>
                        </div>
                        {% render_field form.allow_multiple_choices class="toggle toggle-info toggle-sm" %}
                    </label>
                </div>

                <div class="divider my-0"></div>

                <div class="form-control w-full group">
                    <label class="label px-0">
                        <span class="label-text font-bold flex items-center gap-2 group-focus-within:text-primary transition-colors">
                            <span class="material-symbols-outlined text-warning">event_busy</span>
                            截止日期
                        </span>
                    </label>
                    {% render_field form.end_date class="input input-bordered w-full focus:input-primary transition-all font-mono text-sm" type="datetime-local" %}
                    <label class="label px-0">
                        <span class="label-text-alt text-base-content/60">留空表示永久有效。</span>
                    </label>
                </div>
            </div>
        {% endcaptureas %}
        {% include "administration/components/form_card.html" with title="设置" icon="settings" content=settings_content %}
    </div>
</form>

<div id="empty-form" class="hidden">
    <table>
        <tbody>
            <tr class="hover group">
                <td class="text-center font-mono text-xs opacity-50">
                    <span class="choice-counter"></span>
                </td>
                <td>
                    <input type="text" name="choices-__prefix__-text" class="input input-bordered input-sm w-full focus:input-primary transition-all" placeholder="输入选项内容..." id="id_choices-__prefix__-text">
                </td>
                <td>
                    <input type="number" name="choices-__prefix__-votes_count" value="0" class="input input-bordered input-sm w-full text-center font-mono" id="id_choices-__prefix__-votes_count">
                </td>
                <td class="text-center">
                    <input type="checkbox" name="choices-__prefix__-DELETE" id="id_choices-__prefix__-DELETE" class="checkbox checkbox-error checkbox-sm hidden peer">
                    <label for="id_choices-__prefix__-DELETE" class="btn btn-ghost btn-square btn-sm text-base-content/40 hover:text-error hover:bg-error/10 transition-colors btn-delete-row peer-checked:btn-error peer-checked:text-white" title="删除此选项">
                        <span class="material-symbols-outlined text-lg">delete</span>
                    </label>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const formsetContainer = document.querySelector('table tbody');
        const addButton = document.getElementById('add-choice');
        const totalForms = document.getElementById('id_choices-TOTAL_FORMS');
        const emptyFormTemplate = document.getElementById('empty-form').querySelector('tr');
        
        // Update row numbers and attach auto-add listeners
        function updateRowNumbersAndListeners() {
            formsetContainer.querySelectorAll('tr').forEach((row, index) => {
                const counter = row.querySelector('.choice-counter');
                if (counter) counter.textContent = index + 1;
                // Update forloop counter in existing rows if they are just text
                if (!counter && row.cells[0]) {
                    // Try to find text node
                    const cell = row.cells[0];
                    // Keep hidden inputs
                    const inputs = Array.from(cell.querySelectorAll('input'));
                    cell.innerHTML = `${index + 1}`;
                    inputs.forEach(input => cell.appendChild(input));
                }

                // Attach listener to the last text input
                if (index === formsetContainer.querySelectorAll('tr').length - 1) {
                    const textInput = row.querySelector('input[type="text"]');
                    if (textInput && !textInput.dataset.autoAddBound) {
                        textInput.dataset.autoAddBound = 'true';
                        textInput.addEventListener('input', function() {
                            // Only add if this is the last visible row
                            const allRows = formsetContainer.querySelectorAll('tr:not(.hidden)');
                            const lastRow = allRows[allRows.length - 1];
                            if (row === lastRow && this.value.trim() !== '') {
                                addNewRow();
                            }
                        });
                    }
                }
            });
        }

        function addNewRow() {
            const formCount = parseInt(totalForms.value);
            const newRow = emptyFormTemplate.cloneNode(true);
            
            // Replace __prefix__ with form count
            newRow.innerHTML = newRow.innerHTML.replace(/__prefix__/g, formCount);
            
            // Add to container
            formsetContainer.appendChild(newRow);
            
            // Update total forms
            totalForms.value = formCount + 1;
            
            updateRowNumbersAndListeners();
            
            // Setup delete button for new row
            const deleteBtn = newRow.querySelector('.btn-delete-row');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function(e) {
                    newRow.remove();
                });
            }
        }

        // Add new row button click
        addButton.addEventListener('click', addNewRow);
        
        // Initial setup
        updateRowNumbersAndListeners();
        
        // Handle delete for existing rows
        formsetContainer.addEventListener('change', function(e) {
            if (e.target.name && e.target.name.includes('DELETE')) {
                const row = e.target.closest('tr');
                if (e.target.checked) {
                    row.classList.add('opacity-30', 'bg-base-200');
                    row.querySelectorAll('input:not([type="checkbox"])').forEach(input => input.readOnly = true);
                } else {
                    row.classList.remove('opacity-30', 'bg-base-200');
                    row.querySelectorAll('input:not([type="checkbox"])').forEach(input => input.readOnly = false);
                }
            }
        });

        // Ensure at least 3 rows for new forms or empty forms
        const currentRows = formsetContainer.querySelectorAll('tr').length;
        if (currentRows === 0) {
            for (let i = 0; i < 3; i++) {
                addNewRow();
            }
        }
    });
</script>

{% endblock %}
