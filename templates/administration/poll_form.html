{% extends "administration/base.html" %}
{% load capture_tags i18n %}
{% block title %}
    {% trans " - Rosetta Dashboard" as admin_suffix_default %}{{ title }}{{ config.SITE_ADMIN_SUFFIX|default:admin_suffix_default }}
{% endblock %}
{% block content %}
    <!-- Header -->
    {% captureas header_actions %}
{% endcaptureas %}
{% trans "ç¼–è¾‘æŠ•ç¥¨" as default_title %}
{% include "administration/components/header.html" with title=title|default:default_title icon="poll" breadcrumbs=breadcrumbs actions=header_actions %}
<form method="post"
      class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start"
      x-data="translationForm"
      novalidate>
    {% csrf_token %}
    <div class="hidden">
        {{ form.title }}
        {{ form.description }}
    </div>
    <!-- Left Column: Main Content -->
    <div class="lg:col-span-2 space-y-6">
        {% captureas main_content %}
        <div class="flex flex-col gap-5">
            {% if form.non_field_errors %}
                <div role="alert"
                     class="alert border border-error/20 bg-error/5 text-error mb-2 shadow-sm rounded-xl">
                    <div class="flex items-start gap-4">
                        <span class="material-symbols-outlined pt-1">error</span>
                        <div class="w-full">
                            <span class="font-bold block mb-1">{% trans "è¡¨å•é”™è¯¯" %}</span>
                            <ul class="list-disc list-inside text-sm opacity-90">
                                {% for error in form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            {% endif %}
            <!-- Multi-language Tabs -->
            <div class="bg-base-100 border border-base-300 rounded-box overflow-hidden">
                <!-- Tab Header -->
                <div class="flex flex-wrap items-center justify-between gap-2 border-b border-base-200 bg-base-50/50 px-4 pt-2">
                    <div role="tablist" class="tabs tabs-bordered -mb-[1px]">
                        <a role="tab"
                           class="tab h-10 px-4 transition-all duration-200"
                           :class="activeTab === 'zh-hans' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                           @click="activeTab = 'zh-hans'">
                            <span class="mr-2 text-lg">ğŸ‡¨ğŸ‡³</span>
                            {% trans "ä¸­æ–‡" %}
                        </a>
                        <a role="tab"
                           class="tab h-10 px-4 transition-all duration-200"
                           :class="activeTab === 'en' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                           @click="activeTab = 'en'">
                            <span class="mr-2 text-lg">ğŸ‡ºğŸ‡¸</span>
                            {% trans "English" %}
                        </a>
                        <a role="tab"
                           class="tab h-10 px-4 transition-all duration-200"
                           :class="activeTab === 'ja' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                           @click="activeTab = 'ja'">
                            <span class="mr-2 text-lg">ğŸ‡¯ğŸ‡µ</span>
                            {% trans "æ—¥æœ¬èª" %}
                        </a>
                        <a role="tab"
                           class="tab h-10 px-4 transition-all duration-200"
                           :class="activeTab === 'zh-hant' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                           @click="activeTab = 'zh-hant'">
                            <span class="mr-2 text-lg">ğŸ‡­ğŸ‡°</span>
                            {% trans "ç¹é«”ä¸­æ–‡" %}
                        </a>
                    </div>
                    <!-- One-click Translate Button -->
                    <div class="mb-1">
                        <button type="button"
                                class="btn btn-sm btn-ghost gap-1.5 text-primary hover:bg-primary/10 transition-colors"
                                @click="translate('id_title_zh_hans', { 'en': 'id_title_en', 'ja': 'id_title_ja', 'zh-hant': 'id_title_zh_hant' }); translate('id_description_zh_hans', { 'en': 'id_description_en', 'ja': 'id_description_ja', 'zh-hant': 'id_description_zh_hant' })"
                                :class="{'loading': isLoading}"
                                title="{% trans 'è‡ªåŠ¨ç¿»è¯‘åˆ°å…¶ä»–è¯­è¨€' %}">
                            <span class="material-symbols-outlined text-[18px]" x-show="!isLoading">translate</span>
                            <span class="hidden sm:inline font-medium">{% trans "ä¸€é”®ç¿»è¯‘" %}</span>
                        </button>
                    </div>
                </div>
                <!-- Tab Content -->
                <div class="p-6">
                    <!-- Zh-Hans Tab -->
                    <div x-show="activeTab === 'zh-hans'"
                         x-transition:enter="transition ease-out duration-200"
                         x-transition:enter-start="opacity-0 translate-y-1"
                         x-transition:enter-end="opacity-100 translate-y-0">
                        <!-- Title Field -->
                        <div class="form-control w-full group">
                            <label class="label px-0">
                                <span class="label-text font-bold text-base group-focus-within:text-primary transition-colors">
                                    {% trans "æ ‡é¢˜ (ä¸­æ–‡)" %} <span class="text-error">*</span>
                                </span>
                            </label>
                            {{ form.title_zh_hans }}
                            {% if form.title_zh_hans.errors %}
                                <label class="label px-0">
                                    <span class="label-text-alt text-error flex items-center gap-1">
                                        <span class="material-symbols-outlined text-xs">error</span>
                                        {{ form.title_zh_hans.errors.0 }}
                                    </span>
                                </label>
                            {% endif %}
                        </div>
                        <!-- Description Field -->
                        <div class="form-control w-full group mt-4">
                            <label class="label px-0">
                                <span class="label-text font-bold text-base group-focus-within:text-primary transition-colors">{% trans "æè¿° (ä¸­æ–‡)" %}</span>
                            </label>
                            {{ form.description_zh_hans }}
                            {% if form.description_zh_hans.errors %}
                                <label class="label px-0">
                                    <span class="label-text-alt text-error">{{ form.description_zh_hans.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                    </div>
                    <!-- English Tab -->
                    <div x-show="activeTab === 'en'"
                         x-transition:enter="transition ease-out duration-200"
                         x-transition:enter-start="opacity-0 translate-y-1"
                         x-transition:enter-end="opacity-100 translate-y-0"
                         style="display: none">
                        <div class="form-control w-full group">
                            <label class="label px-0">
                                <span class="label-text font-bold text-base group-focus-within:text-primary transition-colors">{% trans "Title (English)" %}</span>
                            </label>
                            {{ form.title_en }}
                            {% if form.title_en.errors %}
                                <label class="label px-0">
                                    <span class="label-text-alt text-error">{{ form.title_en.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                        <div class="form-control w-full group mt-4">
                            <label class="label px-0">
                                <span class="label-text font-bold text-base group-focus-within:text-primary transition-colors">{% trans "Description (English)" %}</span>
                            </label>
                            {{ form.description_en }}
                            {% if form.description_en.errors %}
                                <label class="label px-0">
                                    <span class="label-text-alt text-error">{{ form.description_en.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                    </div>
                    <!-- Japanese Tab -->
                    <div x-show="activeTab === 'ja'"
                         x-transition:enter="transition ease-out duration-200"
                         x-transition:enter-start="opacity-0 translate-y-1"
                         x-transition:enter-end="opacity-100 translate-y-0"
                         style="display: none">
                        <div class="form-control w-full group">
                            <label class="label px-0">
                                <span class="label-text font-bold text-base group-focus-within:text-primary transition-colors">{% trans "ã‚¿ã‚¤ãƒˆãƒ« (Japanese)" %}</span>
                            </label>
                            {{ form.title_ja }}
                            {% if form.title_ja.errors %}
                                <label class="label px-0">
                                    <span class="label-text-alt text-error">{{ form.title_ja.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                        <div class="form-control w-full group mt-4">
                            <label class="label px-0">
                                <span class="label-text font-bold text-base group-focus-within:text-primary transition-colors">{% trans "èª¬æ˜ (Japanese)" %}</span>
                            </label>
                            {{ form.description_ja }}
                            {% if form.description_ja.errors %}
                                <label class="label px-0">
                                    <span class="label-text-alt text-error">{{ form.description_ja.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                    </div>
                    <!-- Zh-Hant Tab -->
                    <div x-show="activeTab === 'zh-hant'"
                         x-transition:enter="transition ease-out duration-200"
                         x-transition:enter-start="opacity-0 translate-y-1"
                         x-transition:enter-end="opacity-100 translate-y-0"
                         style="display: none">
                        <div class="form-control w-full group">
                            <label class="label px-0">
                                <span class="label-text font-bold text-base group-focus-within:text-primary transition-colors">{% trans "æ¨™é¡Œ (Traditional Chinese)" %}</span>
                            </label>
                            {{ form.title_zh_hant }}
                            {% if form.title_zh_hant.errors %}
                                <label class="label px-0">
                                    <span class="label-text-alt text-error">{{ form.title_zh_hant.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                        <div class="form-control w-full group mt-4">
                            <label class="label px-0">
                                <span class="label-text font-bold text-base group-focus-within:text-primary transition-colors">{% trans "æè¿° (Traditional Chinese)" %}</span>
                            </label>
                            {{ form.description_zh_hant }}
                            {% if form.description_zh_hant.errors %}
                                <label class="label px-0">
                                    <span class="label-text-alt text-error">{{ form.description_zh_hant.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <!-- Related Post Field -->
            <div class="form-control w-full">
                <label class="label px-0">
                    <span class="label-text font-bold text-base">{% trans "å…³è”æ–‡ç« " %}</span>
                </label>
                {{ form.related_post }}
                {% if form.related_post.errors %}
                    <label class="label px-0">
                        <span class="label-text-alt text-error">{{ form.related_post.errors.0 }}</span>
                    </label>
                {% endif %}
                <label class="label px-0">
                    <span class="label-text-alt text-base-content/60 flex items-center gap-1">
                        <span class="material-symbols-outlined text-xs">link</span>
                        {% trans "å¯é€‰ï¼šå°†æŠ•ç¥¨å…³è”åˆ°ç‰¹å®šæ–‡ç« ï¼ŒæŠ•ç¥¨å°†æ˜¾ç¤ºåœ¨è¯¥æ–‡ç« é¡µé¢ã€‚" %}
                    </span>
                </label>
            </div>
        </div>
    {% endcaptureas %}
    {% trans "åŸºæœ¬ä¿¡æ¯" as basic_info_title %}
    {% include "administration/components/form_card.html" with title=basic_info_title icon="edit_note" content=main_content %}
    <!-- Choices Formset -->
    {% captureas choices_content %}
    {{ choice_formset.management_form }}
    {% if choice_formset.non_form_errors %}
        <div class="alert alert-error mb-4 rounded-xl">{{ choice_formset.non_form_errors }}</div>
    {% endif %}
    <div class="overflow-x-auto rounded-xl border border-base-content/5 bg-base-100/50">
        <table id="choices-table" class="table table-zebra w-full">
            <thead class="bg-base-200/50 text-base-content/70">
                <tr>
                    <th class="w-12 text-center font-mono text-xs">#</th>
                    <th>{% trans "é€‰é¡¹å†…å®¹" %}</th>
                    <th class="w-32 text-center">{% trans "å½“å‰ç¥¨æ•°" %}</th>
                    <th class="w-20 text-center">{% trans "åˆ é™¤" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for choice_form in choice_formset %}
                    <tr class="hover group">
                        <td class="text-center font-mono text-xs opacity-50">
                            {{ forloop.counter }}
                            {% for hidden in choice_form.hidden_fields %}{{ hidden }}{% endfor %}
                        </td>
                        <td>
                            <div class="flex justify-between items-center mb-1.5">
                                <span class="text-xs font-bold opacity-50">{% trans "å¤šè¯­è¨€å†…å®¹" %}</span>
                                <button type="button"
                                        class="btn btn-ghost btn-xs text-primary gap-1 hover:bg-primary/10"
                                        @click="translate('id_{{ choice_form.prefix }}-text_zh_hans', { 'en': 'id_{{ choice_form.prefix }}-text_en', 'ja': 'id_{{ choice_form.prefix }}-text_ja', 'zh-hant': 'id_{{ choice_form.prefix }}-text_zh_hant' })"
                                        title="{% trans 'ä¸€é”®ç¿»è¯‘æ­¤é€‰é¡¹' %}">
                                    <span class="material-symbols-outlined text-[14px]">translate</span>
                                    {% trans "ç¿»è¯‘" %}
                                </button>
                            </div>
                            <div class="space-y-2">
                                {{ choice_form.text_zh_hans }}
                                {{ choice_form.text_en }}
                                {{ choice_form.text_ja }}
                                {{ choice_form.text_zh_hant }}
                            </div>
                        </td>
                        <td>{{ choice_form.votes_count }}</td>
                        <td class="text-center">
                            {% if choice_form.instance.pk %}
                                <div class="tooltip tooltip-left" data-tip="{% trans 'åˆ é™¤æ­¤é€‰é¡¹' %}">
                                    <input type="checkbox"
                                           name="{{ choice_form.prefix }}-DELETE"
                                           id="id_{{ choice_form.prefix }}-DELETE"
                                           class="checkbox checkbox-error checkbox-sm hidden">
                                    <button type="button"
                                            class="btn btn-ghost btn-square btn-sm text-base-content/40 hover:text-error hover:bg-error/10 transition-colors delete-row-btn">
                                        <span class="material-symbols-outlined text-lg">delete</span>
                                    </button>
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Empty Form Template - Moved outside table for validity -->
    <template id="empty-form-template">
        <tr class="hover group">
            <td class="text-center font-mono text-xs opacity-50">
                <span class="row-index">#</span>
                {% for hidden in choice_formset.empty_form.hidden_fields %}{{ hidden }}{% endfor %}
            </td>
            <td>
                <div class="flex justify-between items-center mb-1.5">
                    <span class="text-xs font-bold opacity-50">{% trans "å¤šè¯­è¨€å†…å®¹" %}</span>
                    <button type="button"
                            class="btn btn-ghost btn-xs text-primary gap-1 hover:bg-primary/10"
                            @click="translate('id_choices-__prefix__-text_zh_hans', { 'en': 'id_choices-__prefix__-text_en', 'ja': 'id_choices-__prefix__-text_ja', 'zh-hant': 'id_choices-__prefix__-text_zh_hant' })"
                            title="{% trans 'ä¸€é”®ç¿»è¯‘æ­¤é€‰é¡¹' %}">
                        <span class="material-symbols-outlined text-[14px]">translate</span>
                        {% trans "ç¿»è¯‘" %}
                    </button>
                </div>
                <div class="space-y-2">
                    {{ choice_formset.empty_form.text_zh_hans }}
                    {{ choice_formset.empty_form.text_en }}
                    {{ choice_formset.empty_form.text_ja }}
                    {{ choice_formset.empty_form.text_zh_hant }}
                </div>
            </td>
            <td>{{ choice_formset.empty_form.votes_count }}</td>
            <td class="text-center">
                <div class="tooltip tooltip-left" data-tip="{% trans 'åˆ é™¤æ­¤é€‰é¡¹' %}">
                    <button type="button"
                            class="btn btn-ghost btn-square btn-sm text-base-content/40 hover:text-error hover:bg-error/10 transition-colors delete-row-btn">
                        <span class="material-symbols-outlined text-lg">delete</span>
                    </button>
                </div>
            </td>
        </tr>
    </template>
    <div class="flex items-center justify-between mt-3 px-1">
        <div class="flex items-center gap-2 text-xs text-base-content/60">
            <span class="material-symbols-outlined text-sm text-info">info</span>
            <span>{% trans "ä¿å­˜æ—¶å°†è‡ªåŠ¨åº”ç”¨æ›´æ”¹ã€‚" %}</span>
        </div>
        <button type="button"
                id="add-choice"
                class="btn btn-sm btn-ghost gap-2 text-primary hover:bg-primary/10">
            <span class="material-symbols-outlined text-sm">add</span>
            {% trans "æ·»åŠ é€‰é¡¹" %}
        </button>
    </div>
{% endcaptureas %}
{% trans "æŠ•ç¥¨é€‰é¡¹" as options_title %}
{% include "administration/components/form_card.html" with title=options_title icon="list" content=choices_content %}
</div>
<!-- Right Column: Settings -->
<div class="lg:col-span-1 space-y-6 lg:sticky lg:top-24">
    <!-- Publish Box -->
    {% captureas publish_content %}
    <div class="flex flex-col gap-3">
        <button type="submit"
                class="btn btn-primary w-full gap-2 shadow-lg shadow-primary/20 hover:shadow-primary/40 hover:-translate-y-0.5 transition-all duration-300">
            <span class="material-symbols-outlined">save</span>
            {% trans "ä¿å­˜æ›´æ”¹" %}
        </button>
        <div class="grid grid-cols-2 gap-2">
            <button type="submit"
                    name="_addanother"
                    class="btn btn-sm btn-ghost border-base-300 hover:bg-base-200 hover:border-base-content/20 transition-all">
                <span class="material-symbols-outlined text-xs">add_circle</span>
                {% trans "ä¿å­˜å¹¶æ–°å¢" %}
            </button>
            <button type="submit"
                    name="_continue"
                    class="btn btn-sm btn-ghost border-base-300 hover:bg-base-200 hover:border-base-content/20 transition-all">
                <span class="material-symbols-outlined text-xs">edit</span>
                {% trans "ä¿å­˜å¹¶ç»§ç»­" %}
            </button>
        </div>
        {% if object %}
            <div class="divider my-1"></div>
            <div class="flex justify-between items-center">
                <a href="javascript:history.back()"
                   class="btn btn-sm btn-ghost text-base-content/60 hover:text-base-content">{% trans "å–æ¶ˆ" %}</a>
                {% trans "ç¡®å®šè¦åˆ é™¤æŠ•ç¥¨" as confirm_msg %}
                {% blocktrans asvar delete_msg %}ç¡®å®šè¦åˆ é™¤æŠ•ç¥¨ã€Š{{ object.title|escapejs }}ã€‹å—ï¼Ÿ{% endblocktrans %}
                <button type="button"
                        onclick="confirmDelete('{% url 'administration:poll_delete' object.pk %}', '{{ delete_msg|escapejs }}')"
                        class="btn btn-sm btn-ghost text-error hover:bg-error/10 hover:text-error-focus transition-colors">
                    <span class="material-symbols-outlined text-sm">delete</span>
                    {% trans "åˆ é™¤æŠ•ç¥¨" %}
                </button>
            </div>
        {% else %}
            <div class="divider my-1"></div>
            <a href="javascript:history.back()"
               class="btn btn-sm btn-ghost text-base-content/60 w-full hover:bg-base-200">{% trans "å–æ¶ˆ" %}</a>
        {% endif %}
    </div>
{% endcaptureas %}
{% trans "å‘å¸ƒ" as pub_title %}
{% include "administration/components/form_card.html" with title=pub_title icon="publish" content=publish_content %}
<!-- Settings Box -->
{% captureas settings_content %}
<div class="form-control">
    <label class="label cursor-pointer justify-between">
        <span class="label-text font-medium">{% trans "å¯ç”¨çŠ¶æ€" %}</span>
        {{ form.is_active }}
    </label>
</div>
<div class="form-control mt-2">
    <label class="label cursor-pointer justify-between">
        <span class="label-text font-medium">{% trans "å…è®¸å¤šé€‰" %}</span>
        {{ form.allow_multiple_choices }}
    </label>
</div>
<div class="form-control mt-2">
    <label class="label">
        <span class="label-text font-medium">{% trans "ç»“æŸæ—¶é—´" %}</span>
    </label>
    {{ form.end_date }}
</div>
{% endcaptureas %}
{% trans "è®¾ç½®" as settings_title %}
{% include "administration/components/form_card.html" with title=settings_title icon="settings" content=settings_content %}
</div>
</form>
{% endblock %}
{% block extra_js %}
    <script>
        (function() {
            function initForm() {
                const form = document.querySelector('form');
                if (form && !form.dataset.pollInitialized) {
                    form.dataset.pollInitialized = 'true';

                    function setupSync(baseId, fieldName) {
                        const languages = ['zh_hans', 'en', 'ja', 'zh_hant'];
                        const baseInput = document.getElementById(baseId);
                        if (!baseInput) return;

                        languages.forEach(lang => {
                            const inputId = `id_${fieldName}_${lang}`;
                            const input = document.getElementById(inputId);
                            if (input) {
                                input.addEventListener('input', function() {
                                    if (this.value) {
                                        baseInput.value = this.value;
                                    } else {
                                        let foundValue = '';
                                        for (const otherLang of languages) {
                                            const otherInput = document.getElementById(`id_${fieldName}_${otherLang}`);
                                            if (otherInput && otherInput.value) {
                                                foundValue = otherInput.value;
                                                break;
                                            }
                                        }
                                        baseInput.value = foundValue;
                                    }
                                });
                                if (input.value && !baseInput.value) {
                                    baseInput.value = input.value;
                                }
                            }
                        });
                    }

                    setupSync('id_title', 'title');
                    setupSync('id_description', 'description');

                    form.addEventListener('submit', function(e) {
                        function ensureValue(baseId, fieldName) {
                            const baseInput = document.getElementById(baseId);
                            if (baseInput && !baseInput.value) {
                                const alpineData = document.querySelector('[x-data="translationForm"]');
                                if (alpineData && alpineData._x_dataStack) {
                                    const activeTab = alpineData._x_dataStack[0].activeTab;
                                    const activeInput = document.getElementById(`id_${fieldName}_${activeTab}`);
                                    if (activeInput && activeInput.value) {
                                        baseInput.value = activeInput.value;
                                        return;
                                    }
                                }
                                const languages = ['zh_hans', 'en', 'ja', 'zh_hant'];
                                for (const lang of languages) {
                                    const input = document.getElementById(`id_${fieldName}_${lang}`);
                                    if (input && input.value) {
                                        baseInput.value = input.value;
                                        break;
                                    }
                                }
                            }
                        }
                        ensureValue('id_title', 'title');
                        ensureValue('id_description', 'description');

                        // Sync choice fields
                        const totalForms = document.getElementById('id_choices-TOTAL_FORMS');
                        if (totalForms) {
                            const count = parseInt(totalForms.value);
                            const languages = ['zh_hans', 'en', 'ja', 'zh_hant'];
                            for (let i = 0; i < count; i++) {
                                const baseTextInput = document.getElementById(`id_choices-${i}-text`);
                                if (baseTextInput) {
                                    // Check if base has value, if not try to fill from translations
                                    if (!baseTextInput.value) {
                                        for (const lang of languages) {
                                            const textInput = document.getElementById(`id_choices-${i}-text_${lang}`);
                                            if (textInput && textInput.value) {
                                                baseTextInput.value = textInput.value;
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    });

                    // Choice adding logic
                    const addBtn = document.getElementById('add-choice');
                    const totalForms = document.getElementById('id_choices-TOTAL_FORMS');
                    const tbody = document.querySelector('#choices-table tbody');
                    const emptyFormTemplate = document.getElementById('empty-form-template');
                    
                    if (addBtn && totalForms && tbody && emptyFormTemplate) {
                        addBtn.addEventListener('click', function() {
                            const count = parseInt(totalForms.value);
                            const templateContent = emptyFormTemplate.content.cloneNode(true);
                            
                            // Use table/tbody container to ensure tr elements are valid during innerHTML manipulation
                            const tempTable = document.createElement('table');
                            const tempTbody = document.createElement('tbody');
                            tempTable.appendChild(tempTbody);
                            tempTbody.appendChild(templateContent);
                            
                            // Replace __prefix__ with current count
                            tempTbody.innerHTML = tempTbody.innerHTML.replace(/__prefix__/g, count);
                            
                            const newRow = tempTbody.firstElementChild;
                            
                            // Update index display
                            const indexSpan = newRow.querySelector('.row-index');
                            if (indexSpan) indexSpan.innerText = count + 1;

                            // Add delete handler for new row
                            const deleteBtn = newRow.querySelector('.delete-row-btn');
                            if (deleteBtn) {
                                deleteBtn.addEventListener('click', function() {
                                    newRow.remove();
                                    updateFormIndices();
                                });
                            }
                            
                            tbody.appendChild(newRow);
                            totalForms.value = count + 1;
                        });
                    } else {
                        // Retry init if elements are missing (rare race condition)
                        setTimeout(initForm, 100);
                    }

                    // Bind delete handlers to existing rows
                    document.querySelectorAll('.delete-row-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const row = this.closest('tr');
                            const checkbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
                            
                            if (checkbox) {
                                // For existing rows: toggle checkbox and visual state
                                checkbox.checked = !checkbox.checked;
                                if (checkbox.checked) {
                                    row.classList.add('opacity-30', 'bg-base-200');
                                    this.classList.add('btn-error', 'text-white');
                                    this.classList.remove('text-base-content/40', 'hover:text-error');
                                } else {
                                    row.classList.remove('opacity-30', 'bg-base-200');
                                    this.classList.remove('btn-error', 'text-white');
                                    this.classList.add('text-base-content/40', 'hover:text-error');
                                }
                            }
                        });
                    });

                    function updateFormIndices() {
                        const rows = tbody.querySelectorAll('tr');
                        let newCount = 0;
                        
                        rows.forEach((row, index) => {
                            // Update row index display
                            const indexSpan = row.querySelector('.row-index');
                            if (indexSpan) indexSpan.innerText = index + 1; // 1-based index for display

                            // Update all inputs in this row
                            row.querySelectorAll('input, select, textarea, label').forEach(el => {
                                if (el.name) el.name = el.name.replace(/choices-\d+-/, `choices-${index}-`);
                                if (el.id) el.id = el.id.replace(/choices-\d+-/, `choices-${index}-`);
                                if (el.htmlFor) el.htmlFor = el.htmlFor.replace(/choices-\d+-/, `choices-${index}-`);
                            });

                            newCount++;
                        });
                        
                        totalForms.value = newCount;
                    }
                }
            }

            // Initialize on page load
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initForm);
            } else {
                initForm();
            }

            // Initialize after HTMX swap (for SPA-like navigation)
            document.addEventListener('htmx:afterSwap', initForm);
        })();
    </script>
{% endblock %}
