{% extends "administration/base.html" %}
{% load static tailwind_tags i18n core_extras %}
{% block title %}
    {% trans "媒体库" %}
{% endblock %}
{% block extra_head %}
    <!-- Dropzone.js -->
    <script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
    <link rel="stylesheet"
          href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css"
          type="text/css" />
    <style>
    /* Dropzone Customization */
    .dropzone {
        border: 2px dashed oklch(var(--bc) / 0.2);
        border-radius: 1rem;
        background: oklch(var(--b1));
        min-height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
    }
    .dropzone:hover {
        border-color: oklch(var(--p));
        background: oklch(var(--b2));
    }
    .dropzone .dz-message {
        font-weight: 500;
        color: oklch(var(--bc) / 0.6);
    }
    .dropzone .dz-preview {
        background: transparent;
    }
    .dropzone .dz-preview .dz-image {
        border-radius: 0.5rem;
    }
    </style>
{% endblock %}
{% block content %}
    <!-- Dropzone.js Resources (Loaded here for HTMX support) -->
    <!-- Using npm installed version via Django static files -->
    <script src="{% static 'js/dropzone.min.js' %}"></script>
    <link rel="stylesheet"
          href="{% static 'css/dropzone.min.css' %}"
          type="text/css" />
    <style>
    /* Dropzone Customization */
    .dropzone {
        border: 2px dashed oklch(var(--bc) / 0.2);
        border-radius: 1rem;
        background: oklch(var(--b1));
        min-height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
    }
    .dropzone:hover {
        border-color: oklch(var(--p));
        background: oklch(var(--b2));
    }
    .dropzone .dz-message {
        font-weight: 500;
        color: oklch(var(--bc) / 0.6);
    }
    .dropzone .dz-preview {
        background: transparent;
    }
    .dropzone .dz-preview .dz-image {
        border-radius: 0.5rem;
    }
    </style>
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
        <div>
            <h1 class="text-3xl font-bold font-heading flex items-center gap-2">
                <span class="material-symbols-outlined text-3xl text-primary">perm_media</span>
                {% trans "媒体库" %}
            </h1>
            <p class="text-base-content/60 mt-1">{% trans "管理所有上传的图片、视频和文件资源。" %}</p>
        </div>
        <div class="flex gap-2">
            <button onclick="document.getElementById('upload_modal').showModal()"
                    class="btn btn-primary shadow-lg shadow-primary/20">
                <span class="material-symbols-outlined">cloud_upload</span>
                {% trans "上传文件" %}
            </button>
        </div>
    </div>
    <!-- Filters -->
    <div class="bg-base-100 rounded-box shadow-sm border border-base-content/5 p-4 mb-6">
        <form method="get" class="flex flex-wrap items-center gap-4">
            <div class="join">
                <input type="text"
                       name="q"
                       value="{{ request.GET.q }}"
                       placeholder="{% trans '搜索文件名...' %}"
                       class="input input-bordered join-item w-full md:w-64">
                <button class="btn btn-square join-item">
                    <span class="material-symbols-outlined">search</span>
                </button>
            </div>
            <select name="type"
                    class="select select-bordered"
                    onchange="this.form.submit()">
                <option value="">{% trans "所有类型" %}</option>
                <option value="image" {% if request.GET.type == 'image' %}selected{% endif %}>{% trans "图片" %}</option>
                <option value="video" {% if request.GET.type == 'video' %}selected{% endif %}>{% trans "视频" %}</option>
                <option value="audio" {% if request.GET.type == 'audio' %}selected{% endif %}>{% trans "音频" %}</option>
                <option value="document"
                        {% if request.GET.type == 'document' %}selected{% endif %}>{% trans "文档" %}</option>
            </select>
            {% if request.GET.q or request.GET.type %}
                <a href="{% url 'administration:media_list' %}"
                   class="btn btn-ghost btn-sm">{% trans "重置" %}</a>
            {% endif %}
        </form>
    </div>
    <!-- Media Grid -->
    {% if media_list %}
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
            {% for media in media_list %}
                <div class="group relative aspect-square bg-base-200 rounded-xl overflow-hidden border border-base-content/5 hover:shadow-lg transition-all cursor-pointer"
                     onclick="openMediaDetail('{{ media.id }}', '{{ media.url }}', '{{ media.filename }}', '{{ media.title|escapejs }}', '{{ media.alt_text|escapejs }}', '{{ media.description|escapejs }}', '{{ media.file_size|filesizeformat }}', '{{ media.created_at|date:'Y-m-d H:i' }}', '{% if media.uploaded_by %}{{ media.uploaded_by.nickname|default:media.uploaded_by.username|escapejs }}{% else %}{% trans "Unknown" as u_label %}{{ u_label|escapejs }}{% endif %}')">
                    {% if media.file_type == 'image' %}
                        <img src="{{ media.file.url }}"
                             alt="{{ media.alt_text }}"
                             class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                    {% else %}
                        <div class="w-full h-full flex flex-col items-center justify-center p-4 text-center">
                            <span class="material-symbols-outlined text-4xl mb-2 opacity-50">
                                {% if media.file_type == 'video' %}
                                    movie
                                {% elif media.file_type == 'audio' %}
                                    audiotrack
                                {% elif media.file_type == 'document' %}
                                    description
                                {% else %}
                                    insert_drive_file
                                {% endif %}
                            </span>
                            <span class="text-xs truncate w-full px-2 opacity-70">{{ media.filename }}</span>
                        </div>
                    {% endif %}
                    <!-- Overlay -->
                    <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                        <button class="btn btn-circle btn-sm btn-ghost text-white"
                                title="{% trans '查看详情' %}">
                            <span class="material-symbols-outlined">info</span>
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
        <!-- Pagination -->
        <div class="mt-8">{% include "administration/components/pagination.html" with page_obj=page_obj %}</div>
    {% else %}
        <!-- Empty State -->
        {% trans "暂无媒体资源" as title_text %}
        {% trans "点击上传按钮开始添加文件。" as description_text %}
        {% trans "上传文件" as action_text %}
        {% include "administration/components/empty_state.html" with title=title_text description=description_text icon="perm_media" action_url="#" action_text=action_text action_onclick="document.getElementById('upload_modal').showModal()" %}
    {% endif %}
    <!-- Upload Modal -->
    <dialog id="upload_modal" class="modal">
        <div class="modal-box w-11/12 max-w-3xl">
            <h3 class="font-bold text-lg mb-4">{% trans "上传文件" %}</h3>
            <form action="{% url 'administration:media_upload' %}"
                  class="dropzone"
                  id="media-dropzone">
                {% csrf_token %}
                <div class="dz-message" data-dz-message>
                    <div class="flex flex-col items-center">
                        <span class="material-symbols-outlined text-4xl mb-2 text-primary">cloud_upload</span>
                        <span>{% trans "拖拽文件到此处或点击上传" %}</span>
                        <span class="text-xs opacity-50 mt-1">{% trans "支持多文件批量上传" %}</span>
                    </div>
                </div>
            </form>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn" onclick="window.location.reload()">{% trans "完成" %}</button>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button onclick="window.location.reload()">{% trans "关闭" %}</button>
        </form>
    </dialog>
    <!-- Detail Modal (Alpine.js) -->
    <dialog id="detail_modal"
            class="modal"
            x-data="mediaDetail({ updateUrl: '{% url 'administration:media_edit' 0 %}', deleteUrl: '{% url 'administration:media_delete' 0 %}', csrfToken: '{{ csrf_token }}', messages: { copySuccess: '{% trans '链接已复制' %}', saveSuccess: '{% trans '保存成功' %}', saveError: '{% trans '保存失败' %}', deleteConfirm: '{% trans '确定要删除这个文件吗？此操作无法撤销。' %}', deleteSuccess: '{% trans '删除成功' %}', deleteError: '{% trans '删除失败' %}' } })">
        <div class="modal-box w-11/12 max-w-4xl p-0 flex flex-col md:flex-row overflow-hidden bg-base-100">
            <!-- Preview Area -->
            <div class="w-full md:w-2/3 bg-base-200/50 flex items-center justify-center p-8 border-r border-base-content/10 relative">
                <template x-if="isImage(filename)">
                    <img :src="url"
                         class="max-w-full max-h-[60vh] rounded shadow-sm object-contain">
                </template>
                <template x-if="!isImage(filename)">
                    <div class="text-center">
                        <span class="material-symbols-outlined text-6xl opacity-20">insert_drive_file</span>
                        <p class="mt-4 font-mono text-sm opacity-60" x-text="filename"></p>
                    </div>
                </template>
                <!-- Delete Button (Top Left) -->
                <button @click="deleteMedia"
                        class="absolute top-4 left-4 btn btn-circle btn-sm btn-error btn-outline"
                        title="{% trans '删除' %}">
                    <span class="material-symbols-outlined">delete</span>
                </button>
            </div>
            <!-- Info Area -->
            <div class="w-full md:w-1/3 p-6 flex flex-col h-full overflow-y-auto">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 class="font-bold text-lg truncate w-48"
                            x-text="filename"
                            :title="filename"></h3>
                        <p class="text-xs opacity-50" x-text="createdAt"></p>
                    </div>
                    <form method="dialog">
                        <button type="button" class="btn btn-sm btn-circle btn-ghost" onclick="document.getElementById('detail_modal').close()">✕</button>
                    </form>
                </div>
                <!-- Metadata Form -->
                <form @submit.prevent="saveMetadata" class="space-y-4 flex-1">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">{% trans "文件 URL" %}</span>
                        </label>
                        <div class="join">
                            <input type="text"
                                   :value="url"
                                   class="input input-bordered input-sm join-item w-full font-mono text-xs"
                                   readonly>
                            <button type="button"
                                    @click="copyUrl"
                                    class="btn btn-sm btn-square join-item">
                                <span class="material-symbols-outlined text-xs">content_copy</span>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-xs opacity-70 mb-2">
                        <div>
                            <span class="block font-bold">{% trans "大小" %}</span>
                            <span x-text="size"></span>
                        </div>
                        <div>
                            <span class="block font-bold">{% trans "上传者" %}</span>
                            <span x-text="uploader"></span>
                        </div>
                    </div>
                    <div class="divider my-2"></div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">{% trans "标题 (Title)" %}</span>
                        </label>
                        <input type="text" x-model="title" class="input input-bordered input-sm">
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">{% trans "替代文本 (Alt)" %}</span>
                            <span class="label-text-alt text-warning">{% trans "SEO 推荐" %}</span>
                        </label>
                        <input type="text" x-model="altText" class="input input-bordered input-sm">
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">{% trans "描述" %}</span>
                        </label>
                        <textarea x-model="description"
                                  class="textarea textarea-bordered textarea-sm h-24"></textarea>
                    </div>
                    <div class="mt-auto pt-4">
                        <button type="submit"
                                class="btn btn-primary btn-block btn-sm"
                                :disabled="isSaving">
                            <span class="loading loading-spinner loading-xs" x-show="isSaving"></span>
                            {% trans "保存更改" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button type="button" onclick="document.getElementById('detail_modal').close()">{% trans "关闭" %}</button>
        </form>
    </dialog>
    <script>
    (function() {
        // --- Dropzone Initialization ---
        const initDropzone = () => {
            // Wait for Dropzone library to load
            if (typeof Dropzone === 'undefined') {
                return;
            }

            Dropzone.autoDiscover = false;
            const dropzoneId = 'media-dropzone';
            const dropzoneEl = document.getElementById(dropzoneId);

            if (dropzoneEl && !dropzoneEl.dropzone) {
                new Dropzone(dropzoneEl, {
                    paramName: "file",
                    maxFilesize: 50, // MB
                    acceptedFiles: "image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.md",
                    parallelUploads: 5,
                    init: function() {
                        this.on("success", function(file, response) {
                            if (window.showToast) window.showToast('{% trans "上传成功" %}', 'success');
                        });
                        this.on("error", function(file, errorMessage) {
                            if (window.showToast) window.showToast(errorMessage, 'error');
                        });
                        this.on("queuecomplete", function() {
                            // Reload page to show new files
                            setTimeout(() => window.location.reload(), 1000);
                        });
                    }
                });
            }
        };

        // Initialize using Rosetta Standard (handles Load + Swap)
        if (window.Rosetta) {
            window.Rosetta.onLoad(initDropzone);
        } else {
            initDropzone();
            if (window.htmx) htmx.onLoad(initDropzone);
        }
    })();
    </script>
{% endblock %}
