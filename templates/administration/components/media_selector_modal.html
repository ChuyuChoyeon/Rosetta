{% load i18n %}
<!-- Media Selector Modal -->
<div x-data="mediaSelector()"
     x-show="isOpen"
     @open-media-selector.window="openModal($event.detail)"
     @keydown.escape.window="closeModal()"
     class="fixed inset-0 z-[99999] flex items-center justify-center p-4 sm:p-6"
     style="display: none">
    <!-- Backdrop -->
    <div x-show="isOpen"
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-base-content/50 backdrop-blur-sm transition-opacity"
         @click="closeModal()"></div>
    <!-- Modal Panel -->
    <div x-show="isOpen"
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
         x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
         x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
         class="relative w-full max-w-5xl max-h-[90vh] flex flex-col bg-base-100 rounded-xl shadow-2xl overflow-hidden transform transition-all">
        <!-- Header -->
        <div class="flex items-center justify-between px-6 py-4 border-b border-base-200 bg-base-100 z-10">
            <h3 class="text-lg font-bold text-base-content flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">photo_library</span>
                {% trans "选择媒体资源" %}
            </h3>
            <button @click="closeModal()"
                    class="btn btn-sm btn-circle btn-ghost text-base-content/70 hover:text-base-content hover:bg-base-200">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <!-- Toolbar -->
        <div class="px-6 py-3 border-b border-base-200 bg-base-50/50 flex flex-wrap gap-3 items-center justify-between z-10">
            <!-- Search -->
            <div class="join w-full sm:max-w-xs">
                <input type="text"
                       x-model="searchQuery"
                       @keydown.enter="fetchMedia(1)"
                       placeholder="{% trans '搜索文件名...' %}"
                       class="input input-sm input-bordered join-item w-full bg-base-100 focus:outline-none focus:border-primary">
                <button @click="fetchMedia(1)" class="btn btn-sm btn-primary join-item">
                    <span class="material-symbols-outlined text-[18px]">search</span>
                </button>
            </div>
            <!-- Filter -->
            <div class="flex items-center gap-2">
                <select x-model="filterType"
                        @change="fetchMedia(1)"
                        class="select select-sm select-bordered bg-base-100 focus:outline-none focus:border-primary">
                    <option value="">{% trans "所有类型" %}</option>
                    <option value="image">{% trans "图片" %}</option>
                    <option value="video">{% trans "视频" %}</option>
                    <option value="document">{% trans "文档" %}</option>
                </select>
                <button @click="fetchMedia(1)"
                        class="btn btn-sm btn-ghost btn-circle"
                        title="{% trans '刷新' %}">
                    <span class="material-symbols-outlined">refresh</span>
                </button>
            </div>
        </div>
        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto p-6 bg-base-100"
             id="media-grid-container">
            <!-- Loading State -->
            <div x-show="isLoading"
                 class="flex flex-col items-center justify-center h-64 py-12">
                <span class="loading loading-spinner loading-lg text-primary mb-4"></span>
                <p class="text-base-content/60 font-medium animate-pulse">{% trans "加载资源中..." %}</p>
            </div>
            <!-- Empty State -->
            <div x-show="!isLoading && mediaList.length === 0"
                 class="flex flex-col items-center justify-center h-64 py-12 text-center"
                 style="display: none">
                <div class="w-16 h-16 rounded-full bg-base-200 flex items-center justify-center mb-4">
                    <span class="material-symbols-outlined text-3xl text-base-content/40">perm_media</span>
                </div>
                <h4 class="text-lg font-bold text-base-content/80 mb-1">{% trans "未找到资源" %}</h4>
                <p class="text-base-content/60 max-w-xs">{% trans "尝试调整搜索关键词或上传新文件" %}</p>
            </div>
            <!-- Grid -->
            <div x-show="!isLoading && mediaList.length > 0"
                 class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4"
                 style="display: none">
                <template x-for="media in mediaList" :key="media.id">
                    <div @click="selectMedia(media)"
                         class="group relative aspect-square rounded-lg border-2 overflow-hidden cursor-pointer transition-all duration-200 hover:shadow-md"
                         :class="selectedMedia?.id === media.id ? 'border-primary ring-2 ring-primary/20 ring-offset-2 bg-primary/5' : 'border-base-200 hover:border-primary/50 bg-base-50'">
                        <!-- Image Preview -->
                        <template x-if="media.file_type === 'image'">
                            <img :src="media.url"
                                 :alt="media.alt_text || media.filename"
                                 class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                        </template>
                        <!-- Non-image Preview -->
                        <template x-if="media.file_type !== 'image'">
                            <div class="w-full h-full flex flex-col items-center justify-center p-4 text-center">
                                <span class="material-symbols-outlined text-4xl mb-2 text-base-content/60"
                                      x-text="getIconForType(media.file_type)"></span>
                                <span class="text-xs text-base-content/70 line-clamp-2 break-all"
                                      x-text="media.filename"></span>
                            </div>
                        </template>
                        <!-- Selection Overlay -->
                        <div x-show="selectedMedia?.id === media.id"
                             class="absolute inset-0 bg-primary/10 flex items-center justify-center z-10 backdrop-blur-[1px]">
                            <div class="bg-primary text-primary-content rounded-full p-1 shadow-sm">
                                <span class="material-symbols-outlined text-xl">check</span>
                            </div>
                        </div>
                        <!-- Hover Info -->
                        <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent p-3 pt-8 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                            <p class="text-white text-xs font-medium truncate"
                               x-text="media.title || media.filename"></p>
                            <p class="text-white/70 text-[10px] truncate" x-text="media.created_at"></p>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        <!-- Footer -->
        <div class="flex items-center justify-between px-6 py-4 border-t border-base-200 bg-base-50/50 z-10">
            <!-- Pagination -->
            <div class="join">
                <button class="join-item btn btn-sm btn-ghost"
                        :disabled="!pagination.has_previous"
                        @click="fetchMedia(pagination.current_page - 1)">«</button>
                <button class="join-item btn btn-sm btn-ghost no-animation cursor-default font-normal">
                    <span x-text="pagination.current_page"></span> / <span x-text="pagination.num_pages"></span>
                </button>
                <button class="join-item btn btn-sm btn-ghost"
                        :disabled="!pagination.has_next"
                        @click="fetchMedia(pagination.current_page + 1)">»</button>
            </div>
            <!-- Actions -->
            <div class="flex items-center gap-3">
                <div x-show="selectedMedia"
                     class="text-sm text-base-content/60 mr-2 hidden sm:block">
                    {% trans "已选择:" %} <span class="font-medium text-base-content"
       x-text="selectedMedia?.filename"></span>
                </div>
                <button @click="closeModal()" class="btn btn-ghost">{% trans "取消" %}</button>
                <button @click="confirmSelection()"
                        :disabled="!selectedMedia"
                        class="btn btn-primary gap-2 px-6">
                    <span class="material-symbols-outlined text-[18px]">add_photo_alternate</span>
                    {% trans "插入" %}
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('mediaSelector', () => ({
            isOpen: false,
            isLoading: false,
            mediaList: [],
            pagination: {
                has_next: false,
                has_previous: false,
                num_pages: 1,
                current_page: 1
            },
            searchQuery: '',
            filterType: 'image', // Default to image
            selectedMedia: null,
            editorCallback: null,

            openModal(detail) {
                this.isOpen = true;
                this.editorCallback = detail?.callback; // Store callback if provided
                this.fetchMedia(1);
            },

            closeModal() {
                this.isOpen = false;
                this.selectedMedia = null;
                this.editorCallback = null;
            },

            async fetchMedia(page = 1) {
                this.isLoading = true;
                try {
                    const params = new URLSearchParams({
                        page: page,
                        q: this.searchQuery,
                        type: this.filterType,
                        format: 'json'
                    });
                    
                    const response = await fetch(`{% url 'administration:media_list' %}?${params}`, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (!response.ok) throw new Error('Network response was not ok');
                    
                    const data = await response.json();
                    this.mediaList = data.results;
                    this.pagination = data.pagination;
                    
                    // Scroll to top of grid
                    const container = document.getElementById('media-grid-container');
                    if (container) container.scrollTop = 0;
                    
                } catch (error) {
                    console.error('Error fetching media:', error);
                    // Optional: Show toast error
                } finally {
                    this.isLoading = false;
                }
            },

            selectMedia(media) {
                this.selectedMedia = media;
            },

            confirmSelection() {
                if (!this.selectedMedia) return;
                
                // Dispatch event with selected media data
                window.dispatchEvent(new CustomEvent('media-selected', {
                    detail: {
                        media: this.selectedMedia,
                        callback: this.editorCallback
                    }
                }));
                
                this.closeModal();
            },

            getIconForType(type) {
                const map = {
                    'video': 'movie',
                    'audio': 'audiotrack',
                    'document': 'description',
                    'archive': 'folder_zip'
                };
                return map[type] || 'insert_drive_file';
            }
        }));
    });
</script>
