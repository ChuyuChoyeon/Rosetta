{% extends "administration/base.html" %}
{% load capture_tags %}
{% load i18n %}

{% block title %}{% trans "系统日志" %}{{ config.SITE_ADMIN_SUFFIX|default:" - Rosetta Dashboard" }}{% endblock %}

{% block extra_head %}
<style>
    /* 简单代码高亮样式 */
    .log-content {
        font-family: 'Fira Code', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.875rem;
        line-height: 1.6;
        white-space: pre-wrap;
        word-break: break-all;
    }
</style>
{% endblock %}

{% block content %}
{% captureas card_content %}
<div class="flex flex-col md:flex-row h-[calc(100vh-200px)] min-h-[500px]">
    <!-- Sidebar: File List -->
    <div class="w-full md:w-72 border-r-0 md:border-r border-b md:border-b-0 border-base-200 flex flex-col bg-base-100/50 backdrop-blur-sm h-1/3 md:h-auto">
        <div class="p-4 border-b border-base-200/60 flex items-center gap-2 sticky top-0 bg-base-100/95 backdrop-blur z-10">
            <span class="material-symbols-outlined text-warning">folder_open</span>
            <h2 class="font-bold text-sm uppercase opacity-70 tracking-wider">{% trans "日志文件" %}</h2>
        </div>
        <div class="overflow-y-auto flex-1 p-3 space-y-2">
            {% for file in log_files %}
            <a href="?file={{ file.name }}" 
               class="group block p-3 rounded-xl text-sm transition-all duration-200 border border-transparent {% if file.name == current_file %}bg-primary text-primary-content shadow-lg shadow-primary/20 border-primary/20{% else %}hover:bg-base-200 hover:border-base-300 text-base-content/70{% endif %}">
                <div class="flex items-center gap-3 mb-1.5">
                    <div class="p-1.5 rounded-lg {% if file.name == current_file %}bg-white/20{% else %}bg-base-200 group-hover:bg-base-300{% endif %} transition-colors">
                        <span class="material-symbols-outlined text-lg opacity-90 block">
                            {% if '.log' in file.name %}text_snippet{% else %}folder_zip{% endif %}
                        </span>
                    </div>
                    <span class="font-medium truncate flex-1">{{ file.name }}</span>
                </div>
                <div class="flex justify-between text-xs opacity-70 pl-11">
                    <span class="font-mono">{{ file.size|filesizeformat }}</span>
                    <span>{{ file.mtime|date:"m-d H:i" }}</span>
                </div>
            </a>
            {% empty %}
            <div class="flex flex-col items-center justify-center py-12 text-base-content/40">
                <span class="material-symbols-outlined text-3xl mb-2 opacity-50">folder_off</span>
                <span class="text-xs">{% trans "无日志文件" %}</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Main Area: Log Content -->
    <div class="flex-1 flex flex-col min-w-0 bg-base-100 h-2/3 md:h-auto">
        <!-- Toolbar -->
        <div class="p-3 border-b border-base-200 flex flex-col sm:flex-row justify-between items-start sm:items-center bg-base-100/80 backdrop-blur-sm z-30 sticky top-0 gap-3">
            <div class="flex items-center gap-3 pl-2 w-full sm:w-auto overflow-hidden">
                {% if current_file %}
                    <div class="flex flex-col min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary shrink-0">description</span>
                            <span class="font-mono font-bold text-base truncate">{{ current_file }}</span>
                        </div>
                        {% if current_file_info %}
                        <div class="text-xs text-base-content/50 pl-8 flex gap-3 truncate">
                            <span>{% trans "大小" %}: {{ current_file_info.size|filesizeformat }}</span>
                            <span class="hidden sm:inline">{% trans "修改" %}: {{ current_file_info.mtime|date:"Y-m-d H:i:s" }}</span>
                        </div>
                        {% endif %}
                    </div>
                {% else %}
                    <span class="text-base-content/50 flex items-center gap-2">
                        <span class="material-symbols-outlined">arrow_back</span>
                        {% trans "请选择一个文件查看" %}
                    </span>
                {% endif %}
            </div>
            
            {% if current_file %}
            <div class="flex gap-2 w-full sm:w-auto justify-end items-center">
                <!-- Track Log Toggle -->
                <div class="form-control" title="{% trans '实时追踪最新日志' %}">
                    <label class="label cursor-pointer gap-2">
                        <span class="label-text text-xs font-medium opacity-70">{% trans "追踪" %}</span>
                        <input type="checkbox" id="track-log-toggle" class="toggle toggle-xs toggle-success" checked />
                    </label>
                </div>
                <div class="divider divider-horizontal mx-0 my-1 hidden sm:flex"></div>

                <a href="." class="btn btn-sm btn-ghost gap-2" title="{% trans '刷新' %}">
                    <span class="material-symbols-outlined text-sm">refresh</span>
                    <span class="hidden sm:inline">{% trans "刷新" %}</span>
                </a>
                <a href="{% url 'administration:logfile_download' current_file %}" class="btn btn-sm btn-outline gap-2" hx-boost="false" download>
                    <span class="material-symbols-outlined text-sm">download</span>
                    <span class="hidden sm:inline">{% trans "下载" %}</span>
                </a>
                <div class="divider divider-horizontal mx-0 my-1 hidden sm:flex"></div>
                <button type="button" class="btn btn-sm btn-ghost text-error gap-2 hover:bg-error/10" onclick="clear_log_modal.showModal()">
                    <span class="material-symbols-outlined text-sm">ink_eraser</span>
                    <span class="hidden sm:inline">{% trans "清空" %}</span>
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-auto bg-base-100 relative group" id="log-scroll-container">
            {% if log_content %}
                <div class="p-4 text-base-content/80 select-text">
                     <div id="log-content-area" class="log-content whitespace-pre-wrap break-all">{{ log_content }}</div>
                     <div id="log-append-target"></div>
                </div>
                
                <!-- Polling Trigger -->
                <div hx-get="?file={{ current_file }}&partial=content" 
                     hx-trigger="every 2s condition:window.shouldPollLog()" 
                     hx-vals="js:{last_pos: window.currentLogPos || 0}"
                     hx-swap="beforeend"
                     hx-target="#log-content-area"
                     hx-select="#log-content-area"
                     class="hidden"></div>
            {% else %}
                <div id="log-content-area" class="flex flex-col items-center justify-center h-full text-base-content/30 gap-3">
                    {% if current_file %}
                        <span class="material-symbols-outlined text-5xl opacity-50">draft</span>
                        <p>{% trans "文件为空" %}</p>
                    {% else %}
                        <span class="material-symbols-outlined text-5xl opacity-50">plagiarism</span>
                        <p>{% trans "请选择左侧文件查看详情" %}</p>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endcaptureas %}

<div class="p-0 overflow-hidden rounded-2xl border-none shadow-none hover:shadow-none bg-base-100 border border-base-content/5 w-full">
    {{ card_content }}
</div>

<script>
    (function() {
        const logContainer = document.getElementById('log-scroll-container');
        // Initialize from server context
        window.currentLogPos = {{ initial_log_pos|default:0 }}; 

        // Function to scroll to bottom
        const scrollToBottom = () => {
            if (logContainer) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        };

        // Scroll on initial load
        if (logContainer) {
            scrollToBottom();
        }

        // Listen for HTMX updates
        document.body.addEventListener('htmx:afterOnLoad', function(evt) {
            // Update position from header
            const xhr = evt.detail.xhr;
            const newPos = xhr.getResponseHeader('X-Log-Pos');
            if (newPos) {
                window.currentLogPos = parseInt(newPos);
            }
            
            // Auto scroll if tracking
            if (evt.detail.target.id === 'log-content-area') {
                const trackToggle = document.getElementById('track-log-toggle');
                if (trackToggle && trackToggle.checked) {
                    scrollToBottom();
                }
            }
        });
    })();
    
    // Global function for hx-trigger condition
    window.shouldPollLog = function() {
        const toggle = document.getElementById('track-log-toggle');
        return toggle && toggle.checked;
    };
</script>

<!-- Clear Log Confirmation Modal -->
{% if current_file %}
<dialog id="clear_log_modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg text-error flex items-center gap-2">
            <span class="material-symbols-outlined">warning</span>
            {% trans "确认清空日志?" %}
        </h3>
        <p class="py-4">
            {% blocktrans with filename=current_file %}您确定要清空 <span class="font-mono font-bold bg-base-200 px-1 rounded">{{ filename }}</span> 的内容吗？{% endblocktrans %}
            <br>
            <span class="text-xs opacity-70 mt-2 block">{% trans "此操作不可恢复，请谨慎操作。" %}</span>
        </p>
        <div class="modal-action">
            <form method="post" action="{% url 'administration:logfile_delete' current_file %}">
                {% csrf_token %}
                <input type="hidden" name="action" value="clear">
                <button type="button" class="btn" onclick="clear_log_modal.close()">{% trans "取消" %}</button>
                <button type="submit" class="btn btn-error">{% trans "确定清空" %}</button>
            </form>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>{% trans "关闭" %}</button>
    </form>
</dialog>
{% endif %}
{% endblock %}

