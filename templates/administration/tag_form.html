{% extends "administration/base.html" %}
{% load capture_tags widget_tweaks i18n %}
{% block title %}
    {% trans " - Rosetta Dashboard" as admin_suffix_default %}{{ title }}{{ config.SITE_ADMIN_SUFFIX|default:admin_suffix_default }}
{% endblock %}
{% block extra_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            function initForm() {
                const form = document.querySelector('form');
                if (form && !form.dataset.syncInitialized) {
                    form.dataset.syncInitialized = 'true';
                    
                    // Helper to sync multiple language fields to a base field
                    function setupSync(baseId, fieldName) {
                        const languages = ['zh_hans', 'en', 'ja', 'zh_hant'];
                        const baseInput = document.getElementById(baseId);
                        if (!baseInput) return;

                        languages.forEach(lang => {
                            const inputId = `id_${fieldName}_${lang}`;
                            const input = document.getElementById(inputId);
                            if (input) {
                                input.addEventListener('input', function() {
                                    baseInput.value = this.value;
                                });
                                if (input.value && !baseInput.value) {
                                    baseInput.value = input.value;
                                }
                            }
                        });
                    }

                    setupSync('id_name', 'name');

                    form.addEventListener('submit', function(e) {
                        const baseInput = document.getElementById('id_name');
                        if (baseInput && !baseInput.value) {
                            // Try active tab first
                            const alpineData = document.querySelector('[x-data="translationForm"]');
                            if (alpineData && alpineData._x_dataStack) {
                                const activeTab = alpineData._x_dataStack[0].activeTab;
                                const activeInput = document.getElementById(`id_name_${activeTab}`);
                                if (activeInput && activeInput.value) {
                                    baseInput.value = activeInput.value;
                                    return;
                                }
                            }
                            // Fallback
                            const languages = ['zh_hans', 'en', 'ja', 'zh_hant'];
                            for (const lang of languages) {
                                const input = document.getElementById(`id_name_${lang}`);
                                if (input && input.value) {
                                    baseInput.value = input.value;
                                    break;
                                }
                            }
                        }
                    });
                }
            }
            initForm();
        });
    </script>
{% endblock %}
{% block content %}
    <!-- Header -->
    {% captureas header_actions %}
{% endcaptureas %}
{% trans "ç¼–è¾‘æ ‡ç­¾" as default_title %}
{% include "administration/components/header.html" with title=title|default:default_title icon="tag" breadcrumbs=breadcrumbs actions=header_actions %}
<form method="post"
      enctype="multipart/form-data"
      class="grid grid-cols-1 lg:grid-cols-3 gap-6"
      novalidate>
    {% csrf_token %}
    <!-- Left Column: Main Content -->
    <div class="lg:col-span-2 space-y-6">
        {% captureas main_content %}
        {% if form.errors %}
            <div role="alert"
                 class="alert border border-error/20 bg-error/5 text-error mb-4 shadow-sm">
                <div class="flex items-start gap-4">
                    <span class="material-symbols-outlined pt-1">error</span>
                    <div class="w-full">
                        <span class="font-bold block mb-1">{% trans "è¡¨å•é”™è¯¯" %}</span>
                        <ul class="list-disc list-inside text-sm opacity-90">
                            {% for field in form %}
                                {% for error in field.errors %}<li>{{ field.label }}: {{ error }}</li>{% endfor %}
                            {% endfor %}
                            {% for error in form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        {% endif %}
        <!-- Multi-language Tabs -->
        <div x-data="translationForm"
             class="bg-base-100 border border-base-300 rounded-box overflow-hidden">
            <!-- Tab Header -->
            <div class="flex flex-wrap items-center justify-between gap-2 border-b border-base-200 bg-base-50/50 px-4 pt-2">
                <div role="tablist" class="tabs tabs-bordered -mb-[1px]">
                    <a role="tab"
                       class="tab h-10 px-4 transition-all duration-200"
                       :class="activeTab === 'zh-hans' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                       @click="activeTab = 'zh-hans'">
                        <span class="mr-2 text-lg">ğŸ‡¨ğŸ‡³</span>
                        {% trans "ä¸­æ–‡" %}
                    </a>
                    <a role="tab"
                       class="tab h-10 px-4 transition-all duration-200"
                       :class="activeTab === 'en' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                       @click="activeTab = 'en'">
                        <span class="mr-2 text-lg">ğŸ‡ºğŸ‡¸</span>
                        {% trans "English" %}
                    </a>
                    <a role="tab"
                       class="tab h-10 px-4 transition-all duration-200"
                       :class="activeTab === 'ja' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                       @click="activeTab = 'ja'">
                        <span class="mr-2 text-lg">ğŸ‡¯ğŸ‡µ</span>
                        {% trans "æ—¥æœ¬èª" %}
                    </a>
                    <a role="tab"
                       class="tab h-10 px-4 transition-all duration-200"
                       :class="activeTab === 'zh-hant' ? 'tab-active border-primary text-primary font-bold bg-base-100' : 'hover:text-base-content/80'"
                       @click="activeTab = 'zh-hant'">
                        <span class="mr-2 text-lg">ğŸ‡­ğŸ‡°</span>
                        {% trans "ç¹é«”ä¸­æ–‡" %}
                    </a>
                </div>
                <!-- One-click Translate Button -->
                <div class="mb-1">
                    <button type="button"
                            class="btn btn-sm btn-ghost gap-1.5 text-primary hover:bg-primary/10 transition-colors"
                            @click="translate('id_name_zh_hans', { 'en': 'id_name_en', 'ja': 'id_name_ja', 'zh-hant': 'id_name_zh_hant' })"
                            :class="{'loading': isLoading}"
                            title="{% trans 'è‡ªåŠ¨ç¿»è¯‘åˆ°å…¶ä»–è¯­è¨€' %}">
                        <span class="material-symbols-outlined text-[18px]" x-show="!isLoading">translate</span>
                        <span class="hidden sm:inline font-medium">{% trans "ä¸€é”®ç¿»è¯‘" %}</span>
                    </button>
                </div>
            </div>
            <!-- Tab Content -->
            <div class="p-6">
                <!-- Zh-Hans Tab -->
                <div x-show="activeTab === 'zh-hans'"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 translate-y-1"
                     x-transition:enter-end="opacity-100 translate-y-0">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text font-bold text-base">{% trans "åç§° (ä¸­æ–‡)" %} <span class="text-error">*</span></span>
                        </label>
                        {% trans " (ä¸­æ–‡)" as suffix_zh %}
                        {% render_field form.name_zh_hans class="input input-bordered w-full focus:input-primary transition-all" placeholder=form.name_zh_hans.label|add:suffix_zh %}
                        {% if form.name_zh_hans.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.name_zh_hans.errors.0 }}</span>
                            </label>
                        {% endif %}
                    </div>
                </div>
                <!-- English Tab -->
                <div x-show="activeTab === 'en'"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 translate-y-1"
                     x-transition:enter-end="opacity-100 translate-y-0"
                     style="display: none">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text font-bold text-base">{% trans "Name (English)" %}</span>
                        </label>
                        {% trans " (English)" as suffix_en %}
                        {% render_field form.name_en class="input input-bordered w-full focus:input-primary transition-all" placeholder=form.name_en.label|add:suffix_en %}
                        {% if form.name_en.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.name_en.errors.0 }}</span>
                            </label>
                        {% endif %}
                        <label class="label">
                            <span class="label-text-alt text-base-content/60">{% trans "è¿™å°†æ˜¯å®ƒåœ¨ç«™ç‚¹ä¸Šæ˜¾ç¤ºçš„åå­—ã€‚" %}</span>
                        </label>
                    </div>
                </div>
                <!-- Japanese Tab -->
                <div x-show="activeTab === 'ja'"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 translate-y-1"
                     x-transition:enter-end="opacity-100 translate-y-0"
                     style="display: none">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text font-bold text-base">{% trans "åå‰ (Japanese)" %}</span>
                        </label>
                        {% trans " (Japanese)" as suffix_ja %}
                        {% render_field form.name_ja class="input input-bordered w-full focus:input-primary transition-all" placeholder=form.name_ja.label|add:suffix_ja %}
                        {% if form.name_ja.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.name_ja.errors.0 }}</span>
                            </label>
                        {% endif %}
                    </div>
                </div>
                <!-- Zh-Hant Tab -->
                <div x-show="activeTab === 'zh-hant'"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 translate-y-1"
                     x-transition:enter-end="opacity-100 translate-y-0"
                     style="display: none">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text font-bold text-base">{% trans "åç¨± (Traditional Chinese)" %}</span>
                        </label>
                        {% trans " (Traditional Chinese)" as suffix_tc %}
                        {% render_field form.name_zh_hant class="input input-bordered w-full focus:input-primary transition-all" placeholder=form.name_zh_hant.label|add:suffix_tc %}
                        {% if form.name_zh_hant.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.name_zh_hant.errors.0 }}</span>
                            </label>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <!-- Slug Field -->
        <div class="form-control w-full">
            <label class="label">
                <span class="label-text font-bold text-base">{% trans "åˆ«å (Slug)" %}</span>
            </label>
            {% render_field form.slug class="input input-bordered w-full focus:input-primary transition-all font-mono" placeholder=form.slug.label %}
            {% if form.slug.errors %}
                <label class="label">
                    <span class="label-text-alt text-error">{{ form.slug.errors.0 }}</span>
                </label>
            {% endif %}
            <label class="label">
                <span class="label-text-alt text-base-content/60">{% trans "â€œåˆ«åâ€æ˜¯åœ¨URLä¸­ä½¿ç”¨çš„åˆ«ç§°ï¼Œé€šå¸¸ä½¿ç”¨å°å†™ï¼Œåªèƒ½åŒ…å«å­—æ¯ï¼Œæ•°å­—å’Œè¿å­—ç¬¦ï¼ˆ-ï¼‰ã€‚" %}</span>
            </label>
            <!-- Hidden inputs for content and base fields -->
            <div class="hidden">
                {{ form.name }} <!-- Base name -->
            </div>
        </div>
    {% endcaptureas %}
    {% trans "åŸºæœ¬ä¿¡æ¯" as basic_info_title %}
    {% include "administration/components/form_card.html" with title=basic_info_title icon="edit_note" content=main_content %}
</div>
<!-- Right Column: Sidebar -->
<div class="lg:col-span-1 space-y-6">
    <!-- Publish Box -->
    {% captureas publish_content %}
    <div class="flex flex-col gap-3">
        <button type="submit"
                class="btn btn-primary w-full gap-2 shadow-lg shadow-primary/20">
            <span class="material-symbols-outlined">save</span>
            {% trans "ä¿å­˜æ›´æ”¹" %}
        </button>
        <div class="grid grid-cols-2 gap-2">
            <button type="submit"
                    name="_addanother"
                    class="btn btn-sm btn-ghost border-base-300">{% trans "ä¿å­˜å¹¶æ–°å¢" %}</button>
            <button type="submit"
                    name="_continue"
                    class="btn btn-sm btn-ghost border-base-300">{% trans "ä¿å­˜å¹¶ç»§ç»­" %}</button>
        </div>
        {% if object %}
            <div class="divider my-1"></div>
            <div class="flex justify-between items-center">
                <a href="javascript:history.back()"
                   class="btn btn-sm btn-ghost text-base-content/60">{% trans "å–æ¶ˆ" %}</a>
                <button type="button"
                        onclick="confirmDelete('{% url 'administration:tag_delete' object.pk %}', '{% trans "ç¡®å®šè¦åˆ é™¤æ ‡ç­¾" %}ã€Š{{ object.name|escapejs }}ã€‹{% trans "å—ï¼Ÿ" %}')"
                        class="btn btn-sm btn-ghost text-error hover:bg-error/10">{% trans "åˆ é™¤æ ‡ç­¾" %}</button>
            </div>
        {% else %}
            <div class="divider my-1"></div>
            <a href="javascript:history.back()"
               class="btn btn-sm btn-ghost text-base-content/60 w-full">{% trans "å–æ¶ˆ" %}</a>
        {% endif %}
    </div>
{% endcaptureas %}
{% trans "å‘å¸ƒ" as t_title %}
{% include "administration/components/form_card.html" with title=t_title icon="publish" content=publish_content %}
<!-- Status Box -->
{% captureas status_content %}
<div class="form-control">
    <label class="label cursor-pointer justify-between">
        <span class="label-text font-medium">{% trans "å¯ç”¨çŠ¶æ€" %}</span>
        {% render_field form.is_active class="toggle toggle-success" %}
    </label>
    <label class="label">
        <span class="label-text-alt text-base-content/60">{% trans "ç¦ç”¨åï¼Œè¯¥æ ‡ç­¾å°†ä¸ä¼šåœ¨å‰ç«¯æ˜¾ç¤ºã€‚" %}</span>
    </label>
</div>
{% endcaptureas %}
{% trans "çŠ¶æ€è®¾ç½®" as t_title %}
{% include "administration/components/form_card.html" with title=t_title icon="toggle_on" content=status_content %}
<!-- Appearance Box -->
{% captureas appearance_content %}
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Icon Field -->
    <div class="form-control w-full"
         x-data="{ icon: '{{ form.icon.value|default_if_none:""|escapejs }}' }">
        <label class="label">
            <span class="label-text font-bold text-base">{% trans "å›¾æ ‡ (Material Symbols)" %}</span>
        </label>
        <div class="join">
            {% render_field form.icon class="input input-bordered w-full join-item focus:input-primary transition-all font-mono" placeholder="tag" x-model="icon" %}
            <div class="join-item btn btn-square no-animation bg-base-200 border-base-300">
                <span class="material-symbols-outlined" x-text="icon || 'tag'">tag</span>
            </div>
        </div>
        {% if form.icon.errors %}
            <label class="label">
                <span class="label-text-alt text-error">{{ form.icon.errors.0 }}</span>
            </label>
        {% endif %}
    </div>
    <!-- Color Field -->
    <div class="form-control w-full">
        <label class="label">
            <span class="label-text font-bold text-base">{% trans "é¢œè‰²æ ‡è¯†" %}</span>
        </label>
        {% include 'components/color_picker.html' with value=form.color.value name=form.color.name %}
        {% if form.color.errors %}
            <label class="label">
                <span class="label-text-alt text-error">{{ form.color.errors.0 }}</span>
            </label>
        {% endif %}
    </div>
</div>
{% endcaptureas %}
{% trans "å¤–è§‚è®¾ç½®" as t_title %}
{% include "administration/components/form_card.html" with title=t_title icon="palette" content=appearance_content %}
</div>
</form>
{% endblock %}
