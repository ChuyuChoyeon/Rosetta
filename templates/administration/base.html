{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="zh-hans">
<head>
    <script>
        // Theme initialization to prevent FOUC
        (function() {
            try {
                // 1. Get stored theme or system preference
                var localTheme = localStorage.getItem('theme');
                var theme = localTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                
                // 2. Server-side user preference override
                {% if user.is_authenticated and user.preference.theme %}
                    theme = "{{ user.preference.theme }}";
                    localStorage.setItem('theme', theme);
                {% endif %}

                // 3. Apply theme immediately
                document.documentElement.setAttribute('data-theme', theme);
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            } catch (e) {
                console.error('Theme initialization error:', e);
            }
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="{{ config.SITE_FAVICON|default:'/static/core/img/favicon.ico' }}">
    <title>{% block title %}{{ config.SITE_HEADER|default:"Rosetta Dashboard" }}{% endblock %}</title>
    {% tailwind_css %}

    <!-- NProgress & PageLoader -->
    <script src="{% static 'theme/js/nprogress.js' %}"></script>
    <link rel="stylesheet" href="{% static 'theme/css/nprogress.css' %}" />
    <script src="{% static 'js/page-loader.js' %}"></script>
    
    <!-- Alpine.js -->
    <script defer src="{% static 'theme/js/alpine.min.js' %}"></script>
    
    <!-- HTMX -->
    <script src="{% static 'theme/js/htmx.min.js' %}"></script>
    <script src="{% static 'js/htmx-init.js' %}"></script>
    
    <!-- Global UI Helpers -->
    <script src="{% static 'js/ui-helpers.js' %}"></script>
    
    <!-- ApexCharts -->
    <script src="{% static 'theme/js/apexcharts.min.js' %}"></script>

    <!-- Editor Styles & Scripts (Only loaded when needed) -->
    <link rel="stylesheet" href="{% static 'js/editor.css' %}?v=4.1">
    <script defer src="{% static 'js/editor.js' %}?v=4.1"></script>

    {% block extra_head %}{% endblock %}
    
    <!-- FontAwesome (Required by Toast UI) -->
    <link rel="stylesheet" href="{% static 'theme/css/all.min.css' %}">
    
    <!-- Local Material Symbols -->
    <style>
        [x-cloak] { display: none !important; }
        @font-face {
            font-family: 'Material Symbols Outlined';
            font-style: normal;
            font-weight: 100 700;
            font-display: swap;
            src: url("{% static 'theme/fonts/MaterialSymbolsOutlined.woff2' %}") format('woff2');
        }
        .material-symbols-outlined {
            font-family: 'Material Symbols Outlined';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }
    </style>
    
    <!-- Toast UI Editor -->
    <link rel="stylesheet" href="{% static 'theme/css/toastui-editor.min.css' %}" />
    <link rel="stylesheet" href="{% static 'theme/css/toastui-editor-dark.min.css' %}" />
    <link rel="stylesheet" href="{% static 'theme/css/editor-overrides.css' %}" />
    <script src="{% static 'theme/js/toastui-editor-all.min.js' %}"></script>
</head>
<body class="min-h-screen flex flex-col scrollbar-thin scrollbar-thumb-base-300 scrollbar-track-base-100 {% if debug %}debug-screens{% endif %}" 
      hx-boost="true" 
      hx-ext="class-tools"
      hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>

    <!-- Inspira UI: Neural Background -->
    {% include 'components/inspira/neural_background.html' %}

    <!-- Navbar -->
    <div class="navbar bg-base-100/80 backdrop-blur-md shadow-sm border-b border-base-content/5 z-40 sticky top-0 flex-col lg:flex-row lg:justify-between h-auto lg:h-16 py-2 lg:py-0 transition-all duration-300">
        <!-- Mobile Wrapper -->
        <div class="w-full flex flex-col lg:flex-row lg:items-center lg:w-auto">
            <!-- Line 1: Logo & Title -->
            <div class="w-full flex justify-center lg:justify-start lg:w-auto py-2 lg:py-0">
                <a href="{% url 'administration:index' %}" class="normal-case text-xl flex items-center gap-3 font-bold text-base-content hover:opacity-80 transition-opacity">
                    {% if config.SHOW_SITE_LOGO and config.SITE_LOGO %}
                    <img src="{{ config.SITE_LOGO }}" alt="Admin Logo" class="h-8 w-auto object-contain">
                    {% else %}
                    <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                        <span class="material-symbols-outlined text-xl">admin_panel_settings</span>
                    </div>
                    {% endif %}
                    <span class="bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent font-extrabold tracking-tight">{{ config.ADMIN_NAVBAR_TITLE|default:"Rosetta Admin" }}</span>
                </a>
            </div>
            
            <!-- Line 2: Drawer Toggle & Actions (Mobile Only) -->
        <div class="flex justify-between items-center w-full lg:hidden px-2 pb-2">
                <!-- Drawer Button -->
                <label for="my-drawer-2" class="btn btn-square btn-ghost drawer-button">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-5 h-5 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </label>

                <!-- Mobile Right Actions (Theme & User) -->
                <div class="flex items-center gap-1">
                <button type="button" class="btn btn-ghost btn-circle btn-sm hover:bg-primary/10 hover:text-primary transition-colors" onclick="window.openCommandPalette && window.openCommandPalette(event)">
                    <span class="material-symbols-outlined text-base">search</span>
                </button>
                    <!-- Mobile Theme Switcher -->
                    <label class="swap swap-rotate btn btn-ghost btn-circle btn-sm hover:bg-primary/10 hover:text-primary transition-colors">
                        <input type="checkbox" class="theme-controller hidden" value="dark" onchange="updateTheme(this.checked ? 'dark' : 'light')" />
                        <span class="material-symbols-outlined swap-off text-[20px] w-5 h-5 leading-none">light_mode</span>
                        <span class="material-symbols-outlined swap-on text-[20px] w-5 h-5 leading-none">dark_mode</span>
                    </label>
                    
                    <!-- Mobile User Avatar -->
                    <div class="dropdown dropdown-end ml-1">
                        <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar btn-sm">
                            <div class="w-8 rounded-full ring ring-primary ring-offset-base-100 ring-offset-1">
                                <img alt="{{ request.user.username }}" src="{{ request.user.get_avatar_url }}" />
                            </div>
                        </div>
                        <ul tabindex="0" class="mt-3 z-50 p-2 shadow menu menu-sm dropdown-content bg-base-100 rounded-box w-52">
                            <li><a href="{% url 'users:profile' %}" hx-boost="false">个人资料</a></li>
                            <li><a href="{% url 'users:logout' %}" hx-boost="false">退出登录</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Desktop Actions (Hidden on Mobile) -->
        <div class="hidden lg:flex flex-none gap-2 items-center">
            <a href="/" target="_blank" class="btn btn-ghost btn-sm" hx-boost="false">
                查看站点
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-4 h-4 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
            </a>
            <button type="button" class="input input-sm input-bordered flex items-center gap-2 w-64 bg-base-100/70 hover:bg-base-100 transition-all" onclick="window.openCommandPalette && window.openCommandPalette(event)">
                <span class="material-symbols-outlined text-base text-base-content/50">search</span>
                <span class="text-sm text-base-content/60">搜索命令或页面…</span>
                <div class="ml-auto flex items-center gap-1 text-[10px] text-base-content/50">
                    <kbd class="h-5 px-1.5 rounded border border-base-content/20 bg-base-100">Ctrl</kbd>
                    <kbd class="h-5 px-1.5 rounded border border-base-content/20 bg-base-100">K</kbd>
                </div>
            </button>
            
            <!-- Theme Switcher -->
            <label class="swap swap-rotate btn btn-ghost btn-circle hover:bg-primary/10 hover:text-primary transition-colors">
              <!-- this hidden checkbox controls the state -->
              <input type="checkbox" 
                     class="theme-controller hidden" 
                     value="dark"
                     onchange="updateTheme(this.checked ? 'dark' : 'light')"
                     id="theme-toggle-admin" />
              
              <!-- sun icon -->
              <span class="material-symbols-outlined swap-off text-[20px] w-5 h-5 leading-none">light_mode</span>
              
              <!-- moon icon -->
              <span class="material-symbols-outlined swap-on text-[20px] w-5 h-5 leading-none">dark_mode</span>
            </label>

            <script>
                function updateTheme(theme) {
                    // Use ThemeManager if available (from global theme.js)
                    if (window.ThemeManager) {
                        window.ThemeManager.updateTheme(theme);
                    } else {
                        // Fallback implementation
                        document.documentElement.setAttribute('data-theme', theme);
                        if (theme === 'dark') {
                            document.documentElement.classList.add('dark');
                        } else {
                            document.documentElement.classList.remove('dark');
                        }
                        localStorage.setItem('theme', theme);
                    }
                    
                    {% if user.is_authenticated %}
                    // Asynchronously save preference with debounce
                    if (window.themeUpdateTimeout) clearTimeout(window.themeUpdateTimeout);
                    window.themeUpdateTimeout = setTimeout(() => {
                        fetch("{% url 'users:update_theme' %}", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": "{{ csrf_token }}"
                            },
                            body: JSON.stringify({ theme: theme })
                        }).catch(console.error);
                    }, 500);
                    {% endif %}
                }
            </script>

            <!-- User Dropdown -->
            <div class="dropdown dropdown-end ml-2 z-50">
                <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar">
                    <div class="w-10 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                        <img alt="{{ request.user.nickname|default:request.user.username }}" src="{{ request.user.get_avatar_url }}" />
                    </div>
                </div>
                <ul tabindex="0" class="mt-3 z-[1] p-2 shadow menu menu-sm dropdown-content bg-base-100 rounded-box w-52">
                    <li class="menu-title px-4 py-2 bg-base-200/50 rounded-t-box -mx-2 -mt-2 mb-1 border-b border-base-200">
                        <div class="flex flex-col gap-0.5">
                            <span class="text-base-content font-bold text-lg">{{ request.user.nickname|default:request.user.username }}</span>
                            <span class="text-xs font-normal text-base-content/60">@{{ request.user.username }}</span>
                        </div>
                    </li>
                    <li><a href="{% url 'users:profile' %}" hx-boost="false">个人资料</a></li>
                    <li><a href="{% url 'users:logout' %}" hx-boost="false">退出登录</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Main Content with Sidebar -->
    <div class="drawer lg:drawer-open flex-1">
        <input id="my-drawer-2" type="checkbox" class="drawer-toggle" />
        <div class="drawer-content flex flex-col p-6 pt-20">
            <!-- Page Content -->
            {% include 'components/toast.html' %}
            
            {% block content %}{% endblock %}
        </div> 
        <div class="drawer-side z-50">
            <label for="my-drawer-2" aria-label="close sidebar" class="drawer-overlay"></label> 
            <ul class="menu p-4 w-64 min-h-full bg-base-100/90 backdrop-blur-lg text-base-content gap-1 border-r border-base-content/5">
                <!-- Sidebar content here -->
                <li class="mb-2">
                    <a href="{% url 'administration:index' %}" class="{% if request.resolver_match.url_name == 'index' %}active bg-primary text-primary-content shadow-lg shadow-primary/20 scale-[1.02]{% else %}hover:bg-base-200 hover:scale-[1.02]{% endif %} transition-all duration-200 rounded-xl py-3 font-medium">
                        <span class="material-symbols-outlined {% if request.resolver_match.url_name == 'index' %}text-primary-content{% else %}text-primary{% endif %}">dashboard</span>
                        概览
                    </a>
                </li>
                
                <li class="menu-title text-xs font-bold uppercase tracking-wider opacity-50 mt-4 mb-2 px-2">内容管理</li>
                <li>
                    <a href="{% url 'administration:post_list' %}" class="{% if 'post' in request.resolver_match.url_name %}active bg-primary/10 text-primary border-l-4 border-primary font-bold{% else %}hover:bg-base-200{% endif %} transition-all duration-200 rounded-r-xl rounded-l-none -ml-4 pl-8 py-2.5">
                        <span class="material-symbols-outlined {% if 'post' in request.resolver_match.url_name %}text-primary{% else %}text-secondary{% endif %}">article</span>
                        文章
                    </a>
                </li>
                <li>
                    <a href="{% url 'administration:category_list' %}" class="{% if 'category' in request.resolver_match.url_name %}active bg-primary/10 text-primary border-l-4 border-primary font-bold{% else %}hover:bg-base-200{% endif %} transition-all duration-200 rounded-r-xl rounded-l-none -ml-4 pl-8 py-2.5">
                        <span class="material-symbols-outlined {% if 'category' in request.resolver_match.url_name %}text-primary{% else %}text-secondary{% endif %}">category</span>
                        分类
                    </a>
                </li>
                <li>
                    <a href="{% url 'administration:tag_list' %}" class="{% if 'tag' in request.resolver_match.url_name %}active bg-primary/10 text-primary border-l-4 border-primary font-bold{% else %}hover:bg-base-200{% endif %} transition-all duration-200 rounded-r-xl rounded-l-none -ml-4 pl-8 py-2.5">
                        <span class="material-symbols-outlined {% if 'tag' in request.resolver_match.url_name %}text-primary{% else %}text-secondary{% endif %}">label</span>
                        标签
                    </a>
                </li>
                <li>
                    <a href="{% url 'administration:comment_list' %}" class="{% if 'comment' in request.resolver_match.url_name %}active bg-primary/10 text-primary border-l-4 border-primary font-bold{% else %}hover:bg-base-200{% endif %} transition-all duration-200 rounded-r-xl rounded-l-none -ml-4 pl-8 py-2.5 justify-between">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined {% if 'comment' in request.resolver_match.url_name %}text-primary{% else %}text-secondary{% endif %}">comment</span>
                            评论
                        </div>
                        {% if pending_comments > 0 %}
                        <span class="badge badge-sm badge-error animate-pulse">{{ pending_comments }}</span>
                        {% endif %}
                    </a>
                </li>
                <li>
                    <a href="{% url 'administration:poll_list' %}" class="{% if 'poll' in request.resolver_match.url_name %}active bg-primary/10 text-primary border-l-4 border-primary font-bold{% else %}hover:bg-base-200{% endif %} transition-all duration-200 rounded-r-xl rounded-l-none -ml-4 pl-8 py-2.5">
                        <span class="material-symbols-outlined {% if 'poll' in request.resolver_match.url_name %}text-primary{% else %}text-secondary{% endif %}">poll</span>
                        投票
                    </a>
                </li>

                <li class="menu-title text-xs font-bold uppercase tracking-wider opacity-50 mt-4 mb-2 px-2">页面管理</li>
                <li>
                    <a href="{% url 'administration:page_list' %}" class="{% if 'page' in request.resolver_match.url_name %}active bg-primary/10 text-primary border-l-4 border-primary font-bold{% else %}hover:bg-base-200{% endif %} transition-all duration-200 rounded-r-xl rounded-l-none -ml-4 pl-8 py-2.5">
                        <span class="material-symbols-outlined {% if 'page' in request.resolver_match.url_name %}text-primary{% else %}text-accent{% endif %}">description</span>
                        页面
                    </a>
                </li>
                <li>
                    <a href="{% url 'administration:navigation_list' %}" class="{% if 'navigation' in request.resolver_match.url_name %}active bg-primary/10 text-primary border-l-4 border-primary font-bold{% else %}hover:bg-base-200{% endif %} transition-all duration-200 rounded-r-xl rounded-l-none -ml-4 pl-8 py-2.5">
                        <span class="material-symbols-outlined {% if 'navigation' in request.resolver_match.url_name %}text-primary{% else %}text-accent{% endif %}">menu</span>
                        导航
                    </a>
                </li>
                <li>
                    <a href="{% url 'administration:friendlink_list' %}" class="{% if 'friendlink' in request.resolver_match.url_name %}active bg-primary/10 text-primary border-l-4 border-primary font-bold{% else %}hover:bg-base-200{% endif %} transition-all duration-200 rounded-r-xl rounded-l-none -ml-4 pl-8 py-2.5">
                        <span class="material-symbols-outlined {% if 'friendlink' in request.resolver_match.url_name %}text-primary{% else %}text-accent{% endif %}">link</span>
                        友情链接
                    </a>
                </li>
                <li>
                    <a href="{% url 'administration:searchplaceholder_list' %}" class="{% if 'searchplaceholder' in request.resolver_match.url_name %}active bg-primary/10 text-primary border-l-4 border-primary font-bold{% else %}hover:bg-base-200{% endif %} transition-all duration-200 rounded-r-xl rounded-l-none -ml-4 pl-8 py-2.5">
                        <span class="material-symbols-outlined {% if 'searchplaceholder' in request.resolver_match.url_name %}text-primary{% else %}text-accent{% endif %}">manage_search</span>
                        搜索占位符
                    </a>
                </li>

                <li class="menu-title text-xs font-bold uppercase tracking-wider opacity-50 mt-4 mb-2 px-2">系统管理</li>
                <li>
                    <a href="{% url 'administration:user_list' %}" class="{% if 'user' in request.resolver_match.url_name and 'title' not in request.resolver_match.url_name %}active bg-primary/10 text-primary border-l-4 border-primary font-bold{% else %}hover:bg-base-200{% endif %} transition-all duration-200 rounded-r-xl rounded-l-none -ml-4 pl-8 py-2.5">
                        <span class="material-symbols-outlined {% if 'user' in request.resolver_match.url_name and 'title' not in request.resolver_match.url_name %}text-primary{% else %}text-info{% endif %}">group</span>
                        用户
                    </a>
                </li>
                <li>
                    <a href="{% url 'administration:usertitle_list' %}" class="{% if 'usertitle' in request.resolver_match.url_name %}active bg-primary/10 text-primary border-l-4 border-primary font-bold{% else %}hover:bg-base-200{% endif %} transition-all duration-200 rounded-r-xl rounded-l-none -ml-4 pl-8 py-2.5">
                        <span class="material-symbols-outlined {% if 'usertitle' in request.resolver_match.url_name %}text-primary{% else %}text-info{% endif %}">badge</span>
                        称号
                    </a>
                </li>
                <li>
                    <a href="{% url 'administration:group_list' %}" class="{% if 'group' in request.resolver_match.url_name %}active bg-primary/10 text-primary border-l-4 border-primary font-bold{% else %}hover:bg-base-200{% endif %} transition-all duration-200 rounded-r-xl rounded-l-none -ml-4 pl-8 py-2.5">
                        <span class="material-symbols-outlined {% if 'group' in request.resolver_match.url_name %}text-primary{% else %}text-info{% endif %}">groups</span>
                        用户组
                    </a>
                </li>

                <li class="menu-title text-xs font-bold uppercase tracking-wider opacity-50 mt-4 mb-2 px-2">日志与审计</li>
                <li>
                    <a href="{% url 'administration:logentry_list' %}" class="{% if 'logentry' in request.resolver_match.url_name %}active bg-primary/10 text-primary border-l-4 border-primary font-bold{% else %}hover:bg-base-200{% endif %} transition-all duration-200 rounded-r-xl rounded-l-none -ml-4 pl-8 py-2.5">
                        <span class="material-symbols-outlined {% if 'logentry' in request.resolver_match.url_name %}text-primary{% else %}text-warning{% endif %}">history</span>
                        操作日志
                    </a>
                </li>
                <li>
                    <a href="{% url 'administration:logfile_list' %}" class="{% if 'logfile' in request.resolver_match.url_name %}active bg-primary/10 text-primary border-l-4 border-primary font-bold{% else %}hover:bg-base-200{% endif %} transition-all duration-200 rounded-r-xl rounded-l-none -ml-4 pl-8 py-2.5">
                        <span class="material-symbols-outlined {% if 'logfile' in request.resolver_match.url_name %}text-primary{% else %}text-warning{% endif %}">description</span>
                        系统日志
                    </a>
                </li>

                <li class="menu-title text-xs font-bold uppercase tracking-wider opacity-50 mt-4 mb-2 px-2">维护与工具</li>
                <li>
                    <a href="{% url 'administration:system_tools' %}" class="{% if request.resolver_match.url_name == 'system_tools' %}active bg-primary/10 text-primary border-l-4 border-primary font-bold{% else %}hover:bg-base-200{% endif %} transition-all duration-200 rounded-r-xl rounded-l-none -ml-4 pl-8 py-2.5">
                        <span class="material-symbols-outlined {% if request.resolver_match.url_name == 'system_tools' %}text-primary{% else %}text-info{% endif %}">build_circle</span>
                        系统工具
                    </a>
                </li>
                <li>
                    <a href="{% url 'administration:settings' %}" class="{% if request.resolver_match.url_name == 'settings' %}active bg-primary/10 text-primary border-l-4 border-primary font-bold{% else %}hover:bg-base-200{% endif %} transition-all duration-200 rounded-r-xl rounded-l-none -ml-4 pl-8 py-2.5">
                        <span class="material-symbols-outlined {% if request.resolver_match.url_name == 'settings' %}text-primary{% else %}text-info{% endif %}">settings</span>
                        站点设置
                    </a>
                </li>
                <li>
                    <a href="{% url 'administration:debug' %}" class="{% if request.resolver_match.url_name == 'debug' %}active bg-primary/10 text-primary border-l-4 border-primary font-bold{% else %}hover:bg-base-200{% endif %} transition-all duration-200 rounded-r-xl rounded-l-none -ml-4 pl-8 py-2.5">
                        <span class="material-symbols-outlined {% if request.resolver_match.url_name == 'debug' %}text-primary{% else %}text-warning{% endif %}">bug_report</span>
                        调试工具
                    </a>
                </li>
                
                <div class="divider my-4"></div>
                
                <li>
                    <a href="{% url 'users:logout' %}" class="text-error hover:bg-error/10 transition-colors duration-200 rounded-lg mx-2">
                        <span class="material-symbols-outlined">logout</span>
                        退出登录
                    </a>
                </li>
            </ul>
        
        </div>
    </div>

    {% block modal %}{% endblock %}
    
    <!-- Footer -->
    <footer class="footer footer-center p-4 bg-base-100 text-base-content border-t border-base-200 mt-auto">
        <div>
            <p class="text-sm opacity-70">{{ config.FOOTER_TEXT|default:"Copyright © 2026 - All rights reserved" }}</p>
        </div>
    </footer>

    <script>
        document.body.addEventListener('htmx:configRequest', (event) => {
            event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
        });
        
        // Bulk Actions Scripts
        function toggleAll(source) {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = source.checked;
            });
            updateBulkToolbar();
        }

        function updateBulkToolbar() {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            const toolbar = document.getElementById('bulk-actions');
            const countSpan = document.getElementById('selected-count');
            
            if (toolbar) {
                if (checkboxes.length > 0) {
                    toolbar.classList.remove('hidden');
                    countSpan.innerText = checkboxes.length;
                } else {
                    toolbar.classList.add('hidden');
                }
            }
        }

        function submitBulkAction(action) {
            showConfirmModal(
                '批量操作',
                '确定要执行此批量操作吗？',
                () => {
                    const form = document.getElementById('bulk-form');
                    const actionInput = document.createElement('input');
                    actionInput.type = 'hidden';
                    actionInput.name = 'action';
                    actionInput.value = action;
                    form.appendChild(actionInput);
                    form.submit();
                }
            );
        }
    </script>
    
    <!-- Global Modals -->
    {% include 'components/confirm_modal.html' %}
    
    <!-- Global Command Palette -->
    <div x-data="{ 
        open: false,
        search: '',
        activeIndex: 0,
        items: [
            { id: 'dashboard', title: '管理后台首页', icon: 'dashboard', url: '{% url 'administration:index' %}', group: '导航', keywords: '首页 概览 仪表盘' },
            { id: 'posts', title: '文章列表', icon: 'article', url: '{% url 'administration:post_list' %}', group: '内容', keywords: '文章 内容 列表' },
            { id: 'new_post', title: '新建文章', icon: 'add_circle', url: '{% url 'administration:post_create' %}', group: '内容', keywords: '文章 新建 新增 写作' },
            { id: 'categories', title: '分类列表', icon: 'category', url: '{% url 'administration:category_list' %}', group: '内容', keywords: '分类 列表' },
            { id: 'category_create', title: '新建分类', icon: 'add_circle', url: '{% url 'administration:category_create' %}', group: '内容', keywords: '分类 新建 新增' },
            { id: 'category_export', title: '导出分类', icon: 'download', url: '{% url 'administration:category_export' %}', group: '内容', keywords: '分类 导出' },
            { id: 'category_import', title: '导入分类', icon: 'upload', url: '{% url 'administration:category_import' %}', group: '内容', keywords: '分类 导入' },
            { id: 'tags', title: '标签列表', icon: 'label', url: '{% url 'administration:tag_list' %}', group: '内容', keywords: '标签 列表' },
            { id: 'tag_create', title: '新建标签', icon: 'add_circle', url: '{% url 'administration:tag_create' %}', group: '内容', keywords: '标签 新建 新增' },
            { id: 'comments', title: '评论列表', icon: 'comment', url: '{% url 'administration:comment_list' %}', group: '内容', keywords: '评论 审核 列表' },
            { id: 'pages', title: '页面列表', icon: 'description', url: '{% url 'administration:page_list' %}', group: '页面', keywords: '单页 页面 列表' },
            { id: 'page_create', title: '新建页面', icon: 'add_circle', url: '{% url 'administration:page_create' %}', group: '页面', keywords: '页面 新建 新增' },
            { id: 'navigation', title: '导航管理', icon: 'menu', url: '{% url 'administration:navigation_list' %}', group: '外观', keywords: '导航 菜单 列表' },
            { id: 'navigation_create', title: '新建导航', icon: 'add_circle', url: '{% url 'administration:navigation_create' %}', group: '外观', keywords: '导航 新建 新增' },
            { id: 'navigation_export', title: '导出导航', icon: 'download', url: '{% url 'administration:navigation_export' %}', group: '外观', keywords: '导航 导出' },
            { id: 'navigation_import', title: '导入导航', icon: 'upload', url: '{% url 'administration:navigation_import' %}', group: '外观', keywords: '导航 导入' },
            { id: 'polls', title: '投票列表', icon: 'poll', url: '{% url 'administration:poll_list' %}', group: '内容', keywords: '投票 问卷 列表' },
            { id: 'poll_create', title: '新建投票', icon: 'add_circle', url: '{% url 'administration:poll_create' %}', group: '内容', keywords: '投票 新建 新增' },
            { id: 'friendlinks', title: '友情链接管理', icon: 'link', url: '{% url 'administration:friendlink_list' %}', group: '外观', keywords: '友链 列表' },
            { id: 'friendlink_create', title: '新建友情链接', icon: 'add_circle', url: '{% url 'administration:friendlink_create' %}', group: '外观', keywords: '友链 新建 新增' },
            { id: 'friendlink_export', title: '导出友情链接', icon: 'download', url: '{% url 'administration:friendlink_export' %}', group: '外观', keywords: '友链 导出' },
            { id: 'friendlink_import', title: '导入友情链接', icon: 'upload', url: '{% url 'administration:friendlink_import' %}', group: '外观', keywords: '友链 导入' },
            { id: 'placeholders', title: '搜索占位符', icon: 'manage_search', url: '{% url 'administration:searchplaceholder_list' %}', group: '外观', keywords: '搜索 占位符 列表' },
            { id: 'placeholder_create', title: '新建搜索占位符', icon: 'add_circle', url: '{% url 'administration:searchplaceholder_create' %}', group: '外观', keywords: '占位符 新建 新增' },
            { id: 'placeholder_export', title: '导出搜索占位符', icon: 'download', url: '{% url 'administration:searchplaceholder_export' %}', group: '外观', keywords: '占位符 导出' },
            { id: 'placeholder_import', title: '导入搜索占位符', icon: 'upload', url: '{% url 'administration:searchplaceholder_import' %}', group: '外观', keywords: '占位符 导入' },
            { id: 'users', title: '用户列表', icon: 'group', url: '{% url 'administration:user_list' %}', group: '用户与权限', keywords: '用户 列表' },
            { id: 'user_create', title: '新建用户', icon: 'person_add', url: '{% url 'administration:user_create' %}', group: '用户与权限', keywords: '用户 新建 新增' },
            { id: 'user_export', title: '导出用户', icon: 'download', url: '{% url 'administration:user_export' %}', group: '用户与权限', keywords: '用户 导出' },
            { id: 'user_import', title: '导入用户', icon: 'upload', url: '{% url 'administration:user_import' %}', group: '用户与权限', keywords: '用户 导入' },
            { id: 'usertitle', title: '用户称号', icon: 'badge', url: '{% url 'administration:usertitle_list' %}', group: '用户与权限', keywords: '称号 头衔 列表' },
            { id: 'usertitle_create', title: '新建用户称号', icon: 'add_circle', url: '{% url 'administration:usertitle_create' %}', group: '用户与权限', keywords: '称号 新建 新增' },
            { id: 'usertitle_export', title: '导出用户称号', icon: 'download', url: '{% url 'administration:usertitle_export' %}', group: '用户与权限', keywords: '称号 导出' },
            { id: 'usertitle_import', title: '导入用户称号', icon: 'upload', url: '{% url 'administration:usertitle_import' %}', group: '用户与权限', keywords: '称号 导入' },
            { id: 'groups', title: '用户组管理', icon: 'groups', url: '{% url 'administration:group_list' %}', group: '用户与权限', keywords: '用户组 列表' },
            { id: 'group_create', title: '新建用户组', icon: 'add_circle', url: '{% url 'administration:group_create' %}', group: '用户与权限', keywords: '用户组 新建 新增' },
            { id: 'group_export', title: '导出用户组', icon: 'download', url: '{% url 'administration:group_export' %}', group: '用户与权限', keywords: '用户组 导出' },
            { id: 'group_import', title: '导入用户组', icon: 'upload', url: '{% url 'administration:group_import' %}', group: '用户与权限', keywords: '用户组 导入' },
            { id: 'logentry', title: '操作日志', icon: 'history', url: '{% url 'administration:logentry_list' %}', group: '日志', keywords: '审计 日志 操作记录' },
            { id: 'logentry_export', title: '导出操作日志', icon: 'download', url: '{% url 'administration:logentry_export' %}', group: '日志', keywords: '日志 导出' },
            { id: 'logfile', title: '系统日志', icon: 'description', url: '{% url 'administration:logfile_list' %}', group: '日志', keywords: '系统 日志 文件' },
            { id: 'system_tools', title: '系统工具', icon: 'build_circle', url: '{% url 'administration:system_tools' %}', group: '系统工具', keywords: '系统 维护 索引 图片' },
            { id: 'settings', title: '站点设置', icon: 'settings', url: '{% url 'administration:settings' %}', group: '系统工具', keywords: '设置 配置 参数' },
            { id: 'debug', title: '调试面板', icon: 'bug_report', url: '{% url 'administration:debug' %}', group: '调试', keywords: '调试 面板' },
            { id: 'debug_ui', title: '调试 UI 测试', icon: 'design_services', url: '{% url 'administration:debug_ui_test' %}', group: '调试', keywords: '调试 UI 组件' },
            { id: 'debug_permission', title: '调试 权限检查', icon: 'security', url: '{% url 'administration:debug_permission' %}', group: '调试', keywords: '调试 权限' },
            { id: 'debug_mock', title: '调试 模拟数据', icon: 'science', url: '{% url 'administration:debug_mock' %}', group: '调试', keywords: '调试 模拟' },
            { id: 'debug_cache', title: '调试 缓存状态', icon: 'memory', url: '{% url 'administration:debug_cache' %}', group: '调试', keywords: '调试 缓存' },
            { id: 'debug_email', title: '调试 邮件发送', icon: 'mail', url: '{% url 'administration:debug_email' %}', group: '调试', keywords: '调试 邮件' },
            { id: 'profile', title: '个人资料', icon: 'person', url: '{% url 'users:profile' %}', group: '账户', keywords: '资料 账户' },
            { id: 'logout', title: '退出登录', icon: 'logout', url: '{% url 'users:logout' %}', group: '账户', keywords: '登出 退出' },
            { id: 'site', title: '查看站点', icon: 'public', url: '/', group: '外部', keywords: '前台 站点 首页' }
        ],
        get filteredItems() {
            const query = this.search.trim();
            if (query === '') return this.items;
            
            // Try pinyin matching first if available
            if (window.PinyinMatch) {
                return this.items.filter(item => {
                    const text = `${item.title} ${item.group} ${item.keywords || ''}`;
                    return window.PinyinMatch.match(text, query);
                });
            }
            
            // Fallback to simple string matching
            const lowerQuery = query.toLowerCase();
            return this.items.filter(item => {
                const haystack = `${item.title} ${item.group} ${item.keywords || ''}`.toLowerCase();
                return haystack.includes(lowerQuery);
            });
        },
        selectItem(index) {
            if (this.filteredItems.length > 0) {
                window.location.href = this.filteredItems[index].url;
            }
        }
    }"
    x-init="window.openCommandPalette = (event) => { if (!event || event.isTrusted !== true) return; open = true; $nextTick(() => $refs.searchInput.focus()); }; window.closeCommandPalette = () => { open = false; }"
    @keydown.window.prevent.ctrl.k="open = !open; if(open) $nextTick(() => $refs.searchInput.focus());"
    @keydown.window.prevent.meta.k="open = !open; if(open) $nextTick(() => $refs.searchInput.focus());"
    @keydown.escape.window="open = false"
    class="relative z-[1000]">

        <!-- Backdrop -->
        <div x-show="open" x-cloak style="display: none;"
             x-transition:enter="ease-out duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="ease-in duration-200"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity" 
             @click="open = false"></div>

        <!-- Palette Modal -->
        <div x-show="open" x-cloak style="display: none;"
             x-transition:enter="ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave="ease-in duration-200"
             x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             class="fixed inset-0 z-30 overflow-y-auto p-4 sm:p-6 md:p-20">
            
            <div class="mx-auto max-w-xl transform divide-y divide-base-content/10 overflow-hidden rounded-2xl bg-base-100 shadow-2xl ring-1 ring-black/5 transition-all">
                <div class="relative">
                    <span class="material-symbols-outlined pointer-events-none absolute top-3.5 left-4 h-5 w-5 text-base-content/40">search</span>
                    <input type="text" 
                           x-ref="searchInput"
                           x-model="search"
                           @keydown.arrow-down.prevent="activeIndex = Math.min(activeIndex + 1, filteredItems.length - 1)"
                           @keydown.arrow-up.prevent="activeIndex = Math.max(activeIndex - 1, 0)"
                           @keydown.enter.prevent="selectItem(activeIndex)"
                           class="h-12 w-full border-0 bg-transparent pl-11 pr-4 text-base-content placeholder:text-base-content/40 focus:ring-0 sm:text-sm" 
                           placeholder="搜索命令或页面…（Ctrl+K）">
                </div>

                <ul class="max-h-96 scroll-py-3 overflow-y-auto p-3" x-show="filteredItems.length > 0">
                    <template x-for="(item, index) in filteredItems" :key="item.id">
                        <li class="group flex cursor-default select-none rounded-xl p-3"
                            :class="{ 'bg-primary/10 text-primary': activeIndex === index, 'text-base-content': activeIndex !== index }"
                            @mouseenter="activeIndex = index"
                            @click="selectItem(index)">
                            <div class="flex h-10 w-10 flex-none items-center justify-center rounded-lg"
                                 :class="{ 'bg-primary/20': activeIndex === index, 'bg-base-200': activeIndex !== index }">
                                <span class="material-symbols-outlined" x-text="item.icon"></span>
                            </div>
                            <div class="ml-4 flex-auto">
                                <p class="text-sm font-medium" :class="{ 'text-primary': activeIndex === index }" x-text="item.title"></p>
                                <p class="text-xs opacity-60" x-text="item.group"></p>
                            </div>
                            <div x-show="activeIndex === index" class="flex-none text-primary">
                                <span class="material-symbols-outlined">subdirectory_arrow_left</span>
                            </div>
                        </li>
                    </template>
                </ul>

                <div x-show="filteredItems.length === 0" class="py-14 px-6 text-center text-sm sm:px-14">
                    <span class="material-symbols-outlined mx-auto h-6 w-6 text-base-content/40">sentiment_dissatisfied</span>
                    <p class="mt-4 font-semibold text-base-content">未找到匹配结果</p>
                    <p class="mt-2 text-base-content/60">没有找到对应的命令，请尝试更换关键词。</p>
                </div>
                
                <div class="flex flex-wrap items-center bg-base-200/50 py-2.5 px-4 text-xs text-base-content/60">
                    <kbd class="mx-1 flex h-5 w-5 items-center justify-center rounded border border-base-content/20 bg-base-100 font-semibold text-base-content sm:mx-2"><span class="text-lg">↑</span></kbd>
                    <kbd class="mx-1 flex h-5 w-5 items-center justify-center rounded border border-base-content/20 bg-base-100 font-semibold text-base-content sm:mx-2"><span class="text-lg">↓</span></kbd>
                    切换
                    <kbd class="mx-1 flex h-5 w-5 items-center justify-center rounded border border-base-content/20 bg-base-100 font-semibold text-base-content sm:mx-2">↵</kbd>
                    进入
                    <kbd class="mx-1 flex h-5 px-2 items-center justify-center rounded border border-base-content/20 bg-base-100 font-semibold text-base-content sm:mx-2">esc</kbd>
                    关闭
                </div>
            </div>
        </div>
    </div>

</body>
</html>
