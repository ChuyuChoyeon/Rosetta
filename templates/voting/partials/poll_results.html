{% load i18n %}
<div id="poll-container-{{ poll.id }}"
     class="card bg-base-100 shadow-lg border border-base-content/5 transition-all duration-300 hover:shadow-xl">
    <div class="card-body p-6">
        <div class="flex items-start justify-between mb-2">
            <h3 class="card-title text-xl font-bold">{{ poll.title }}</h3>
            {% if has_voted %}
                <div class="badge badge-success gap-1 text-white">
                    <span class="material-symbols-outlined text-[14px]">check</span>
                    {% trans "已投票" %}
                </div>
            {% endif %}
        </div>
        {% if poll.description %}<p class="text-base-content/60 mb-6 text-sm">{{ poll.description }}</p>{% endif %}
        {% if has_voted %}
            <!-- 结果展示 (Results Display) -->
            <div class="space-y-5 animate-in fade-in duration-500">
                {% for choice in poll.choices.all %}
                    <div class="group">
                        <div class="flex justify-between text-sm mb-2 font-medium">
                            <span class="flex items-center gap-2">
                                {{ choice.text }}
                                {% if choice.votes_count == poll.get_max_votes %}
                                    <span class="material-symbols-outlined text-warning text-[16px]"
                                          title="{% trans '领先' %}">trophy</span>
                                {% endif %}
                            </span>
                            <span class="opacity-70 group-hover:opacity-100 transition-opacity">{{ choice.votes_count }} {% trans "票" %}</span>
                        </div>
                        <div class="relative w-full bg-base-200 rounded-full h-3 overflow-hidden">
                            <div class="absolute top-0 left-0 h-full bg-primary rounded-full transition-all duration-1000 ease-out"
                                 style="width: {% widthratio choice.votes_count poll.total_votes 100 %}%"></div>
                        </div>
                        <div class="text-right text-xs text-base-content/40 mt-1 font-mono">
                            {% widthratio choice.votes_count poll.total_votes 100 %}%
                        </div>
                    </div>
                {% endfor %}
                <div class="divider my-4"></div>
                <div class="flex justify-between items-center text-sm text-base-content/50">
                    <span class="flex items-center gap-1">
                        <span class="material-symbols-outlined text-[16px]">how_to_vote</span>
                        {% trans "总票数:" %} {{ poll.total_votes }}
                    </span>
                    <span>{% trans "感谢您的参与！" %}</span>
                </div>
            </div>
        {% else %}
            <!-- 投票表单 (Voting Form) -->
            <form hx-post="{% url 'voting:vote' poll.id %}"
                  hx-target="#poll-container-{{ poll.id }}"
                  hx-swap="outerHTML">
                {% csrf_token %}
                <div class="space-y-3 mb-6">
                    {% for choice in poll.choices.all %}
                        <label class="relative flex items-center p-4 border border-base-200 rounded-xl hover:bg-base-200/50 hover:border-primary/50 cursor-pointer transition-all duration-200 group">
                            <input type="{% if poll.allow_multiple_choices %}checkbox{% else %}radio{% endif %}"
                                   name="choice"
                                   value="{{ choice.id }}"
                                   class="{% if poll.allow_multiple_choices %}checkbox checkbox-primary{% else %}radio radio-primary{% endif %} mr-3 peer"
                                   {% if not poll.allow_multiple_choices %}required{% endif %}>
                            <span class="label-text text-base font-medium group-hover:text-primary transition-colors">{{ choice.text }}</span>
                            <!-- Active Border Effect -->
                            <div class="absolute inset-0 border-2 border-primary rounded-xl opacity-0 peer-checked:opacity-100 transition-opacity pointer-events-none">
                            </div>
                            <!-- Active Background Effect -->
                            <div class="absolute inset-0 bg-primary/5 rounded-xl opacity-0 peer-checked:opacity-100 transition-opacity pointer-events-none">
                            </div>
                        </label>
                    {% endfor %}
                </div>
                {% if user.is_authenticated %}
                    <button type="submit"
                            class="btn btn-primary w-full shadow-lg shadow-primary/20 hover:shadow-primary/40 transition-all">
                        {% trans "投 票" %}
                        <span class="material-symbols-outlined text-sm">send</span>
                    </button>
                {% else %}
                    <a href="{% url 'users:login' %}?next={{ request.path }}"
                       class="btn btn-outline w-full gap-2 group">
                        <span class="material-symbols-outlined group-hover:animate-bounce">login</span>
                        {% trans "登录后参与投票" %}
                    </a>
                {% endif %}
            </form>
        {% endif %}
    </div>
</div>
