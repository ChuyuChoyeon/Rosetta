{% load i18n %}
{% if user == profile_user or user.is_staff %}
<dialog id="profile_edit_modal" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box w-11/12 max-w-5xl p-0 overflow-hidden bg-base-100">
    <!-- 弹窗标题栏 -->
    <div class="flex justify-between items-center p-6 border-b border-base-200 bg-base-100 sticky top-0 z-20">
      <h3 class="font-bold text-xl flex items-center gap-2">
        <span class="material-symbols-outlined text-primary">edit_square</span>
        {% trans "编辑个人资料" %}
        {% if user != profile_user %}<span class="badge badge-warning text-xs">{% trans "管理员模式" %}</span>{% endif %}
      </h3>
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost">✕</button>
      </form>
    </div>

    <!-- 表单区域 -->
    <form method="post" enctype="multipart/form-data" action="{% url 'users:user_public_profile' profile_user.username %}" class="p-6 space-y-6 overflow-y-auto max-h-[70vh] scrollbar-thin scrollbar-thumb-base-300" x-data="imagePreview()">
        {% csrf_token %}
        
        <!-- 个人形象设置 -->
        <div class="bg-base-200/50 rounded-xl p-4 border border-base-200">
            <h4 class="text-xs font-bold opacity-50 mb-4 uppercase tracking-wider flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">palette</span>
                {% trans "个人形象" %}
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- 头像上传 -->
                <div class="form-control w-full md:col-span-1">
                    <label class="label">
                        <span class="label-text font-medium">{% trans "头像" %}</span>
                    </label>
                    <div class="flex flex-col items-center gap-4 text-center">
                        <div class="avatar cursor-pointer group" @click="$refs.avatarInput.click()">
                            <div class="rounded-full w-32 h-32 ring ring-base-200 ring-offset-2 overflow-hidden relative shadow-lg">
                                <img :src="avatarPreview || '{{ profile_user.get_avatar_url }}'" alt="Avatar Preview" class="object-cover w-full h-full" />
                                <div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                    <span class="material-symbols-outlined text-white text-3xl">edit</span>
                                </div>
                            </div>
                        </div>
                        <div class="w-full">
                            <input type="file" name="avatar" class="hidden" accept="image/*" id="avatarInput" @change="handleFileSelect($event, 'avatar')">
                            <button type="button" class="btn btn-sm btn-outline w-full gap-2" @click="document.getElementById('avatarInput').click()">
                                <span class="material-symbols-outlined text-sm">upload</span>
                                {% trans "更换头像" %}
                            </button>
                            <label class="label justify-center">
                                <span class="label-text-alt text-base-content/50">{% trans "支持 JPG, PNG, GIF (推荐 1:1)" %}</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- 封面上传 -->
                <div class="form-control w-full md:col-span-2">
                    <label class="label">
                        <span class="label-text font-medium">{% trans "封面图" %}</span>
                    </label>
                    <div class="flex flex-col gap-4">
                         <div class="w-full h-40 rounded-xl overflow-hidden bg-base-300 relative group cursor-pointer shadow-sm border border-base-200" @click="document.getElementById('coverInput').click()">
                            <!-- 默认状态（渐变）或已有图片 -->
                            <div x-show="!coverPreview && {% if not profile_user.cover_image %}true{% else %}false{% endif %}" class="w-full h-full bg-gradient-to-r from-primary/20 to-secondary/20 flex items-center justify-center text-base-content/30">
                                <span class="text-sm font-medium">{% trans "暂无封面" %}</span>
                            </div>
                            
                            <!-- 图片展示（已有或预览） -->
                            <img x-show="coverPreview || {% if profile_user.cover_image %}true{% else %}false{% endif %}" :src="coverPreview || '{% if profile_user.cover_image %}{{ profile_user.cover_image.url }}{% endif %}'" class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity" />
                            
                            <!-- 悬停遮罩 -->
                            <div class="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <span class="btn btn-sm btn-white gap-2">
                                    <span class="material-symbols-outlined text-sm">edit</span>
                                    {% trans "更换封面" %}
                                </span>
                            </div>
                         </div>
                         <div class="flex items-center gap-4">
                             <input type="file" name="cover_image" class="hidden" accept="image/*" id="coverInput" @change="handleFileSelect($event, 'cover')">
                             <button type="button" class="btn btn-sm btn-outline gap-2" @click="document.getElementById('coverInput').click()">
                                <span class="material-symbols-outlined text-sm">upload</span>
                                {% trans "上传新封面" %}
                             </button>
                             <span class="text-xs text-base-content/50">{% trans "建议尺寸 1200x300px，支持拖拽上传" %}</span>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 基本信息设置 -->
        <div class="bg-base-200/50 rounded-xl p-4 border border-base-200">
            <h4 class="text-xs font-bold opacity-50 mb-4 uppercase tracking-wider flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">badge</span>
                {% trans "基本信息" %}
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">{% trans "昵称" %}</span>
                    </label>
                    {{ form.nickname }}
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">{% trans "邮箱" %}</span>
                    </label>
                    {{ form.email }}
                </div>

                <div class="form-control md:col-span-2">
                    <label class="label">
                        <span class="label-text font-medium">{% trans "个人简介" %}</span>
                    </label>
                    {{ form.bio }}
                    <label class="label">
                        <span class="label-text-alt text-base-content/50 text-right w-full block">{% trans "简短的自我介绍" %}</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- 社交链接设置 -->
        <div class="bg-base-200/50 rounded-xl p-4 border border-base-200">
            <h4 class="text-xs font-bold opacity-50 mb-4 uppercase tracking-wider flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">share</span>
                {% trans "社交链接" %}
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">language</span> {% trans "个人网站" %}
                        </span>
                    </label>
                    {{ form.website }}
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium flex items-center gap-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                            GitHub
                        </span>
                    </label>
                    {{ form.github }}
                </div>
            </div>
        </div>

        <div class="modal-action border-t border-base-200 pt-4 mt-0">
            <button type="button" class="btn btn-ghost" onclick="profile_edit_modal.close()">{% trans "取消" %}</button>
            <button type="submit" class="btn btn-primary px-8 gap-2">
                <span class="material-symbols-outlined text-sm">save</span>
                {% trans "保存更改" %}
            </button>
        </div>

        <!-- 图片裁剪弹窗 -->
        <div x-show="cropping" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80" style="display: none;">
            <div class="bg-base-100 rounded-lg p-4 w-full max-w-2xl h-[80vh] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">{% trans "裁剪图片" %}</h3>
                    <button type="button" class="btn btn-sm btn-circle btn-ghost" @click="cancelCrop">✕</button>
                </div>
                <div class="flex-1 bg-black relative overflow-hidden rounded-lg">
                    <img x-ref="cropperImage" class="max-w-full max-h-full block" src="">
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" class="btn btn-ghost" @click="cancelCrop">{% trans "取消" %}</button>
                    <button type="button" class="btn btn-primary" @click="saveCrop">{% trans "确定" %}</button>
                </div>
            </div>
        </div>
    </form>
    
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('imagePreview', () => ({
                avatarPreview: null,
                coverPreview: null,
                cropping: false,
                cropType: null, // 'avatar' or 'cover'
                cropper: null,
                
                handleFileSelect(event, type) {
                    const file = event.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.startCrop(e.target.result, type);
                        };
                        reader.readAsDataURL(file);
                    }
                },

                startCrop(imageUrl, type) {
                    this.cropType = type;
                    this.cropping = true;
                    
                    // Wait for modal to show
                    this.$nextTick(() => {
                        const image = this.$refs.cropperImage;
                        image.src = imageUrl;
                        
                        if (this.cropper) {
                            this.cropper.destroy();
                        }
                        
                        this.cropper = new Cropper(image, {
                            aspectRatio: type === 'avatar' ? 1 : 4, // 1:1 for avatar, 4:1 for cover
                            viewMode: 1,
                            dragMode: 'move',
                            autoCropArea: 1,
                            restore: false,
                            guides: true,
                            center: true,
                            highlight: false,
                            cropBoxMovable: true,
                            cropBoxResizable: true,
                            toggleDragModeOnDblclick: false,
                        });
                    });
                },

                cancelCrop(shouldClearInput = true) {
                    this.cropping = false;
                    if (this.cropper) {
                        this.cropper.destroy();
                        this.cropper = null;
                    }
                    // Reset input only if explicitly requested (e.g. on actual cancel)
                    if (shouldClearInput) {
                        if (this.cropType === 'avatar') {
                            document.getElementById('avatarInput').value = '';
                        } else {
                            document.getElementById('coverInput').value = '';
                        }
                    }
                },

                saveCrop() {
                    if (!this.cropper) return;
                    
                    const canvas = this.cropper.getCroppedCanvas({
                        width: this.cropType === 'avatar' ? 400 : 1200,
                        height: this.cropType === 'avatar' ? 400 : 300,
                    });
                    
                    canvas.toBlob((blob) => {
                        // Create a new File object
                        const fileName = this.cropType === 'avatar' ? 'avatar_cropped.jpg' : 'cover_cropped.jpg';
                        const file = new File([blob], fileName, { type: 'image/jpeg' });
                        
                        // Update DataTransfer for input
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        
                        // Update preview and input value
                        if (this.cropType === 'avatar') {
                            this.avatarPreview = canvas.toDataURL();
                            document.getElementById('avatarInput').files = dataTransfer.files;
                        } else {
                            this.coverPreview = canvas.toDataURL();
                            document.getElementById('coverInput').files = dataTransfer.files;
                        }
                        
                        this.cancelCrop(false); // Close modal but KEEP data
                    }, 'image/jpeg', 0.9);
                }
            }));
        });
    </script>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>
{% endif %}