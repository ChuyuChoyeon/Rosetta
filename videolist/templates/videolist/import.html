{% extends 'base.html' %}

{% block title %}导入视频站点数据{% endblock %}

{% block body_class %}bg-gray-50 dark:bg-gray-900 min-h-screen p-6 transition-colors duration-300{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- 标题区域 -->
    <div class="text-center mb-12">
        <h1 class="text-4xl font-bold text-gray-800 dark:text-white mb-4">导入视频站点数据</h1>
        <p class="text-gray-600 dark:text-gray-300">请选择分类并输入 JSON 格式的站点数据</p>
    </div>

    <!-- 导入表单 -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 shadow-md">
        <form id="importForm" class="space-y-6">
            {% csrf_token %}
            
            <!-- 分类选择 -->
            <div class="mb-6">
                <label class="block text-gray-700 dark:text-white mb-2">选择分类</label>
                <div class="flex gap-4">
                    <label class="flex items-center">
                        <input type="radio" name="category" value="movie" checked
                               class="w-4 h-4 text-blue-600 bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:ring-blue-500">
                        <span class="ml-2 text-gray-700 dark:text-white">影视</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="category" value="anime"
                               class="w-4 h-4 text-blue-600 bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:ring-blue-500">
                        <span class="ml-2 text-gray-700 dark:text-white">动漫</span>
                    </label>
                </div>
            </div>
            
            <!-- 键映射配置 -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-gray-700 dark:text-white">字段映射配置</label>
                    <button type="button" id="toggleMapping" class="text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-white">
                        显示/隐藏
                    </button>
                </div>
                <div id="mappingConfig" class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg hidden">
                    <p class="text-gray-600 dark:text-gray-300 text-sm mb-4">设置JSON中的键名与数据库字段的映射关系</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-600 dark:text-gray-300 text-sm mb-1">站点名称字段</label>
                            <input type="text" name="nameKey" value="name" 
                                class="w-full bg-white dark:bg-gray-800 text-gray-700 dark:text-white rounded-lg p-2 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-gray-600 dark:text-gray-300 text-sm mb-1">URL字段</label>
                            <input type="text" name="urlKey" value="url" 
                                class="w-full bg-white dark:bg-gray-800 text-gray-700 dark:text-white rounded-lg p-2 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-gray-600 dark:text-gray-300 text-sm mb-1">描述字段</label>
                            <input type="text" name="descriptionKey" value="description" 
                                class="w-full bg-white dark:bg-gray-800 text-gray-700 dark:text-white rounded-lg p-2 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-gray-600 dark:text-gray-300 text-sm mb-1">更新日期字段</label>
                            <input type="text" name="updateDateKey" value="updateDate" 
                                class="w-full bg-white dark:bg-gray-800 text-gray-700 dark:text-white rounded-lg p-2 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-gray-600 dark:text-gray-300 text-sm mb-1">日期格式</label>
                            <input type="text" name="dateFormat" value="%Y/%m/%d" 
                                class="w-full bg-white dark:bg-gray-800 text-gray-700 dark:text-white rounded-lg p-2 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <p class="text-gray-500 dark:text-gray-400 text-xs mt-1">示例: %Y/%m/%d 对应 2024/3/21</p>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <label for="jsonData" class="block text-gray-700 dark:text-white mb-2">JSON 数据</label>
                <textarea 
                    id="jsonData" 
                    name="jsonData" 
                    rows="15" 
                    class="w-full bg-white dark:bg-gray-800 text-gray-700 dark:text-white rounded-lg p-4 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder='[
  {
    "name": "示例站点",
    "url": "https://example.com",
    "description": "示例描述",
    "updateDate": "2024/3/21"
  }
]'></textarea>
            </div>

            <div class="flex items-center justify-between">
                <button 
                    type="submit"
                    class="px-6 py-2 bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 text-white rounded-lg transition-all duration-300">
                    导入数据
                </button>
                <a 
                    href="/vl/"
                    class="px-6 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-white rounded-lg transition-all duration-300">
                    返回列表
                </a>
            </div>
        </form>

        <!-- 结果提示 -->
        <div id="result" class="mt-6 hidden">
            <div class="p-4 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-white">
                <p id="resultMessage"></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleMapping = document.getElementById('toggleMapping');
        const mappingConfig = document.getElementById('mappingConfig');
        const importForm = document.getElementById('importForm');
        const resultDiv = document.getElementById('result');
        const resultMessage = document.getElementById('resultMessage');
        
        // 切换映射配置显示/隐藏
        toggleMapping.addEventListener('click', function() {
            mappingConfig.classList.toggle('hidden');
        });
        
        // 处理表单提交
        importForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                // 获取表单数据
                const category = document.querySelector('input[name="category"]:checked').value;
                const jsonData = document.getElementById('jsonData').value;
                
                // 获取键映射
                const nameKey = document.querySelector('input[name="nameKey"]').value;
                const urlKey = document.querySelector('input[name="urlKey"]').value;
                const descriptionKey = document.querySelector('input[name="descriptionKey"]').value;
                const updateDateKey = document.querySelector('input[name="updateDateKey"]').value;
                const dateFormat = document.querySelector('input[name="dateFormat"]').value;
                
                // 解析JSON数据
                let parsedData;
                try {
                    parsedData = JSON.parse(jsonData);
                } catch (error) {
                    throw new Error('JSON格式错误: ' + error.message);
                }
                
                // 构建请求数据
                const requestData = {
                    data: parsedData,
                    category: category,
                    keyMapping: {
                        nameKey,
                        urlKey,
                        descriptionKey,
                        updateDateKey,
                        dateFormat
                    }
                };
                
                // 发送请求
                const response = await fetch('/vl/import/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(requestData)
                });
                
                const responseData = await response.json();
                
                // 显示结果
                resultDiv.classList.remove('hidden');
                if (responseData.status === 'success') {
                    resultMessage.innerHTML = `
                        <div class="flex items-center text-green-600 dark:text-green-400">
                            <i class="fas fa-check-circle mr-2"></i>
                            ${responseData.message}
                        </div>
                        ${responseData.errors.length > 0 ? '<div class="mt-2"><strong>错误:</strong><ul class="list-disc pl-5 mt-1 text-red-600 dark:text-red-400">' + 
                            responseData.errors.map(err => `<li>${err}</li>`).join('') + 
                            '</ul></div>' : ''}
                    `;
                } else {
                    resultMessage.innerHTML = `
                        <div class="flex items-center text-red-600 dark:text-red-400">
                            <i class="fas fa-exclamation-circle mr-2"></i>
                            ${responseData.message}
                        </div>
                    `;
                }
                
            } catch (error) {
                resultDiv.classList.remove('hidden');
                resultMessage.innerHTML = `
                    <div class="flex items-center text-red-600 dark:text-red-400">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        ${error.message}
                    </div>
                `;
            }
        });
    });
</script>
{% endblock %}

{% block footer %}
<div class="mt-12 text-center py-4">
    <p class="text-gray-500 dark:text-gray-400 text-sm">© {% now "Y" %} Choyeon. All rights reserved.</p>
</div>
{% endblock %}