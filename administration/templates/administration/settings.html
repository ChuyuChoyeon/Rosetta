{% extends "administration/base.html" %}
{% load capture_tags %}

{% block title %}站点设置{{ config.SITE_ADMIN_SUFFIX|default:" - Rosetta Dashboard" }}{% endblock %}

{% block content %}
<div class="w-full" x-data="{ activeTab: 'general' }">
    <div class="mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold mb-2">站点设置</h1>
            <p class="text-base-content/60">管理网站的全局配置参数</p>
        </div>
        <div class="text-sm breadcrumbs">
            <ul>
                <li><a href="{% url 'administration:index' %}">首页</a></li>
                <li>站点设置</li>
            </ul>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="overflow-x-auto -mx-4 px-4 pb-2 sm:mx-0 sm:px-0 sm:pb-0 scrollbar-hide">
        <div role="tablist" class="tabs tabs-lifted tabs-lg w-max min-w-full sm:w-auto">
            {% for group in fieldsets %}
            <a role="tab" 
               class="tab h-12 whitespace-nowrap" 
               :class="{ 'tab-active [--tab-bg:theme(colors.base-100)] font-bold text-primary': activeTab === '{{ group.slug }}' }"
               @click="activeTab = '{{ group.slug }}'">
                <span class="material-symbols-outlined text-lg mr-2" :class="{ 'text-primary': activeTab === '{{ group.slug }}' }">{{ group.icon }}</span> 
                {{ group.title }}
            </a>
            {% endfor %}
            <!-- Filler tab to extend the border -->
            <a role="tab" class="tab flex-1 cursor-default hidden sm:block"></a>
        </div>
    </div>

    <!-- Settings Content -->
    <div class="bg-base-100 border-base-content/5 rounded-b-box rounded-tr-box border p-0 -mt-px min-h-[600px] relative z-10">
        <form method="post" class="p-4 md:p-8 max-w-5xl mx-auto">
            {% csrf_token %}
            
            {% for group in fieldsets %}
            <div x-show="activeTab === '{{ group.slug }}'" 
                 x-transition:enter="transition ease-out duration-300" 
                 x-transition:enter-start="opacity-0 translate-y-4" 
                 x-transition:enter-end="opacity-100 translate-y-0"
                 class="space-y-8 py-4">
                
                <div class="mb-8 pb-4 border-b border-base-200">
                    <h2 class="text-xl md:text-2xl font-bold flex items-center gap-3">
                        <div class="p-2 bg-primary/10 rounded-lg text-primary">
                            <span class="material-symbols-outlined text-2xl">{{ group.icon }}</span>
                        </div>
                        {{ group.title }}
                    </h2>
                    <p class="text-base-content/60 mt-2 text-sm ml-1">配置 {{ group.title }} 相关的系统参数</p>
                </div>

                <div class="grid grid-cols-1 gap-6">
                    {% for item in group.items %}
                    <div class="form-control w-full group p-4 rounded-xl hover:bg-base-200/30 transition-colors border border-transparent hover:border-base-200">
                        <div class="flex flex-col gap-2">
                            <label class="label p-0 justify-start gap-2 mb-1">
                                <span class="label-text font-bold text-lg">{{ item.help_text|default:item.key }}</span>
                                {% if item.type == 'bool' %}
                                    <span class="badge badge-sm badge-ghost font-mono text-xs opacity-50">Boolean</span>
                                {% endif %}
                            </label>
                            
                            <div class="mt-1">
                                {% if item.type == 'bool' %}
                                    <label class="cursor-pointer label justify-start gap-4 p-0">
                                        <input type="checkbox" name="{{ item.key }}" class="toggle toggle-primary toggle-lg" {% if item.value %}checked{% endif %}>
                                        <span class="label-text text-base-content/60" x-text="{{ item.key }} ? '已启用' : '已禁用'"></span>
                                    </label>
                                {% elif item.type == 'int' %}
                                    <input type="number" name="{{ item.key }}" value="{{ item.value }}" class="input input-bordered w-full max-w-md focus:input-primary transition-all">
                                {% else %}
                                    {% if 'WORDS' in item.key %}
                                        <!-- Flip Words Editor -->
                                        <div x-data="{ 
                                            words: {{ item.value|default:'[]' }},
                                            newWord: ''
                                        }">
                                            <input type="hidden" name="{{ item.key }}" :value="JSON.stringify(words).replace(/&quot;/g, '\'').replace(/\"/g, '\'')">
                                            
                                            <div class="flex flex-wrap gap-2 mb-2">
                                                <template x-for="(word, index) in words" :key="index">
                                                    <div class="badge badge-lg badge-primary gap-2 p-3">
                                                        <span x-text="word"></span>
                                                        <button type="button" @click="words.splice(index, 1)" class="btn btn-ghost btn-xs btn-circle text-primary-content/70 hover:text-white min-h-0 h-5 w-5">
                                                            <span class="material-symbols-outlined text-sm">close</span>
                                                        </button>
                                                    </div>
                                                </template>
                                            </div>
                                            
                                            <div class="join w-full max-w-md">
                                                <input type="text" x-model="newWord" @keydown.enter.prevent="if(newWord.trim()) { words.push(newWord.trim()); newWord = ''; }" class="input input-bordered join-item w-full focus:input-primary" placeholder="输入欢迎词后按回车添加...">
                                                <button type="button" @click="if(newWord.trim()) { words.push(newWord.trim()); newWord = ''; }" class="btn btn-primary join-item">
                                                    <span class="material-symbols-outlined">add</span>
                                                </button>
                                            </div>
                                        </div>
                                    {% elif 'color' in item.key|lower or 'colour' in item.key|lower %}
                                        <!-- Color Picker -->
                                        <div class="flex items-center gap-3">
                                            <input type="color" name="{{ item.key }}" value="{{ item.value }}" class="h-10 w-20 p-1 bg-base-100 border border-base-300 rounded cursor-pointer">
                                            <input type="text" name="{{ item.key }}" value="{{ item.value }}" class="input input-bordered w-full max-w-xs focus:input-primary font-mono">
                                        </div>
                                    {% elif 'image' in item.key|lower or 'avatar' in item.key|lower or 'logo' in item.key|lower %}
                                        <!-- Image URL input with preview -->
                                        <div x-data="{ imgUrl: '{{ item.value|escapejs }}' }" class="flex flex-col gap-3">
                                            <input type="text" name="{{ item.key }}" x-model="imgUrl" class="input input-bordered w-full focus:input-primary transition-all font-mono text-sm">
                                            <div class="w-full h-32 bg-base-200/50 rounded-lg border border-dashed border-base-content/20 flex items-center justify-center overflow-hidden relative group">
                                                <template x-if="imgUrl">
                                                    <img :src="imgUrl" class="max-h-full max-w-full object-contain" @error="$el.style.display='none'">
                                                </template>
                                                <div class="absolute inset-0 flex items-center justify-center text-base-content/30 pointer-events-none" x-show="!imgUrl">
                                                    <span>图片预览</span>
                                                </div>
                                            </div>
                                        </div>
                                    {% else %}
                                        <textarea name="{{ item.key }}" class="textarea textarea-bordered w-full h-24 focus:textarea-primary transition-all font-mono text-sm leading-relaxed">{{ item.value }}</textarea>
                                    {% endif %}
                                {% endif %}
                                
                                <label class="label">
                                    <span class="label-text-alt text-base-content/50 font-mono text-xs">{{ item.key }}</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}

            <div class="divider"></div>

            <div class="flex justify-end sticky bottom-6 z-20">
                <button type="submit" class="btn btn-primary btn-lg shadow-xl shadow-primary/20 gap-3">
                    <span class="material-symbols-outlined">save</span>
                    保存所有设置
                </button>
            </div>
        </form>
        <div class="divider"></div>
        <div class="p-4 md:p-8 max-w-5xl mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card bg-base-100 border border-base-content/5">
                    <div class="card-body gap-4">
                        <div class="flex items-center justify-between">
                            <h2 class="card-title">搜索索引</h2>
                            <span class="badge badge-outline">{{ watson_rebuild_status }}</span>
                        </div>
                        <div class="text-sm opacity-70">
                            最近更新：{{ watson_rebuild_updated_at|default:"暂无" }}
                        </div>
                        <form method="post" class="flex items-center gap-3">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="rebuild_watson">
                            <button type="submit" class="btn btn-secondary btn-sm">异步重建索引</button>
                        </form>
                    </div>
                </div>
                <div class="card bg-base-100 border border-base-content/5">
                    <div class="card-body gap-4">
                        <div class="flex items-center justify-between">
                            <h2 class="card-title">图片处理队列</h2>
                            <span class="badge badge-outline">{{ image_queue_status }}</span>
                        </div>
                        <div class="text-sm opacity-70">
                            最近更新：{{ image_queue_updated_at|default:"暂无" }}
                        </div>
                        <div class="text-sm opacity-70">
                            可处理封面图：{{ cover_image_count }}，已入队：{{ image_queue_queued }}
                        </div>
                        <form method="post" class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="queue_images">
                            <div class="join w-full sm:w-auto">
                                <input type="number" name="limit" class="input input-bordered join-item w-full sm:w-28" placeholder="数量" min="1" value="20">
                                <input type="number" name="delay" class="input input-bordered join-item w-full sm:w-32" placeholder="延迟秒数" min="0" value="{{ image_queue_delay }}">
                            </div>
                            <button type="submit" class="btn btn-accent btn-sm">加入延迟队列</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
