{% extends "administration/base.html" %}
{% load static capture_tags %}

{% block title %}{{ config.SITE_HEADER|default:"Rosetta Dashboard" }}{% endblock %}

{% block content %}
<div class="p-2 space-y-6">
    <!-- Hero Section -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
        <div>
            <h1 class="text-4xl font-bold mb-2 flex items-center gap-2">
                Hello, 
                {% with words=config.DASHBOARD_WELCOME_WORDS|default:"['Creator', 'Admin', 'Master', 'Manager']" %}
                    {% include "components/inspira/flip_words.html" with words=words extra_classes="text-primary" %}
                {% endwith %}
            </h1>
            <p class="text-base-content/60">{{ config.DASHBOARD_WELCOME_TEXT|default:"欢迎回到 Rosetta 控制台。这里是您的数字指挥中心。" }}</p>
        </div>
        <div class="flex gap-2">
            {% url 'administration:post_create' as create_url %}
            {% with text="写文章" icon="edit" href=create_url %}
                {% include "components/inspira/rainbow_button.html" %}
            {% endwith %}
        </div>
    </div>

    <!-- Stats Grid (Bento Box 1) -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Total Posts -->
        {% captureas card_content_1 %}
        <div class="p-6 h-full flex flex-col justify-between">
            <div class="flex justify-between items-start">
                <div class="p-2 bg-primary/10 rounded-lg text-primary">
                    <span class="material-symbols-outlined">article</span>
                </div>
                {% if post_growth >= 0 %}
                <div class="badge badge-success gap-1">
                    <span class="material-symbols-outlined text-xs">trending_up</span>
                    {{ post_growth }}%
                </div>
                {% else %}
                <div class="badge badge-error gap-1">
                    <span class="material-symbols-outlined text-xs">trending_down</span>
                    {{ post_growth }}%
                </div>
                {% endif %}
            </div>
            <div>
                <div class="text-3xl font-bold mt-4">{{ total_posts }}</div>
                <div class="text-sm opacity-60">总文章数</div>
            </div>
        </div>
        {% endcaptureas %}
        {% include "components/inspira/card_spotlight.html" with slot_content=card_content_1 extra_classes="h-full bg-base-100 border border-base-content/5 rounded-2xl" %}

        <!-- Total Comments -->
        {% captureas card_content_2 %}
        <div class="p-6 h-full flex flex-col justify-between">
            <div class="flex justify-between items-start">
                <div class="p-2 bg-secondary/10 rounded-lg text-secondary">
                    <span class="material-symbols-outlined">comment</span>
                </div>
                <div class="badge badge-warning gap-1">
                    <span class="material-symbols-outlined text-xs">pending</span>
                    {{ pending_comments }}
                </div>
            </div>
            <div>
                <div class="text-3xl font-bold mt-4">{{ total_comments }}</div>
                <div class="text-sm opacity-60">总评论数</div>
            </div>
        </div>
        {% endcaptureas %}
        {% include "components/inspira/card_spotlight.html" with slot_content=card_content_2 extra_classes="h-full bg-base-100 border border-base-content/5 rounded-2xl" %}
        
        <!-- System Health -->
        {% captureas card_content_3 %}
        <div class="p-6 h-full flex flex-col justify-between">
            <div class="flex justify-between items-start">
                <div class="p-2 bg-success/10 rounded-lg text-success">
                    <span class="material-symbols-outlined">health_and_safety</span>
                </div>
                <div class="radial-progress text-success text-xs" style="--value:{{ system_health }}; --size:1.5rem;">{{ system_health }}</div>
            </div>
            <div>
                <div class="text-3xl font-bold mt-4">{{ system_health }}%</div>
                <div class="text-sm opacity-60">系统健康度</div>
            </div>
        </div>
        {% endcaptureas %}
        {% include "components/inspira/card_spotlight.html" with slot_content=card_content_3 extra_classes="h-full bg-base-100 border border-base-content/5 rounded-2xl" %}

        <!-- Quick Actions (Mock) -->
        {% captureas card_content_4 %}
        <div class="p-6 h-full flex flex-col justify-between">
            <div class="flex justify-between items-start">
                <div class="p-2 bg-info/10 rounded-lg text-info">
                    <span class="material-symbols-outlined">bolt</span>
                </div>
            </div>
            <div>
                <div class="text-xl font-bold mt-4 mb-2">快捷操作</div>
                <div class="flex gap-2">
                    <a href="{% url 'administration:debug_cache' %}" class="btn btn-xs btn-outline">清除缓存</a>
                    <a href="{% url 'administration:settings' %}" class="btn btn-xs btn-outline">站点设置</a>
                </div>
            </div>
        </div>
        {% endcaptureas %}
        {% include "components/inspira/card_spotlight.html" with slot_content=card_content_4 extra_classes="h-full bg-base-100 border border-base-content/5 rounded-2xl" %}
    </div>

    <!-- Charts Grid (Bento Box 2) -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Main Trend Chart (Span 2) -->
        <div class="lg:col-span-2 relative group rounded-2xl bg-base-100 border border-base-content/5 overflow-hidden">
             {% include "components/inspira/border_beam.html" %}
             <div class="p-6">
                 <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                     <span class="material-symbols-outlined text-primary">ssid_chart</span>
                     流量趋势
                 </h3>
                 <div id="trendChart" class="w-full h-[300px]"></div>
             </div>
        </div>

        <!-- Distribution Charts (Span 1, Stacked) -->
        <div class="flex flex-col gap-4">
            <!-- Comment Status -->
            <div class="rounded-2xl bg-base-100 border border-base-content/5 p-6 flex-1 relative overflow-hidden">
                <h3 class="font-bold text-sm mb-2 opacity-70">评论分布</h3>
                <div class="flex items-center">
                    <div id="commentDonut" class="flex-1"></div>
                    <div class="flex flex-col gap-2 text-xs">
                        <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-success"></div> 已发布</div>
                        <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-warning"></div> 待审核</div>
                    </div>
                </div>
            </div>
            
            <!-- Top Posts List -->
            <div class="rounded-2xl bg-base-100 border border-base-content/5 p-6 flex-1 relative overflow-hidden">
                 <h3 class="font-bold text-sm mb-4 opacity-70">热门文章 TOP 5</h3>
                 <div class="flex flex-col gap-3">
                     {% for post in top_posts %}
                     <a href="{% url 'post_detail' post.slug %}" target="_blank" class="group block">
                         <div class="flex justify-between items-center text-sm mb-1">
                             <span class="truncate max-w-[150px] group-hover:text-primary transition-colors">{{ post.title }}</span>
                             <span class="badge badge-ghost badge-sm font-mono text-xs">
                                {{ post.views }} 阅读
                             </span>
                         </div>
                         <progress class="progress progress-primary w-full h-1 group-hover:opacity-80 transition-opacity" value="{{ post.views }}" max="{{ top_posts.0.views }}"></progress>
                     </a>
                     {% endfor %}
                 </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity Feed -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 rounded-2xl bg-base-100 border border-base-content/5 p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg">最近评论</h3>
                <a href="{% url 'administration:comment_list' %}" class="btn btn-xs btn-ghost">查看全部</a>
            </div>
            
            {% captureas list_content %}
                {% for comment in recent_comments %}
                <div class="flex items-start gap-3 p-3 hover:bg-base-200/50 rounded-lg transition-colors cursor-default group">
                    <div class="avatar">
                        <div class="w-10 h-10 rounded-full">
                            <img src="{{ comment.user.get_avatar_url }}" />
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <span class="font-bold text-sm">{{ comment.user.nickname|default:comment.user.username }}</span>
                            <span class="text-xs opacity-50">{{ comment.created_at|timesince }}前</span>
                        </div>
                        <a href="{% url 'post_detail' comment.post.slug %}#comment-{{ comment.id }}" target="_blank" class="text-sm opacity-70 truncate mt-0.5 block hover:text-primary transition-colors">
                            {{ comment.content }}
                        </a>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs opacity-40">on {{ comment.post.title }}</span>
                            {% if not comment.active %}
                            <span class="badge badge-xs badge-warning">待审</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center opacity-50 py-4">暂无活动</div>
                {% endfor %}
            {% endcaptureas %}
            
            {# Using Animated List if available, otherwise just render #}
            {% include "components/inspira/animated_list.html" with slot_content=list_content %}
        </div>
        
        <div class="rounded-2xl bg-base-100 border border-base-content/5 p-6 bg-gradient-to-br from-primary/5 to-secondary/5">
            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">info</span>
                系统信息
            </h3>
            <div class="space-y-4">
                <!-- System Info Items -->
                <div class="space-y-3">
                    <!-- CPU -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs opacity-70">CPU</span>
                            <span class="font-mono text-xs font-bold">{{ system_info.cpu_percent }}%</span>
                        </div>
                        <progress class="progress progress-primary w-full h-1.5" value="{{ system_info.cpu_percent }}" max="100"></progress>
                    </div>
                    
                    <!-- Memory -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs opacity-70">内存</span>
                            <span class="font-mono text-xs font-bold">{{ system_info.memory_percent }}%</span>
                        </div>
                        <progress class="progress progress-secondary w-full h-1.5" value="{{ system_info.memory_percent }}" max="100"></progress>
                    </div>

                    <!-- Disk -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs opacity-70">硬盘</span>
                            <span class="font-mono text-xs font-bold">{{ system_info.disk_percent }}%</span>
                        </div>
                        <progress class="progress progress-accent w-full h-1.5" value="{{ system_info.disk_percent }}" max="100"></progress>
                    </div>
                </div>

                <div class="divider my-2"></div>

                <!-- Environment Info -->
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between items-center">
                        <span class="opacity-70">Python</span>
                        <span class="font-mono">{{ system_info.python_version }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="opacity-70">System</span>
                        <span class="font-mono">{{ system_info.platform_system }} {{ system_info.platform_release }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="opacity-70">Django</span>
                        <span class="font-mono">5.0+</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="opacity-70">Server Time</span>
                        <span class="font-mono">{{ system_info.server_time|date:"Y-m-d H:i:s" }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    (function() {
        const initCharts = () => {
            // 1. Trend Chart (Area)
            const trendEl = document.querySelector("#trendChart");
            if (trendEl) {
                // Destroy existing chart if any
                if (trendEl._chart) {
                    try { trendEl._chart.destroy(); } catch(e) {}
                }

                var optionsTrend = {
                    series: [{
                        name: '评论数',
                        data: {{ trend_counts|safe }}
                    }],
                    chart: {
                        type: 'area',
                        height: 300,
                        toolbar: { show: false },
                        fontFamily: 'inherit',
                        background: 'transparent',
                        events: {
                            // Ensure chart is destroyed when element is removed
                            mounted: function(chartContext, config) {
                                config.globals.chartID = 'trendChart';
                            }
                        }
                    },
                    stroke: {
                        curve: 'smooth',
                        width: 3
                    },
                    fill: {
                        type: 'gradient',
                        gradient: {
                            shadeIntensity: 1,
                            opacityFrom: 0.7,
                            opacityTo: 0.2,
                            stops: [0, 90, 100]
                        }
                    },
                    dataLabels: { enabled: false },
                    xaxis: {
                        categories: {{ trend_dates|safe }},
                        labels: { show: false },
                        axisBorder: { show: false },
                        axisTicks: { show: false }
                    },
                    yaxis: { show: false },
                    grid: {
                        show: true,
                        borderColor: 'rgba(255, 255, 255, 0.05)',
                        strokeDashArray: 4,
                    },
                    theme: { mode: 'dark' },
                    colors: ['#3ABFF8']
                };
                
                // Check current theme to set mode
                if (document.documentElement.getAttribute('data-theme') === 'light' || !document.documentElement.getAttribute('data-theme')) {
                     optionsTrend.theme.mode = 'light';
                }

                var chartTrend = new ApexCharts(trendEl, optionsTrend);
                chartTrend.render();
                trendEl._chart = chartTrend;
            }

            // 2. Comment Status (Donut)
            const donutEl = document.querySelector("#commentDonut");
            if (donutEl) {
                if (donutEl._chart) {
                    try { donutEl._chart.destroy(); } catch(e) {}
                }

                var optionsDonut = {
                    series: {{ comment_status_data|safe }},
                    labels: ['已发布', '待审核'],
                    chart: {
                        type: 'donut',
                        height: 120,
                        fontFamily: 'inherit',
                        background: 'transparent'
                    },
                    plotOptions: {
                        pie: {
                            donut: {
                                size: '70%',
                                labels: { show: false }
                            }
                        }
                    },
                    dataLabels: { enabled: false },
                    legend: { show: false },
                    stroke: { show: false },
                    colors: ['#36D399', '#FBBD23']
                };
                
                var chartDonut = new ApexCharts(donutEl, optionsDonut);
                chartDonut.render();
                donutEl._chart = chartDonut;
            }
        };

        // Run on initial load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initCharts);
        } else {
            initCharts();
        }

        // Run on HTMX load (for navigation)
        document.addEventListener('htmx:afterSettle', initCharts);
        
        // Cleanup on HTMX swap to prevent "setting width of undefined" errors
        document.addEventListener('htmx:beforeSwap', function(evt) {
             const trendEl = document.querySelector("#trendChart");
             if (trendEl && trendEl._chart) {
                 try { trendEl._chart.destroy(); } catch(e) {}
                 delete trendEl._chart;
             }
             
             const donutEl = document.querySelector("#commentDonut");
             if (donutEl && donutEl._chart) {
                 try { donutEl._chart.destroy(); } catch(e) {}
                 delete donutEl._chart;
             }
        });
    })();
</script>
{% endblock %}