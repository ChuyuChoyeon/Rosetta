{% extends "administration/base.html" %}
{% load capture_tags static %}

{% block title %}{{ title|default:"编辑文章" }}{{ config.SITE_ADMIN_SUFFIX|default:" - Rosetta Dashboard" }}{% endblock %}

{% block extra_head %}
<!-- ByteMD 样式由 js/editor.js 动态注入和管理 -->
{% endblock %}

{% block content %}
    <!-- Header -->
    {% include "administration/components/header.html" with title=title|default:"编辑文章" subtitle="编辑文章内容和设置" breadcrumbs=None %}

    <form method="post" enctype="multipart/form-data" class="w-full">
        {% csrf_token %}
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 items-start">
            <!-- Main Content (Left Column - 75%) -->
            <div class="lg:col-span-3 space-y-6">
                
                <!-- Main Info Card -->
                {% captureas main_card_content %}
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text font-bold text-lg">文章标题</span>
                        </label>
                        {{ form.title }}
                        {% if form.title.errors %}
                        <label class="label">
                            <span class="label-text-alt text-error">{{ form.title.errors.0 }}</span>
                        </label>
                        {% endif %}
                    </div>
                    
                    <div class="form-control w-full mt-4">
                        <label class="label flex justify-between items-center">
                            <span class="label-text font-bold">内容 (Markdown)</span>
                        </label>
                        
                        <div id="editor" class="bg-base-100 rounded-lg border border-base-300"></div>

                        <div class="hidden">
                            {{ form.content }}
                        </div>

                        {% if form.content.errors %}
                        <label class="label">
                            <span class="label-text-alt text-error">{{ form.content.errors.0 }}</span>
                        </label>
                        {% endif %}
                    </div>

                    <div class="form-control w-full mt-4">
                        <label class="label">
                            <span class="label-text font-bold">摘要</span>
                        </label>
                        {{ form.excerpt }}
                        <label class="label">
                            <span class="label-text-alt opacity-60">可选，用于列表页展示</span>
                        </label>
                    </div>
                {% endcaptureas %}
                {% include "administration/components/form_card.html" with content=main_card_content %}
                
                <!-- SEO / Slug Settings -->
                {% captureas seo_card_content %}
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text">Slug (URL别名)</span>
                        </label>
                        {{ form.slug }}
                        <label class="label">
                            <span class="label-text-alt opacity-60">留空将自动根据标题生成</span>
                        </label>
                    </div>

                    <div class="divider"></div>

                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text">Meta 标题 (Title)</span>
                        </label>
                        {{ form.meta_title }}
                        <label class="label">
                            <span class="label-text-alt opacity-60">可选，覆盖默认标题</span>
                        </label>
                    </div>

                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text">Meta 描述 (Description)</span>
                        </label>
                        {{ form.meta_description }}
                        <label class="label">
                            <span class="label-text-alt opacity-60">可选，覆盖自动生成的摘要</span>
                        </label>
                    </div>

                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text">Meta 关键词 (Keywords)</span>
                        </label>
                        {{ form.meta_keywords }}
                        <label class="label">
                            <span class="label-text-alt opacity-60">可选，逗号分隔</span>
                        </label>
                    </div>
                {% endcaptureas %}
                {% include "administration/components/form_card.html" with title="SEO 设置" content=seo_card_content %}
            </div>

            <!-- Sidebar (Right Column - 25% - Sticky) -->
            <div class="lg:col-span-1 space-y-6 sticky top-24 z-30">
                <!-- Publish Actions -->
                {% captureas publish_content %}
                    <div class="space-y-4">
                        <div class="form-control w-full">
                            <label class="label cursor-pointer justify-between">
                                <span class="label-text">状态</span> 
                                {{ form.status }}
                            </label>
                        </div>

                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text">发布时间</span>
                            </label>
                            {{ form.published_at }}
                            {% if form.published_at.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.published_at.errors.0 }}</span>
                            </label>
                            {% else %}
                            <label class="label">
                                <span class="label-text-alt opacity-60">留空将使用当前时间</span>
                            </label>
                            {% endif %}
                        </div>

                        <div class="form-control w-full">
                            <label class="label cursor-pointer justify-between">
                                <span class="label-text">是否置顶</span>
                                {{ form.is_pinned }}
                            </label>
                        </div>

                        <div class="form-control w-full">
                            <label class="label cursor-pointer justify-between">
                                <span class="label-text">允许评论</span>
                                {{ form.allow_comments }}
                            </label>
                        </div>
                    </div>
                {% endcaptureas %}

                {% captureas publish_actions %}
                    {% if object.slug %}
                    <a href="{% url 'post_detail' object.slug %}" target="_blank" class="btn btn-outline btn-sm w-full gap-2">
                        <span class="material-symbols-outlined text-sm">open_in_new</span>
                        预览/查看
                    </a>
                    {% endif %}
                    {% with slot_content='<span class="material-symbols-outlined">save</span> 保存更改' extra_classes='w-full gap-2 font-bold' type='submit' %}
                        {% include 'components/inspira/shimmer_button.html' %}
                    {% endwith %}
                    <div class="flex gap-2">
                        <button type="submit" name="_continue" class="btn btn-ghost btn-xs flex-1">保存并继续</button>
                        <button type="submit" name="_addanother" class="btn btn-ghost btn-xs flex-1">保存并新增</button>
                    </div>
                {% endcaptureas %}

                {% include "administration/components/form_card.html" with title="发布" icon="publish" content=publish_content actions=publish_actions %}

                <!-- Categories & Tags -->
                {% captureas taxonomy_content %}
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text">分类</span>
                        </label>
                        {{ form.category }}
                    </div>

                    <div class="form-control w-full mt-4" 
                         x-data="{ 
                            tags: [], 
                            newTag: '',
                            init() {
                                const initialValue = document.getElementById('id_tags_str').value;
                                if (initialValue) {
                                    this.tags = initialValue.split(',').filter(t => t.trim() !== '').map(t => t.trim());
                                }
                            },
                            addTag() {
                                const tag = this.newTag.trim();
                                if (tag && !this.tags.includes(tag)) {
                                    this.tags.push(tag);
                                }
                                this.newTag = '';
                                this.updateHiddenInput();
                            },
                            removeTag(index) {
                                this.tags.splice(index, 1);
                                this.updateHiddenInput();
                            },
                            updateHiddenInput() {
                                document.getElementById('id_tags_str').value = this.tags.join(',');
                            }
                         }">
                        <label class="label">
                            <span class="label-text">标签</span>
                        </label>
                        
                        <!-- Hidden Input for Form Submission -->
                        {{ form.tags_str }}
                        
                        <!-- Visual Tag Input -->
                        <div class="flex flex-wrap gap-2 mb-2">
                            <template x-for="(tag, index) in tags" :key="index">
                                <div class="badge badge-primary gap-1 p-3">
                                    <span x-text="tag"></span>
                                    <button type="button" @click="removeTag(index)" class="btn btn-ghost btn-xs btn-circle text-primary-content/70 hover:text-white min-h-0 h-4 w-4">
                                        <span class="material-symbols-outlined text-[10px] font-bold">close</span>
                                    </button>
                                </div>
                            </template>
                        </div>
                        
                        <div class="join w-full">
                            <input type="text" 
                                   x-model="newTag" 
                                   @keydown.enter.prevent="addTag()" 
                                   @keydown.comma.prevent="addTag()"
                                   @blur="addTag()"
                                   class="input input-bordered join-item w-full" 
                                   placeholder="输入标签..." />
                            <button type="button" @click="addTag()" class="btn btn-square join-item">
                                <span class="material-symbols-outlined">add</span>
                            </button>
                        </div>

                        <label class="label">
                            <span class="label-text-alt opacity-60">输入标签后按回车或逗号添加</span>
                        </label>
                    </div>
                {% endcaptureas %}
                {% include "administration/components/form_card.html" with title="分类与标签" icon="category" icon_class="text-secondary" content=taxonomy_content %}
                
                <!-- Cover Image -->
                {% captureas cover_content %}
                    <div class="form-control w-full">
                        {{ form.cover_image }}
                    </div>
                {% endcaptureas %}
                {% include "administration/components/form_card.html" with title="封面图片" icon="image" icon_class="text-accent" content=cover_content %}
            </div>
        </div>
    </form>
{% endblock %}
