{% extends "administration/base.html" %}
{% load capture_tags widget_tweaks %}

{% block title %}{{ title }}{{ config.SITE_ADMIN_SUFFIX|default:" - Rosetta Dashboard" }}{% endblock %}

{% block content %}
<!-- Header -->
{% captureas header_actions %}
{% endcaptureas %}

{% include "administration/components/header.html" with title=title|default:"编辑分类" icon="category" breadcrumbs=breadcrumbs actions=header_actions %}

<form method="post" enctype="multipart/form-data" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    {% csrf_token %}
    
    <!-- Left Column: Main Content -->
    <div class="lg:col-span-2 space-y-6">
        {% captureas main_content %}
            {% if form.non_field_errors %}
            <div class="alert alert-error mb-4 shadow-sm">
                <span class="material-symbols-outlined">error</span>
                <div class="flex flex-col">
                    <span class="font-bold">表单错误</span>
                    {% for error in form.non_field_errors %}
                    <span class="text-sm">{{ error }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Name Field -->
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text font-bold text-base">名称 <span class="text-error">*</span></span>
                </label>
                {% render_field form.name class="input input-bordered w-full focus:input-primary transition-all" placeholder="输入分类名称" %}
                {% if form.name.errors %}
                <label class="label">
                    <span class="label-text-alt text-error">{{ form.name.errors.0 }}</span>
                </label>
                {% endif %}
                <label class="label">
                    <span class="label-text-alt text-base-content/60">这将是它在站点上显示的名字。</span>
                </label>
            </div>

            <!-- Slug Field -->
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text font-bold text-base">别名 (Slug)</span>
                </label>
                {% render_field form.slug class="input input-bordered w-full focus:input-primary transition-all font-mono" placeholder="输入URL别名" %}
                {% if form.slug.errors %}
                <label class="label">
                    <span class="label-text-alt text-error">{{ form.slug.errors.0 }}</span>
                </label>
                {% endif %}
                <label class="label">
                    <span class="label-text-alt text-base-content/60">“别名”是在URL中使用的别称，通常使用小写，只能包含字母，数字和连字符（-）。</span>
                </label>
            </div>

            <!-- Description Field -->
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text font-bold text-base">描述</span>
                </label>
                {% render_field form.description class="textarea textarea-bordered h-32 focus:textarea-primary transition-all" placeholder="输入分类描述..." %}
                {% if form.description.errors %}
                <label class="label">
                    <span class="label-text-alt text-error">{{ form.description.errors.0 }}</span>
                </label>
                {% endif %}
                <label class="label">
                    <span class="label-text-alt text-base-content/60">描述默认只在后台显示，部分主题可能会显示。</span>
                </label>
            </div>
        {% endcaptureas %}
        {% include "administration/components/form_card.html" with title="基本信息" icon="edit_note" content=main_content %}

        {% captureas appearance_content %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Icon Field -->
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text font-bold text-base">图标 (Material Symbols)</span>
                    </label>
                    <div class="join w-full">
                        <div class="join-item bg-base-200 border border-base-300 flex items-center justify-center px-3" id="icon-preview-container">
                            <span class="material-symbols-outlined text-2xl" id="icon-preview">
                                {{ form.icon.value|default:"category" }}
                            </span>
                        </div>
                        {% render_field form.icon class="input input-bordered join-item w-full focus:input-primary transition-all font-mono" placeholder="图标代码 (如: home)" oninput="updateIconPreview(this.value)" %}
                        <button type="button" onclick="icon_modal.showModal()" class="btn btn-neutral join-item">
                            <span class="material-symbols-outlined text-lg">grid_view</span>
                            选择
                        </button>
                    </div>
                    {% if form.icon.errors %}
                    <label class="label">
                        <span class="label-text-alt text-error">{{ form.icon.errors.0 }}</span>
                    </label>
                    {% endif %}
                    <label class="label">
                        <span class="label-text-alt text-base-content/60">
                            使用 Google Material Symbols 代码。
                        </span>
                    </label>
                </div>

                <!-- Color Field -->
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text font-bold text-base">颜色设置</span>
                    </label>
                    {% include 'components/color_picker.html' with value=form.color.value name=form.color.name %}
                    {% if form.color.errors %}
                    <label class="label">
                        <span class="label-text-alt text-error">{{ form.color.errors.0 }}</span>
                    </label>
                    {% endif %}
                    <label class="label">
                        <span class="label-text-alt text-base-content/60">选择分类的主题颜色。</span>
                    </label>
                </div>
            </div>
        {% endcaptureas %}
        {% include "administration/components/form_card.html" with title="外观设置" icon="palette" content=appearance_content %}
    </div>

    <!-- Right Column: Sidebar -->
    <div class="lg:col-span-1 space-y-6">
        <!-- Publish Box -->
        {% captureas publish_content %}
            <div class="flex flex-col gap-3">
                <button type="submit" class="btn btn-primary w-full gap-2 shadow-lg shadow-primary/20">
                    <span class="material-symbols-outlined">save</span>
                    保存更改
                </button>
                
                <div class="grid grid-cols-2 gap-2">
                    <button type="submit" name="_addanother" class="btn btn-sm btn-ghost border-base-300">保存并新增</button>
                    <button type="submit" name="_continue" class="btn btn-sm btn-ghost border-base-300">保存并继续</button>
                </div>

                {% if object %}
                <div class="divider my-1"></div>
                <div class="flex justify-between items-center">
                    <a href="javascript:history.back()" class="btn btn-sm btn-ghost text-base-content/60">取消</a>
                    <button type="button" onclick="confirmDelete('{% url 'administration:category_delete' object.pk %}', '确定要删除分类《{{ object.name|escapejs }}》吗？')" class="btn btn-sm btn-ghost text-error hover:bg-error/10">
                        删除分类
                    </button>
                </div>
                {% else %}
                <div class="divider my-1"></div>
                <a href="javascript:history.back()" class="btn btn-sm btn-ghost text-base-content/60 w-full">取消</a>
                {% endif %}
            </div>
        {% endcaptureas %}
        {% include "administration/components/form_card.html" with title="发布" icon="publish" content=publish_content %}
    </div>
</form>

<!-- Icon Selector Modal -->
<dialog id="icon_modal" class="modal">
    <div class="modal-box w-11/12 max-w-5xl h-[80vh] flex flex-col p-0 bg-base-100 rounded-2xl">
        <!-- Header -->
        <div class="p-4 border-b border-base-200 flex justify-between items-center sticky top-0 bg-base-100/95 backdrop-blur z-10">
            <h3 class="font-bold text-lg flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">grid_view</span>
                选择图标
            </h3>
            <div class="flex items-center gap-2">
                <div class="join">
                    <input type="text" id="icon-search" class="input input-bordered input-sm join-item w-48 md:w-64 focus:input-primary" placeholder="搜索图标 (如: user, edit)..." oninput="filterIcons(this.value)">
                    <button class="btn btn-sm btn-ghost join-item border-base-300">
                        <span class="material-symbols-outlined text-sm">search</span>
                    </button>
                </div>
                <form method="dialog">
                    <button class="btn btn-sm btn-circle btn-ghost">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-6 scrollbar-thin scrollbar-thumb-base-300 scrollbar-track-base-100">
            <div id="icon-grid" class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-4">
                <!-- Icons will be rendered here -->
                <div class="flex flex-col items-center justify-center gap-2 p-8 text-base-content/50 col-span-full">
                    <span class="loading loading-spinner loading-lg"></span>
                    <span>加载图标库...</span>
                </div>
            </div>
            
            <div id="no-icons-found" class="hidden flex flex-col items-center justify-center py-20 text-base-content/50">
                <span class="material-symbols-outlined text-6xl mb-4 opacity-20">search_off</span>
                <p>未找到匹配的图标</p>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="p-4 border-t border-base-200 bg-base-50 flex justify-between items-center text-xs text-base-content/60">
            <span>图标库: Material Symbols </span>
            <span>共 <span id="total-icons-count">0</span> 个图标</span>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<script>
    // Material Symbols List (Subset of commonly used icons)
    const materialSymbols = [
        "search", "home", "menu", "close", "settings", "check", "favorite", "add", "delete", "arrow_back", "arrow_forward", "arrow_drop_down", "cancel", "more_vert", "chevron_right", "check_circle", "logout", "arrow_drop_up", "login", "group", "edit", "refresh", "file_download", "image", "add_circle", "grid_view", "download", "person", "sort", "arrow_back_ios", "expand_more", "bolt", "list", "filter_list", "arrow_forward_ios", "calendar_today", "info", "notifications", "more_horiz", "add_box", "arrow_left", "arrow_right", "description", "upload", "remove", "language", "account_circle", "visibility", "done", "open_in_new", "verified", "schedule", "warning", "thumb_up", "lock", "error", "fingerprint", "event", "light_mode", "dark_mode", "dashboard", "category", "article", "sell", "tag", "link", "public", "bookmark", "history", "code", "bug_report", "build", "cached", "help", "feedback", "manage_accounts", "admin_panel_settings", "supervisor_account", "perm_identity", "people", "email", "phone", "contact_page", "map", "place", "store", "shopping_cart", "payments", "credit_card", "receipt", "attach_money", "trending_up", "analytics", "bar_chart", "pie_chart", "folder", "folder_open", "cloud", "cloud_upload", "cloud_download", "upload_file", "download_for_offline", "image", "photo_camera", "videocam", "music_note", "movie", "slideshow", "palette", "brush", "format_bold", "format_italic", "title", "text_fields", "insert_link", "attach_file", "insert_photo", "computer", "phone_iphone", "tablet", "desktop_windows", "keyboard", "mouse", "router", "wifi", "security", "vpn_key", "shield", "lock_open", "visibility_off", "delete_forever", "restore_from_trash", "archive", "unarchive", "content_copy", "content_paste", "save", "save_alt", "print", "share", "send", "reply", "reply_all", "flag", "report", "block", "star", "star_border", "star_half", "favorite_border", "thumb_down", "emoji_emotions", "sentiment_satisfied", "sentiment_dissatisfied", "mood", "mood_bad", "face", "rocket"
    ];

    // Remove duplicates and sort
    const uniqueIcons = [...new Set(materialSymbols)].sort();
    
    // DOM Elements
    const iconGrid = document.getElementById('icon-grid');
    const noIconsFound = document.getElementById('no-icons-found');
    const totalIconsCount = document.getElementById('total-icons-count');
    const iconInput = document.getElementById('{{ form.icon.auto_id }}');
    const iconPreview = document.getElementById('icon-preview');

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        renderIcons();
        totalIconsCount.textContent = uniqueIcons.length;
        
        // Initial preview update
        if (iconInput.value) {
            updateIconPreview(iconInput.value);
        }
    });

    // Render Icons
    function renderIcons(filter = "") {
        iconGrid.innerHTML = "";
        let matchCount = 0;
        const lowerFilter = filter.toLowerCase();

        uniqueIcons.forEach(icon => {
            if (icon.toLowerCase().includes(lowerFilter)) {
                matchCount++;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-ghost h-auto py-4 flex flex-col gap-2 hover:bg-base-200 hover:border-primary/20 border border-transparent transition-all rounded-xl group';
                btn.onclick = () => selectIcon(icon);
                
                btn.innerHTML = `
                    <span class="material-symbols-outlined text-3xl text-base-content/70 group-hover:text-primary group-hover:scale-110 transition-all">${icon}</span>
                    <span class="text-[10px] text-base-content/40 font-mono truncate w-full px-1 group-hover:text-base-content/70">${icon}</span>
                `;
                
                iconGrid.appendChild(btn);
            }
        });

        if (matchCount === 0) {
            iconGrid.classList.add('hidden');
            noIconsFound.classList.remove('hidden');
        } else {
            iconGrid.classList.remove('hidden');
            noIconsFound.classList.add('hidden');
        }
    }

    // Filter Icons
    function filterIcons(value) {
        renderIcons(value);
    }

    // Select Icon
    function selectIcon(icon) {
        iconInput.value = icon;
        updateIconPreview(icon);
        icon_modal.close();
        
        // Optional: Flash the input to indicate change
        iconInput.classList.add('input-primary');
        setTimeout(() => iconInput.classList.remove('input-primary'), 300);
    }

    // Update Preview
    function updateIconPreview(value) {
        if (!value) {
            iconPreview.textContent = 'category'; // Default
            iconPreview.classList.add('opacity-50');
        } else {
            iconPreview.textContent = value;
            iconPreview.classList.remove('opacity-50');
        }
    }
</script>
{% endblock %}
